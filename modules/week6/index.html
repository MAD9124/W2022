<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Week 6: Object Data Modelling | MAD9124</title>
    <meta name="generator" content="VuePress 1.7.1">
    
    <meta name="description" content="Full Stack: API Development">
    
    <link rel="preload" href="/W2022/assets/css/0.styles.7a32498c.css" as="style"><link rel="preload" href="/W2022/assets/js/app.cec51691.js" as="script"><link rel="preload" href="/W2022/assets/js/3.9c2ff4f7.js" as="script"><link rel="preload" href="/W2022/assets/js/8.0225588a.js" as="script"><link rel="preload" href="/W2022/assets/js/11.f11acbbb.js" as="script"><link rel="preload" href="/W2022/assets/js/16.1ec56656.js" as="script"><link rel="prefetch" href="/W2022/assets/js/10.31dfe672.js"><link rel="prefetch" href="/W2022/assets/js/12.96649c49.js"><link rel="prefetch" href="/W2022/assets/js/13.535bc82d.js"><link rel="prefetch" href="/W2022/assets/js/14.028cb9d2.js"><link rel="prefetch" href="/W2022/assets/js/15.ced8bd8c.js"><link rel="prefetch" href="/W2022/assets/js/17.a48a571a.js"><link rel="prefetch" href="/W2022/assets/js/18.1528acad.js"><link rel="prefetch" href="/W2022/assets/js/19.61d8cc80.js"><link rel="prefetch" href="/W2022/assets/js/2.b4d63df3.js"><link rel="prefetch" href="/W2022/assets/js/20.4071399f.js"><link rel="prefetch" href="/W2022/assets/js/21.e5b3b049.js"><link rel="prefetch" href="/W2022/assets/js/22.8b4aae43.js"><link rel="prefetch" href="/W2022/assets/js/23.61c52980.js"><link rel="prefetch" href="/W2022/assets/js/24.55bc8f66.js"><link rel="prefetch" href="/W2022/assets/js/25.4ac50e54.js"><link rel="prefetch" href="/W2022/assets/js/26.9ce0e977.js"><link rel="prefetch" href="/W2022/assets/js/27.3a9bd92a.js"><link rel="prefetch" href="/W2022/assets/js/28.06fd6a07.js"><link rel="prefetch" href="/W2022/assets/js/29.1bb95a0c.js"><link rel="prefetch" href="/W2022/assets/js/30.dae4692c.js"><link rel="prefetch" href="/W2022/assets/js/31.8fbfd6d3.js"><link rel="prefetch" href="/W2022/assets/js/32.68c3574f.js"><link rel="prefetch" href="/W2022/assets/js/33.617cdd3b.js"><link rel="prefetch" href="/W2022/assets/js/34.e9d21a2b.js"><link rel="prefetch" href="/W2022/assets/js/35.6e9bfe39.js"><link rel="prefetch" href="/W2022/assets/js/36.d4810b3d.js"><link rel="prefetch" href="/W2022/assets/js/37.8f7eb267.js"><link rel="prefetch" href="/W2022/assets/js/38.23784716.js"><link rel="prefetch" href="/W2022/assets/js/39.2e9e7983.js"><link rel="prefetch" href="/W2022/assets/js/4.a3d079e3.js"><link rel="prefetch" href="/W2022/assets/js/40.7f13d575.js"><link rel="prefetch" href="/W2022/assets/js/5.3200619b.js"><link rel="prefetch" href="/W2022/assets/js/6.4a9ec533.js"><link rel="prefetch" href="/W2022/assets/js/7.f496cd23.js"><link rel="prefetch" href="/W2022/assets/js/9.665b29a5.js">
    <link rel="stylesheet" href="/W2022/assets/css/0.styles.7a32498c.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/W2022/" class="home-link router-link-active"><!----> <span class="site-name">MAD9124</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/W2022/overview/" class="nav-link">
  Overview
</a></div><div class="nav-item"><a href="/W2022/modules/" class="nav-link router-link-active">
  Modules
</a></div><div class="nav-item"><a href="/W2022/deliverables/" class="nav-link">
  Deliverables
</a></div><div class="nav-item"><a href="/W2022/resources/" class="nav-link">
  Resources
</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/W2022/overview/" class="nav-link">
  Overview
</a></div><div class="nav-item"><a href="/W2022/modules/" class="nav-link router-link-active">
  Modules
</a></div><div class="nav-item"><a href="/W2022/deliverables/" class="nav-link">
  Deliverables
</a></div><div class="nav-item"><a href="/W2022/resources/" class="nav-link">
  Resources
</a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Introduction</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Deliverables</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>Content Modules</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/W2022/modules/" aria-current="page" class="sidebar-link">Table of contents</a></li><li><a href="/W2022/modules/week1/" class="sidebar-link">Week 1: Introduction &amp; Review</a></li><li><a href="/W2022/modules/week2/" class="sidebar-link">Week 2: Node Modules &amp; Express</a></li><li><a href="/W2022/modules/week3/" class="sidebar-link">Week 3: RESTful APIs</a></li><li><a href="/W2022/modules/week4/" class="sidebar-link">Week 4: Middleware functions</a></li><li><a href="/W2022/modules/week5/" class="sidebar-link">Week 5: Data persistence</a></li><li><a href="/W2022/modules/week6/" aria-current="page" class="active sidebar-link">Week 6: Object Data Modelling</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/W2022/modules/week6/#agenda" class="sidebar-link">Agenda</a></li><li class="sidebar-sub-header"><a href="/W2022/modules/week6/#mongoose-models" class="sidebar-link">Mongoose Models</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/W2022/modules/week6/#schema" class="sidebar-link">Schema</a></li><li class="sidebar-sub-header"><a href="/W2022/modules/week6/#schema-types" class="sidebar-link">Schema Types</a></li><li class="sidebar-sub-header"><a href="/W2022/modules/week6/#making-models" class="sidebar-link">Making Models</a></li><li class="sidebar-sub-header"><a href="/W2022/modules/week6/#relationships" class="sidebar-link">Relationships</a></li></ul></li><li class="sidebar-sub-header"><a href="/W2022/modules/week6/#mongoose-query-methods" class="sidebar-link">Mongoose Query Methods</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/W2022/modules/week6/#mongo-query-operators" class="sidebar-link">Mongo Query Operators</a></li><li class="sidebar-sub-header"><a href="/W2022/modules/week6/#mongoose-query-helpers" class="sidebar-link">Mongoose Query Helpers</a></li></ul></li><li class="sidebar-sub-header"><a href="/W2022/modules/week6/#ex6-1-mongo-cars" class="sidebar-link">EX6-1 Mongo Cars</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/W2022/modules/week6/#connect-to-mongodb" class="sidebar-link">Connect to MongoDB</a></li><li class="sidebar-sub-header"><a href="/W2022/modules/week6/#nodemon" class="sidebar-link">nodemon</a></li><li class="sidebar-sub-header"><a href="/W2022/modules/week6/#car-model" class="sidebar-link">Car Model</a></li><li class="sidebar-sub-header"><a href="/W2022/modules/week6/#crud-with-mongoose" class="sidebar-link">CRUD with Mongoose</a></li><li class="sidebar-sub-header"><a href="/W2022/modules/week6/#get-api-cars" class="sidebar-link">GET /api/cars</a></li><li class="sidebar-sub-header"><a href="/W2022/modules/week6/#post-api-cars" class="sidebar-link">POST /api/cars</a></li><li class="sidebar-sub-header"><a href="/W2022/modules/week6/#get-api-cars-id" class="sidebar-link">GET /api/cars/:id</a></li><li class="sidebar-sub-header"><a href="/W2022/modules/week6/#patch-api-cars-id" class="sidebar-link">PATCH /api/cars/:id</a></li><li class="sidebar-sub-header"><a href="/W2022/modules/week6/#put-api-cars-id" class="sidebar-link">PUT /api/cars/:id</a></li><li class="sidebar-sub-header"><a href="/W2022/modules/week6/#delete-api-cars-id" class="sidebar-link">DELETE /api/cars/:id</a></li></ul></li><li class="sidebar-sub-header"><a href="/W2022/modules/week6/#ex6-2-car-owner" class="sidebar-link">EX6-2 Car Owner</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/W2022/modules/week6/#person-model" class="sidebar-link">Person Model</a></li><li class="sidebar-sub-header"><a href="/W2022/modules/week6/#update-car-model-schema" class="sidebar-link">Update Car Model.schema</a></li><li class="sidebar-sub-header"><a href="/W2022/modules/week6/#populate-owner" class="sidebar-link">Populate owner</a></li><li class="sidebar-sub-header"><a href="/W2022/modules/week6/#people-router" class="sidebar-link">People Router</a></li><li class="sidebar-sub-header"><a href="/W2022/modules/week6/#submit-github-repo" class="sidebar-link">Submit GitHub Repo</a></li></ul></li><li class="sidebar-sub-header"><a href="/W2022/modules/week6/#for-next-class" class="sidebar-link">For next class</a></li></ul></li><li><a href="/W2022/modules/week7/" class="sidebar-link">Week 7: Data security</a></li><li><a href="/W2022/modules/break-week/" class="sidebar-link">Break Week</a></li><li><a href="/W2022/modules/week9/" class="sidebar-link">Week 9: Access Control with JWT</a></li><li><a href="/W2022/modules/week10/" class="sidebar-link">Week 10: JWT Review</a></li><li><a href="/W2022/modules/week11/" class="sidebar-link">Week 11: Consistent Error Handling</a></li><li><a href="/W2022/modules/week12/" class="sidebar-link">Week 12: Production Preparation</a></li><li><a href="/W2022/modules/week13/" class="sidebar-link">Week 13: Testing</a></li><li><a href="/W2022/modules/week14/" class="sidebar-link">Week 14: Production Deployment</a></li><li><a href="/W2022/modules/week15/" class="sidebar-link">Week 15: Final Lab</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1><span class="week">Week 6</span><br> <span class="title">Object Data Modelling with Mongoose</span></h1> <div class="custom-block danger"><p class="custom-block-title">Quiz 5: Databases <span class="badge tip" style="vertical-align:top;" data-v-15b7b770>15 mins</span></p> <p>There will be a quiz today. It will be worth 2% of your final grade.</p></div> <h2 id="agenda"><a href="#agenda" class="header-anchor">#</a> Agenda</h2> <ul><li>AMA (10 min)</li> <li>Quiz (10 min)</li> <li>Mongoose Models (20 mins)</li> <li>Mongoose Query Methods (10 mins)</li> <li>Break (10 min)</li> <li>EX6-1 Mongo Cars (50 min)</li> <li>Break (10 min)</li> <li>EX6-2 Car Owner (50 mins)</li></ul> <h2 id="mongoose-models"><a href="#mongoose-models" class="header-anchor">#</a> Mongoose Models</h2> <p>Mongoose is a Node.js based Object Data Modelling (ODM) library for MongoDB. It is used to abstract away the lower level MongoDB access APIs and manage the shape of application resource data structures. This is the <strong>M</strong> in the MVC software architecture pattern.</p> <p>Mongoose provides two core features to simplify the implementation of a MongoDB backed application.</p> <ol><li><p>The <code>mongoose.model()</code> method is a class factory -- meaning it is a function that returns a new class object which we can then use to instantiate individual document objects. This factory function takes two arguments: the name of the resource that this model represents, and a schema object describing the properties of that resource.</p></li> <li><p>The <code>mongoose.Schema</code> class is used to define the expected shape of resource properties -- their names, types, and validation limits.</p></li></ol> <h3 id="schema"><a href="#schema" class="header-anchor">#</a> Schema</h3> <p>A model schema could be a simple object specifying the property names and types.</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> catSchema <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">mongoose<span class="token punctuation">.</span>Schema</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  name<span class="token operator">:</span> String<span class="token punctuation">,</span>
  age<span class="token operator">:</span> Number
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>Or it can be expressed with more detailed options.</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> catSchema <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">mongoose<span class="token punctuation">.</span>Schema</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  name<span class="token operator">:</span> <span class="token punctuation">{</span>type<span class="token operator">:</span> String<span class="token punctuation">,</span> minlength<span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">,</span> maxlength<span class="token operator">:</span> <span class="token number">50</span><span class="token punctuation">,</span> required<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
  age<span class="token operator">:</span> <span class="token punctuation">{</span>type<span class="token operator">:</span> Number<span class="token punctuation">,</span> min<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span> max<span class="token operator">:</span> <span class="token number">25</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="schema-types"><a href="#schema-types" class="header-anchor">#</a> Schema Types</h3> <p>The following <a href="https://mongoosejs.com/docs/schematypes.html" target="_blank" rel="noopener noreferrer">Mongoose Schema Types<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> are permitted:</p> <ul><li>Array</li> <li>Boolean</li> <li>Buffer</li> <li>Date</li> <li>Mixed (A generic / flexible data type)</li> <li>Number</li> <li>ObjectId</li> <li>String</li></ul> <p><strong>Mixed</strong> and <strong>ObjectId</strong> are defined under <code>mongoose.Schema.Types</code>. We will look at this a little later when we create an owner relationship for the cars API.</p> <h3 id="making-models"><a href="#making-models" class="header-anchor">#</a> Making Models</h3> <p>Start by using the schema object with the <code>model()</code> factory method to generate a new class.</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> Cat <span class="token operator">=</span> mongoose<span class="token punctuation">.</span><span class="token function">model</span><span class="token punctuation">(</span><span class="token string">'Cat'</span><span class="token punctuation">,</span> catSchema<span class="token punctuation">)</span>
</code></pre></div><p>... and then we can use that Cat model to instantiate a new Mongoose document instance.</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> kitty <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Cat</span><span class="token punctuation">(</span><span class="token punctuation">{</span>name<span class="token operator">:</span> <span class="token string">'Spot'</span><span class="token punctuation">,</span> age<span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>The <code>mongoose.model</code> factory function generates new class objects, customized with the given schema, that inherit all of the methods required to interact with the MongoDB service. This includes a list of <a href="https://mongoosejs.com/docs/queries.html" target="_blank" rel="noopener noreferrer">static class methods<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> as well as <a href="https://mongoosejs.com/docs/guide.html#methods" target="_blank" rel="noopener noreferrer">instance methods<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>. e.g.</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// example class method</span>
Cat<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment">// example instance method</span>
kitty<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="relationships"><a href="#relationships" class="header-anchor">#</a> Relationships</h3> <p>Most applications have more complex data structures than our simple Cat model. Often this involves a relationship to another model. For example we might want to extend the Cat model to include an owner. In traditional SQL database systems, this means creating a new table to store the details about the Person that is the owner of the Cat, and then adding a new property like <code>owner_id</code> to the Cat schema to store the foreign key pointer to <code>people.id</code>.</p> <p>Document databases like <a href="https://docs.mongodb.com/manual/applications/data-models-relationships/" target="_blank" rel="noopener noreferrer">MongoDB give us two options<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>: embedded documents, and document references.</p> <h4 id="document-references"><a href="#document-references" class="header-anchor">#</a> Document References</h4> <p>Document references are similar to an SQL foreign key. It stores the <code>_id</code> value of a document in another collection. Unlike SQL databases this relationship is not enforced at the database level -- there is no validation that the reference id exists. We would add it to the schema like this, where the <code>ref</code> option is the name of another model class in our application.</p> <div class="language-js extra-class"><div class="highlight-lines"><br><br><br><div class="highlighted"> </div><br><br></div><pre class="language-js"><code><span class="token keyword">const</span> catSchema <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">mongoose<span class="token punctuation">.</span>Schema</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  name<span class="token operator">:</span> <span class="token punctuation">{</span>type<span class="token operator">:</span> String<span class="token punctuation">,</span> minlength<span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">,</span> maxlength<span class="token operator">:</span> <span class="token number">50</span><span class="token punctuation">,</span> required<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
  age<span class="token operator">:</span> <span class="token punctuation">{</span>type<span class="token operator">:</span> Number<span class="token punctuation">,</span> min<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span> max<span class="token operator">:</span> <span class="token number">25</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
  owner<span class="token operator">:</span> <span class="token punctuation">{</span>type<span class="token operator">:</span> mongoose<span class="token punctuation">.</span>Schema<span class="token punctuation">.</span>Types<span class="token punctuation">.</span>ObjectId<span class="token punctuation">,</span> ref<span class="token operator">:</span> <span class="token string">'Person'</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>Another difference from SQL is that the reference property could be an array.</p> <div class="language-js extra-class"><div class="highlight-lines"><br><br><br><div class="highlighted"> </div><br><br></div><pre class="language-js"><code><span class="token keyword">const</span> catSchema <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">mongoose<span class="token punctuation">.</span>Schema</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  name<span class="token operator">:</span> <span class="token punctuation">{</span>type<span class="token operator">:</span> String<span class="token punctuation">,</span> minlength<span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">,</span> maxlength<span class="token operator">:</span> <span class="token number">50</span><span class="token punctuation">,</span> required<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
  age<span class="token operator">:</span> <span class="token punctuation">{</span>type<span class="token operator">:</span> Number<span class="token punctuation">,</span> min<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span> max<span class="token operator">:</span> <span class="token number">25</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
  owners<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>type<span class="token operator">:</span> mongoose<span class="token punctuation">.</span>Schema<span class="token punctuation">.</span>Types<span class="token punctuation">.</span>ObjectId<span class="token punctuation">,</span> ref<span class="token operator">:</span> <span class="token string">'Person'</span><span class="token punctuation">}</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h5 id="example-usage"><a href="#example-usage" class="header-anchor">#</a> Example usage</h5> <p>The <code>owners</code> property stores an array of one or more <a href="https://mongoosejs.com/docs/schematypes.html#objectids" target="_blank" rel="noopener noreferrer">ObjectId<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> references to the unique <code>_id</code> of a document in the <code>Person</code> collection.</p> <div class="language-js extra-class"><div class="highlight-lines"><br><br><br><br><br><div class="highlighted"> </div><br><br></div><pre class="language-js"><code><span class="token keyword">const</span> Cat <span class="token operator">=</span> mongoose<span class="token punctuation">.</span><span class="token function">model</span><span class="token punctuation">(</span><span class="token string">'Cat'</span><span class="token punctuation">,</span> catSchema<span class="token punctuation">)</span>

<span class="token keyword">const</span> kitty <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Cat</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  name<span class="token operator">:</span> <span class="token string">'Fluffy'</span><span class="token punctuation">,</span>
  age<span class="token operator">:</span> <span class="token number">4</span><span class="token punctuation">,</span>
  owners<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'6021b7be9d383359e30a1327'</span><span class="token punctuation">,</span> <span class="token string">'6021b94e6a3a0b5a03fcd7ba'</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h4 id="embedded-documents"><a href="#embedded-documents" class="header-anchor">#</a> Embedded Documents</h4> <p>The other option is to embed the related documents as properties of the main document.</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> personSchema <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">mongoose<span class="token punctuation">.</span>Schema</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  firstName<span class="token operator">:</span> String<span class="token punctuation">,</span>
  lastName<span class="token operator">:</span> String<span class="token punctuation">,</span>
  phoneNumber<span class="token operator">:</span> Number
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> catSchema <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">mongoose<span class="token punctuation">.</span>Schema</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  name<span class="token operator">:</span> <span class="token punctuation">{</span>type<span class="token operator">:</span> String<span class="token punctuation">,</span> minlength<span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">,</span> maxlength<span class="token operator">:</span> <span class="token number">50</span><span class="token punctuation">,</span> required<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
  age<span class="token operator">:</span> <span class="token punctuation">{</span>type<span class="token operator">:</span> Number<span class="token punctuation">,</span> min<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span> max<span class="token operator">:</span> <span class="token number">25</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
  owners<span class="token operator">:</span> <span class="token punctuation">[</span>personSchema<span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> Cat <span class="token operator">=</span> mongoose<span class="token punctuation">.</span><span class="token function">model</span><span class="token punctuation">(</span><span class="token string">'Cat'</span><span class="token punctuation">,</span> catSchema<span class="token punctuation">)</span>

<span class="token keyword">const</span> kitty <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Cat</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  name<span class="token operator">:</span> <span class="token string">'Fluffy'</span><span class="token punctuation">,</span>
  age<span class="token operator">:</span> <span class="token number">4</span><span class="token punctuation">,</span>
  owners<span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>firstName<span class="token operator">:</span> <span class="token string">'Mickey'</span><span class="token punctuation">,</span> lastName<span class="token operator">:</span> <span class="token string">'Mouse'</span><span class="token punctuation">,</span> phoneNumber<span class="token operator">:</span> <span class="token number">14155551212</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>firstName<span class="token operator">:</span> <span class="token string">'Minnie'</span><span class="token punctuation">,</span> lastName<span class="token operator">:</span> <span class="token string">'Mouse'</span><span class="token punctuation">,</span> phoneNumber<span class="token operator">:</span> <span class="token number">14155551212</span><span class="token punctuation">}</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><div class="custom-block tip"><p class="custom-block-title">Trade-offs</p> <p>The relationship modelling method you choose is ultimately a trade-off between read query speed and data consistency.</p></div> <p>The referenced document method ensures that data remains consistent because it is stored in only one place for each schema model, but it requires an additional database query for each related document when retrieving the primary document. For queries returning a single document (most CRUD operations) this may be fine. However for complex search queries returning thousands of results, there could be a significant performance hit.</p> <p>The embedded document method avoids these additional database queries when retrieving data, but exponentially increases the complexity of maintaining data consistency because you are potentially storing the same data in many places and need to update them all manually.</p> <p>If we look at the Cat example above, and consider what happens when we want to change Mickey Mouse's phone number. In the reference method, we simply find the Person document for Mickey Mouse and update the phoneNumber property. Then whenever we need to contact Fluffy's owner, the data will be correct.</p> <p>However if we use the embedded method, we have to lookup all of the Cats that have an owner with the name Mickey Mouse and then update the embedded phone number. But what if there is more than one Person named Mickey Mouse? How do we know if we are updating the correct information? It can get messy if you don't plan it out well.</p> <h2 id="mongoose-query-methods"><a href="#mongoose-query-methods" class="header-anchor">#</a> Mongoose Query Methods</h2> <blockquote><p>Mongoose models provide several static helper functions for <strong>CRUD operations</strong>. Each of these functions returns a <a href="http://mongoosejs.com/docs/api.html#Query" target="_blank" rel="noopener noreferrer">mongoose Query object<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> ... A query also has a <code>.then()</code> function, and thus can be used as a promise.</p></blockquote> <p>Review the <a href="https://mongoosejs.com/docs/queries.html" target="_blank" rel="noopener noreferrer">mongoose documentation<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> for the full list, but these are the most common ones that we will be using.</p> <p><a href="https://mongoosejs.com/docs/api.html#model_Model.find" target="_blank" rel="noopener noreferrer">Model.find()<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> is used to get an array of documents matching the given filter criteria.</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> catsNamedSpot <span class="token operator">=</span> Cat<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">{</span>name<span class="token operator">:</span> <span class="token string">'Spot'</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>These methods act on a single document matching the given id parameter.</p> <ul><li>Model.findById()</li> <li>Model.findByIdAndRemove()</li> <li>Model.findByIdAndUpdate()</li></ul> <p>These methods act on the first document found matching the given filter criteria.</p> <ul><li>Model.findOne()</li> <li>Model.findOneAndRemove()</li> <li>Model.findOneAndUpdate()</li></ul> <h3 id="mongo-query-operators"><a href="#mongo-query-operators" class="header-anchor">#</a> Mongo Query Operators</h3> <p>In the filter criteria objects we can use any of the standard <a href="https://docs.mongodb.com/manual/reference/operator/query/" target="_blank" rel="noopener noreferrer">MongoDB query operators<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>. The syntax is to provide an object as the filter condition value for the given property. That object will have one of the Mongo query operators as it's key and the corresponding relative value. Let's look at some examples.</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> catsAgedFourOrMore <span class="token operator">=</span> Cat<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">{</span>age<span class="token operator">:</span> <span class="token punctuation">{</span>$gte<span class="token operator">:</span> <span class="token number">4</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> catsAgedLessThanFour <span class="token operator">=</span> Cat<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">{</span>age<span class="token operator">:</span> <span class="token punctuation">{</span>$lt<span class="token operator">:</span> <span class="token number">4</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> catsAgedTwoFourOrSix <span class="token operator">=</span> Cat<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">{</span>age<span class="token operator">:</span> <span class="token punctuation">{</span>$<span class="token keyword">in</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> catsNotAgedTwoFourOrSix <span class="token operator">=</span> Cat<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">{</span>age<span class="token operator">:</span> <span class="token punctuation">{</span>$nin<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="mongoose-query-helpers"><a href="#mongoose-query-helpers" class="header-anchor">#</a> Mongoose Query Helpers</h3> <p>Mongoose provides some <a href="https://mongoosejs.com/docs/api.html#Query" target="_blank" rel="noopener noreferrer">helper functions<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> to make writing your queries more fluent. The syntax is sometimes more readable, but the end result is exactly the same. So, use whichever method is easier for you.</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> catsAgedFourOrMore <span class="token operator">=</span> Cat<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token string">'age'</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">gte</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> catsAgedLessThanFour <span class="token operator">=</span> Cat<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token string">'age'</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">lt</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> catsAgedTwoFourOrSix <span class="token operator">=</span> Cat<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token string">'age'</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">in</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> catsNotAgedTwoFourOrSix <span class="token operator">=</span> Cat<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token string">'age'</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">nin</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre></div><h2 id="ex6-1-mongo-cars"><a href="#ex6-1-mongo-cars" class="header-anchor">#</a> EX6-1 Mongo Cars</h2> <p>We are going to recreate our Cars API with Mongoose and MongoDB. Let start by creating a new project folder. I called mine <code>week6</code>.</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token function">mkdir</span> week6
<span class="token builtin class-name">cd</span> week6
<span class="token builtin class-name">echo</span> <span class="token string">&quot;'use strict'&quot;</span> <span class="token operator">&gt;</span> app.js
<span class="token builtin class-name">echo</span> <span class="token string">&quot;.DS_Store<span class="token entity" title="\n">\n</span>node_modules/&quot;</span> <span class="token operator">&gt;</span> .gitignore
<span class="token function">git</span> init
<span class="token function">npm</span> init --yes
<span class="token function">npm</span> <span class="token function">install</span> express morgan
<span class="token function">git</span> <span class="token function">add</span> <span class="token builtin class-name">.</span>
<span class="token function">git</span> commit -m <span class="token string">&quot;Initialize project folder&quot;</span>
</code></pre></div><h3 id="connect-to-mongodb"><a href="#connect-to-mongodb" class="header-anchor">#</a> Connect to MongoDB</h3> <p>Before we can use Mongoose to connect to our MongoDB, we need to add it as an NPM dependency for our project.</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token function">npm</span> <span class="token function">install</span> mongoose
</code></pre></div><p>We only need to create the connection to MongoDB once in our application. You should do it in <code>app.js</code>, right at the top, before you initialize Express. If it cannot connect to the database, then we cannot proceed. So, use the <a href="https://nodejs.org/api/process.html#process_process_exit_code" target="_blank" rel="noopener noreferrer">process.exit([code])<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> function to terminate the node.js runtime.</p> <p>Just like last week, we require mongoose and then give it the connection string. This time the database path will be <code>/mad9124</code>.</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token string">'use strict'</span>

<span class="token keyword">const</span> mongoose <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'mongoose'</span><span class="token punctuation">)</span>
mongoose
  <span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span><span class="token string">'mongodb://localhost:27017/mad9124'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    useNewUrlParser<span class="token operator">:</span> <span class="token boolean">true</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Connected to MongoDB ...'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token parameter">err</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">'Problem connecting to MongoDB ...'</span><span class="token punctuation">,</span> err<span class="token punctuation">.</span>message<span class="token punctuation">)</span>
    process<span class="token punctuation">.</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>Let's add the rest of our <code>app.js</code> boilerplate code.</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> morgan <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'morgan'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'express'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">morgan</span><span class="token punctuation">(</span><span class="token string">'tiny'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>express<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> port <span class="token operator">=</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">PORT</span> <span class="token operator">||</span> <span class="token number">3030</span>
app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span>port<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">HTTP server listening on port </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>port<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> ...</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>Notice that we are using the <a href="https://www.npmjs.com/package/morgan" target="_blank" rel="noopener noreferrer">morgan<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> HTTP request logging middleware that we discussed in week 4. This will help with debugging, by showing the requests received by the server and their response codes.</p></div> <p>Make sure that MongoDB database service is running. Go back to the folder where you created the <code>docker-compose.yml</code> file last week and run <code>docker-compose ps</code>. If it does not show the service is running, start it up with <code>docker-compose up -d</code>.</p> <h3 id="nodemon"><a href="#nodemon" class="header-anchor">#</a> nodemon</h3> <p>Up until now, each time we have made changes to the node/express application, we have to kill the running instance with <kbd>CTL</kbd><kbd>C</kbd> and restart it with <code>node app.js</code>. Wouldn't it be nice if that happened automatically every time you save changes to the source code?</p> <blockquote><p>nodemon is a tool that helps develop node.js based applications by automatically restarting the node application when file changes in the directory are detected.</p></blockquote> <blockquote><p>nodemon does not require any additional changes to your code or method of development. nodemon is a replacement wrapper for node. To use nodemon, replace the word node on the command line when executing your script.</p></blockquote> <h4 id="install-nodemon"><a href="#install-nodemon" class="header-anchor">#</a> Install nodemon</h4> <p>Add nodemon as a development dependency for your project.</p> <div class="language- extra-class"><pre class="language-text"><code>npm install nodemon --save-dev
</code></pre></div><p>Then you can start your app using nodemon instead of the node command like this.</p> <div class="language- extra-class"><pre class="language-text"><code>npx nodemon app.js
</code></pre></div><div class="custom-block tip"><p class="custom-block-title">What is npx?</p> <p><a href="https://www.npmjs.com/package/npx" target="_blank" rel="noopener noreferrer">npx<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> is a CLI tool installed along with <code>npm</code> and allows you to run packages that are installed as local project dependencies (rather than being installed globally). It will also let you run other CLI tools directly from the NPM registry - without explicitly installing them.</p> <p>Check out this short article: <a href="https://www.freecodecamp.org/news/npm-vs-npx-whats-the-difference/" target="_blank" rel="noopener noreferrer">npm vs npx — What’s the Difference?<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></div> <p>If you started the app with <code>nodemon</code>, you should now see a successful connection message in the terminal.</p> <img src="/W2022/assets/img/screenshot-mongoose-connect.dcf786fd.png" class="screenshot"> <h4 id="add-a-script-to-package-json"><a href="#add-a-script-to-package-json" class="header-anchor">#</a> Add a script to package.json</h4> <p>Since this is something you will type over and over again, you might want to make a short-cut script in <code>package.json</code>. Add a <code>start</code> key in the <code>scripts</code> object like this ...</p> <div class="language-json extra-class"><div class="highlight-lines"><br><br><div class="highlighted"> </div><br><br></div><pre class="language-json"><code><span class="token property">&quot;scripts&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;test&quot;</span><span class="token operator">:</span> <span class="token string">&quot;echo \&quot;Error: no test specified\&quot; &amp;&amp; exit 1&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;start&quot;</span><span class="token operator">:</span> <span class="token string">&quot;nodemon app.js&quot;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
</code></pre></div><p>Now you can just type <code>npm start</code> to fire up you server with automatic reloading.</p> <h4 id="make-a-git-commit"><a href="#make-a-git-commit" class="header-anchor">#</a> Make a git commit</h4> <div class="language- extra-class"><pre class="language-text"><code>git add -A
git commit -m &quot;Add Mongoose db connection to Express app&quot;
</code></pre></div><h3 id="car-model"><a href="#car-model" class="header-anchor">#</a> Car Model</h3> <p>Before you can do any CRUD operations you need to define a Mongoose.Schema and create a <code>Car</code> Model object. Create a new <code>models</code> folder at the top level of your project and in it create a new file called <code>Car.js</code> -- note the capital 'C' as a reminder that this module will be exporting a class.</p> <p>The basic template for a Mongoose Model module is ...</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> mongoose <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'mongoose'</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> schema <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">mongoose<span class="token punctuation">.</span>Schema</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> Model <span class="token operator">=</span> mongoose<span class="token punctuation">.</span><span class="token function">model</span><span class="token punctuation">(</span><span class="token string">'Car'</span><span class="token punctuation">,</span> schema<span class="token punctuation">)</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> Model
</code></pre></div><p>Let's expand the schema definition object on line three. We want to define three properties for the Car documents: <strong>make</strong>, <strong>model</strong> and <strong>colour</strong>. All will be of type <code>String</code>.</p> <div class="custom-block tip"><p class="custom-block-title">Unique Identifier</p> <p>An <strong>_id</strong> property with a unique value will be automatically assigned to all new documents by Mongoose. You <strong>should not</strong> include the <code>_id</code> property in your schema definition.</p> <p>Review the full list of <a href="https://mongoosejs.com/docs/schematypes.html" target="_blank" rel="noopener noreferrer">Mongoose Schema Types<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> in the official documentation.</p></div> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> schema <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">mongoose<span class="token punctuation">.</span>Schema</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  make<span class="token operator">:</span> String<span class="token punctuation">,</span>
  model<span class="token operator">:</span> String<span class="token punctuation">,</span>
  colour<span class="token operator">:</span> String
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h4 id="make-a-git-commit-2"><a href="#make-a-git-commit-2" class="header-anchor">#</a> Make a git commit</h4> <div class="language- extra-class"><pre class="language-text"><code>git add -A
git commit -m &quot;Add the Mongoose model for Car&quot;
</code></pre></div><h3 id="crud-with-mongoose"><a href="#crud-with-mongoose" class="header-anchor">#</a> CRUD with Mongoose</h3> <p>OK, you have a working connection from the Express app to the MongoDB server in your local Docker container. Now let's set-up the API routes to talk to the database instead of an in memory array.</p> <p>Create a <code>routes</code> folder and in that folder create a new file called <code>cars.js</code> and stub out the six route handlers.</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'express'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> router <span class="token operator">=</span> express<span class="token punctuation">.</span><span class="token function">Router</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>

router<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>

router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/:id'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>

router<span class="token punctuation">.</span><span class="token function">patch</span><span class="token punctuation">(</span><span class="token string">'/:id'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>

router<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">'/:id'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>

router<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span><span class="token string">'/:id'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">/**
 * Format the response data object according to JSON:API v1.0
 * @param {string} type The resource collection name, e.g. 'cars'
 * @param {Object} resource An instance object from that collection
 * @returns
 */</span>
<span class="token keyword">function</span> <span class="token function">formatResponseData</span><span class="token punctuation">(</span><span class="token parameter">type<span class="token punctuation">,</span> resource</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span>id<span class="token punctuation">,</span> <span class="token operator">...</span>attributes<span class="token punctuation">}</span> <span class="token operator">=</span> resource
  <span class="token keyword">return</span> <span class="token punctuation">{</span>type<span class="token punctuation">,</span> id<span class="token punctuation">,</span> attributes<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> router
</code></pre></div><div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>Since the only time we are using <code>express</code> in this module is to create a router instance. You can directly request the <code>Router()</code> method and immediately invoke it. So this code ...</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'express'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> router <span class="token operator">=</span> express<span class="token punctuation">.</span><span class="token function">Router</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><p>Can be simplified to this code ...</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> router <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'express'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Router</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><p>But you can certainly write it out the long way if that makes it easier to read for you.</p></div> <p>Now let's register the cars router in the main <code>app.js</code> module after the <code>express.json()</code> middleware.</p> <div class="language-js extra-class"><div class="highlight-lines"><br><div class="highlighted"> </div><br></div><pre class="language-js"><code>app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>express<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token string">'/api/cars'</span><span class="token punctuation">,</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./routes/cars'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>One neat trick to simplify registering router modules with your Express app is to write the <code>require()</code> statement in-line with the <code>app.use()</code> method call. I find that this makes it easier to trace the application logic.</p></div> <h4 id="make-a-git-commit-3"><a href="#make-a-git-commit-3" class="header-anchor">#</a> Make a git commit</h4> <div class="language- extra-class"><pre class="language-text"><code>git add -A
git commit -m &quot;Add cars router module&quot;
</code></pre></div><h3 id="get-api-cars"><a href="#get-api-cars" class="header-anchor">#</a> GET /api/cars</h3> <p>Use the <code>find()</code> method to query the Car model for a list all of the cars in the collection. Before you can do that, you need to import the <code>Car</code> model class.</p> <p>Put this right at the top of <code>/routes/cars.js</code></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> Car <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../models/Car'</span><span class="token punctuation">)</span>
</code></pre></div><p>And then update our route handler. The Mongoose <code>find()</code> method returns a Promise so you can use the async/await syntax ...</p> <div class="language-js extra-class"><pre class="language-js"><code>router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> cars <span class="token operator">=</span> <span class="token keyword">await</span> Car<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">{</span>data<span class="token operator">:</span> cars<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">car</span> <span class="token operator">=&gt;</span> <span class="token function">formatResponseData</span><span class="token punctuation">(</span><span class="token string">'cars'</span><span class="token punctuation">,</span> car<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>You could also use traditional Promise syntax.</p> <div class="language-js extra-class"><pre class="language-js"><code>router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  Car<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">cars</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">{</span>data<span class="token operator">:</span> cars<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">car</span> <span class="token operator">=&gt;</span> <span class="token function">formatResponseData</span><span class="token punctuation">(</span><span class="token string">'cars'</span><span class="token punctuation">,</span> car<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div></div> <h4 id="test-it-with-postman"><a href="#test-it-with-postman" class="header-anchor">#</a> Test it with Postman</h4> <p>OK. Let's test that in Postman. Send a GET request to the <code>localhost:3030/api/cars</code> URL. You should see a status code 200 response with an empty array for the data payload – you haven't added any Car objects to the database yet 😉</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;data&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="make-a-git-commit-4"><a href="#make-a-git-commit-4" class="header-anchor">#</a> Make a git commit</h4> <p>If everything is working as expected, make a commit.</p> <div class="language- extra-class"><pre class="language-text"><code>git add -A
git commit -m &quot;Add the GET all cars route logic&quot;
</code></pre></div><p>That was easy! Let's do the POST route now so that you can add some cars to the database.</p> <h3 id="post-api-cars"><a href="#post-api-cars" class="header-anchor">#</a> POST /api/cars</h3> <p>Use the <code>req.body</code> as the input data to create a new <em>instance</em> of the Car model class – this will be a new Mongoose document. Then call the <code>.save()</code> method on that instance to persist it to the database.</p> <h4 id="never-trust-data-from-the-client"><a href="#never-trust-data-from-the-client" class="header-anchor">#</a> Never trust data from the client!</h4> <p>Before creating the new document, you need to ensure that the client did not try to set the <code>_id</code> value. You can use the JavaScript <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Operators/delete" target="_blank" rel="noopener noreferrer">delete<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> operator to remove the <code>_id</code> property from the <code>req.body</code>, if it exists.</p> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>Mongoose models will automatically discard any properties that are not defined in the Model.schema, so our route handler does not need to worry about extracting only permitted properties from the <code>req.body</code> as we had done in week 4.</p></div> <div class="language-js extra-class"><pre class="language-js"><code>router<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> attributes <span class="token operator">=</span> req<span class="token punctuation">.</span>body<span class="token punctuation">.</span>data<span class="token punctuation">.</span>attributes
  <span class="token keyword">delete</span> attributes<span class="token punctuation">.</span>_id <span class="token comment">// if it exists</span>

  <span class="token keyword">let</span> newCar <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Car</span><span class="token punctuation">(</span>attributes<span class="token punctuation">)</span>
  <span class="token keyword">await</span> newCar<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

  res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">201</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">{</span>data<span class="token operator">:</span> <span class="token function">formatResponseData</span><span class="token punctuation">(</span><span class="token string">'cars'</span><span class="token punctuation">,</span> newCar<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>This should get some more error handling, but this is the simple happy-path.</p> <div class="custom-block warning"><p class="custom-block-title">Notice the `await` keyword</p> <p>Any action that communicates with the database is an asynchronous action and your code needs to handle those Promises.</p></div> <h4 id="test-it-with-postman-2"><a href="#test-it-with-postman-2" class="header-anchor">#</a> Test it with Postman</h4> <p>Use the sample data from last week's <code>cars.json</code> file to use with Postman. Remember that you need to add the Car object as the JSON body for the POST request. Add each of the four cars, one at a time.</p> <details class="custom-block details"><summary>JSON:API formatted data for Postman</summary> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;data&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;cars&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;attributes&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;make&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Tesla&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;model&quot;</span><span class="token operator">:</span> <span class="token string">&quot;S&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;colour&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Silver&quot;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div></details> <h4 id="make-a-git-commit-5"><a href="#make-a-git-commit-5" class="header-anchor">#</a> Make a git commit</h4> <p>If everything is working as expected, make a commit.</p> <div class="language- extra-class"><pre class="language-text"><code>git add -A
git commit -m &quot;Add the POST route logic&quot;
</code></pre></div><h3 id="get-api-cars-id"><a href="#get-api-cars-id" class="header-anchor">#</a> GET /api/cars/:id</h3> <p>First let's do the happy path ... no error handling. You can use the <code>.findById()</code> <em>static method</em> on the Car model class. The <code>id</code> parameter from the request URI is accessible in the route handler on the <code>req.params</code> object.</p> <div class="language-js extra-class"><pre class="language-js"><code>router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/:id'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> car <span class="token operator">=</span> <span class="token keyword">await</span> Car<span class="token punctuation">.</span><span class="token function">findById</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>params<span class="token punctuation">.</span>id<span class="token punctuation">)</span>
  res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">{</span>data<span class="token operator">:</span> <span class="token function">formatResponseData</span><span class="token punctuation">(</span><span class="token string">'cars'</span><span class="token punctuation">,</span> car<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>OK, now what if the <code>id</code> does not exist as a unique identifier in our database? You should wrap the code in a <code>try/catch</code> block and then send an appropriate error response back to the client.</p> <div class="language-js extra-class"><pre class="language-js"><code>router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/:id'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> car <span class="token operator">=</span> <span class="token keyword">await</span> Car<span class="token punctuation">.</span><span class="token function">findById</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>params<span class="token punctuation">.</span>id<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>car<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'Resource not found'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">{</span>data<span class="token operator">:</span> <span class="token function">formatResponseData</span><span class="token punctuation">(</span><span class="token string">'cars'</span><span class="token punctuation">,</span> car<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">404</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      errors<span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span>
          status<span class="token operator">:</span> <span class="token string">'404'</span><span class="token punctuation">,</span>
          title<span class="token operator">:</span> <span class="token string">'Resource does not exist'</span><span class="token punctuation">,</span>
          description<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">We could not find a car with id: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>req<span class="token punctuation">.</span>params<span class="token punctuation">.</span>id<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">]</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>As we have seen before, you will need this same error handler in several other routes. So, extract this to a helper function. At the bottom of the <code>/routes/cars.js</code> module, but just above the <code>module.exports</code> line, add this private function.</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">sendResourceNotFound</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">404</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    errors<span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token punctuation">{</span>
        status<span class="token operator">:</span> <span class="token string">'404'</span><span class="token punctuation">,</span>
        title<span class="token operator">:</span> <span class="token string">'Resource does not exist'</span><span class="token punctuation">,</span>
        description<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">We could not find a car with id: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>req<span class="token punctuation">.</span>params<span class="token punctuation">.</span>id<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">]</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> router
</code></pre></div><p>... and then update your route handler's catch block to call this function.</p> <div class="language-js extra-class"><div class="highlight-lines"><br><br><br><br><br><br><div class="highlighted"> </div><br><br><br></div><pre class="language-js"><code>router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/:id'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> car <span class="token operator">=</span> <span class="token keyword">await</span> Car<span class="token punctuation">.</span><span class="token function">findById</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>params<span class="token punctuation">.</span>id<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>car<span class="token punctuation">)</span> <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'Resource not found'</span><span class="token punctuation">)</span>
    res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">{</span>data<span class="token operator">:</span> <span class="token function">formatResponseData</span><span class="token punctuation">(</span><span class="token string">'cars'</span><span class="token punctuation">,</span> car<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">sendResourceNotFound</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><div class="custom-block warning"><p class="custom-block-title">Better error handling</p> <p>This is better but still incomplete. We will look at more robust error handling solutions in a couple of weeks.</p></div> <h4 id="test-it-with-postman-3"><a href="#test-it-with-postman-3" class="header-anchor">#</a> Test it with Postman</h4> <p>Do a GET request to the <code>localhost:3030/api/cars</code> route. Then copy the <code>_id</code> value for one of the cars. Now do another GET request appending that value to the end of the URL.</p> <p>e.g. <code>localhost:3030/api/cars/5ff776067b6bf504b6db320c</code></p> <h4 id="make-a-git-commit-6"><a href="#make-a-git-commit-6" class="header-anchor">#</a> Make a git commit</h4> <p>If everything is working as expected, make a commit.</p> <div class="language- extra-class"><pre class="language-text"><code>git add -A
git commit -m &quot;Add the GET by id route logic&quot;
</code></pre></div><h3 id="patch-api-cars-id"><a href="#patch-api-cars-id" class="header-anchor">#</a> PATCH /api/cars/:id</h3> <p>For the update actions, we can use the <code>findByIdAndUpdate()</code> static method on the Car model class. Similar to the <code>findById()</code> method, it takes a document <code>_id</code> value as the first argument. The second argument is an object with the properties to be stored. The third argument is an options object.</p> <h4 id="second-argument-update-payload"><a href="#second-argument-update-payload" class="header-anchor">#</a> Second argument - update payload</h4> <p>The <code>_id</code> property for the update operation is an immutable (read-only) field. To ensure that it has not been modified (accidentally or maliciously), use object destructuring to separate and discard any <code>_id</code> property that may be included in the <code>req.body</code>. Then reconstruct the update payload object, explicitly setting <code>_id: req.params.id</code> and then use the rest operator to extract the remaining attributes.</p> <h4 id="third-argument-options-object"><a href="#third-argument-options-object" class="header-anchor">#</a> Third argument - options object</h4> <p>The documentation lists many options that can be set to modify the behaviour of the update method. We are interested in two.</p> <ol><li><p>Setting <code>new</code> to <code>true</code> will return the updated record from the database. The default behaviour returns the document in it's pre-update state.</p></li> <li><p>Setting <code>runValidators</code> to <code>true</code> ensures that your Model.schema rules are checked before the updates are applied.</p></li></ol> <div class="language-js extra-class"><pre class="language-js"><code>router<span class="token punctuation">.</span><span class="token function">patch</span><span class="token punctuation">(</span><span class="token string">'/:id'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span>_id<span class="token punctuation">,</span> <span class="token operator">...</span>otherAttributes<span class="token punctuation">}</span> <span class="token operator">=</span> req<span class="token punctuation">.</span>body<span class="token punctuation">.</span>data<span class="token punctuation">.</span>attributes
    <span class="token keyword">const</span> car <span class="token operator">=</span> <span class="token keyword">await</span> Car<span class="token punctuation">.</span><span class="token function">findByIdAndUpdate</span><span class="token punctuation">(</span>
      req<span class="token punctuation">.</span>params<span class="token punctuation">.</span>id<span class="token punctuation">,</span>
      <span class="token punctuation">{</span>_id<span class="token operator">:</span> req<span class="token punctuation">.</span>params<span class="token punctuation">.</span>id<span class="token punctuation">,</span> <span class="token operator">...</span>otherAttributes<span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">{</span>
        <span class="token keyword">new</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
        runValidators<span class="token operator">:</span> <span class="token boolean">true</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>car<span class="token punctuation">)</span> <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'Resource not found'</span><span class="token punctuation">)</span>
    res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">{</span>data<span class="token operator">:</span> <span class="token function">formatResponseData</span><span class="token punctuation">(</span><span class="token string">'cars'</span><span class="token punctuation">,</span> car<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">sendResourceNotFound</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h4 id="test-it-with-postman-4"><a href="#test-it-with-postman-4" class="header-anchor">#</a> Test it with Postman</h4> <p>Do a PATCH request using the same URI as the previous test. This time include a JSON object in the request body. It should change one or more of the Car object properties. e.g. set a new colour.</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;data&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;cars&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;id&quot;</span><span class="token operator">:</span> <span class="token string">&quot;this should be the same as the URL parameter&quot;</span>
    <span class="token property">&quot;attributes&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;colour&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Silver Mist&quot;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Try adding an invalid <code>_id</code> property to the update payload (request body).</p> <div class="language-json extra-class"><div class="highlight-lines"><br><br><br><br><br><div class="highlighted"> </div><br><br><br><br><br></div><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;data&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;cars&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;id&quot;</span><span class="token operator">:</span> <span class="token string">&quot;this should be the same as the URL parameter&quot;</span>
    <span class="token property">&quot;attributes&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;_id&quot;</span><span class="token operator">:</span> <span class="token string">&quot;5ff776067b6bf504b6db320f&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;colour&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Silver Mist&quot;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="make-a-git-commit-7"><a href="#make-a-git-commit-7" class="header-anchor">#</a> Make a git commit</h4> <p>If everything is working as expected, make a commit.</p> <div class="language- extra-class"><pre class="language-text"><code>git add -A
git commit -m &quot;Add the PATCH route logic&quot;
</code></pre></div><h3 id="put-api-cars-id"><a href="#put-api-cars-id" class="header-anchor">#</a> PUT /api/cars/:id</h3> <p>By calling the PUT method, the client is asking to entirely replace the current document with the one supplied in the <code>req.body</code>. The route handler is identical to the PATH method with one additional property in the options object.</p> <p>Set the <code>overwrite</code> option to <code>true</code>.</p> <p>This will update any supplied document properties the same as with the PATCH method, but any document properties that are omitted from the <code>req.body</code> will be removed from the database.</p> <div class="language-js extra-class"><div class="highlight-lines"><br><br><br><br><br><br><br><br><div class="highlighted"> </div><br><br><br><br><br><br><br><br><br><br></div><pre class="language-js"><code>router<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">'/:id'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span>_id<span class="token punctuation">,</span> <span class="token operator">...</span>otherAttributes<span class="token punctuation">}</span> <span class="token operator">=</span> req<span class="token punctuation">.</span>body<span class="token punctuation">.</span>data<span class="token punctuation">.</span>attributes
    <span class="token keyword">const</span> car <span class="token operator">=</span> <span class="token keyword">await</span> Car<span class="token punctuation">.</span><span class="token function">findByIdAndUpdate</span><span class="token punctuation">(</span>
      req<span class="token punctuation">.</span>params<span class="token punctuation">.</span>id<span class="token punctuation">,</span>
      <span class="token punctuation">{</span>_id<span class="token operator">:</span> req<span class="token punctuation">.</span>params<span class="token punctuation">.</span>id<span class="token punctuation">,</span> <span class="token operator">...</span>otherAttributes<span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">{</span>
        <span class="token keyword">new</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
        overwrite<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
        runValidators<span class="token operator">:</span> <span class="token boolean">true</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>car<span class="token punctuation">)</span> <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'Resource not found'</span><span class="token punctuation">)</span>
    res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">{</span>data<span class="token operator">:</span> <span class="token function">formatResponseData</span><span class="token punctuation">(</span><span class="token string">'cars'</span><span class="token punctuation">,</span> car<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">sendResourceNotFound</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h4 id="test-it-with-postman-5"><a href="#test-it-with-postman-5" class="header-anchor">#</a> Test it with Postman</h4> <h4 id="make-a-git-commit-8"><a href="#make-a-git-commit-8" class="header-anchor">#</a> Make a git commit</h4> <p>If everything is working as expected, make a commit.</p> <div class="language- extra-class"><pre class="language-text"><code>git add -A
git commit -m &quot;Add the PUT route logic&quot;
</code></pre></div><h3 id="delete-api-cars-id"><a href="#delete-api-cars-id" class="header-anchor">#</a> DELETE /api/cars/:id</h3> <p>This time we want the <code>findByIdAndRemove()</code> static method on the Car model class.</p> <div class="language-js extra-class"><div class="highlight-lines"><br><br><div class="highlighted"> </div><br><br><br><br><br><br><br></div><pre class="language-js"><code>router<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span><span class="token string">'/:id'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> car <span class="token operator">=</span> <span class="token keyword">await</span> Car<span class="token punctuation">.</span><span class="token function">findByIdAndRemove</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>params<span class="token punctuation">.</span>id<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>car<span class="token punctuation">)</span> <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'Resource not found'</span><span class="token punctuation">)</span>
    res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">{</span>data<span class="token operator">:</span> <span class="token function">formatResponseData</span><span class="token punctuation">(</span><span class="token string">'cars'</span><span class="token punctuation">,</span> car<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">sendResourceNotFound</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h4 id="test-it-with-postman-6"><a href="#test-it-with-postman-6" class="header-anchor">#</a> Test it with Postman</h4> <h4 id="make-a-git-commit-9"><a href="#make-a-git-commit-9" class="header-anchor">#</a> Make a git commit</h4> <p>If everything is working as expected, make a commit.</p> <div class="language- extra-class"><pre class="language-text"><code>git add -A
git commit -m &quot;Add the DELETE route logic&quot;
</code></pre></div><p>That's it! We have recreated the cars API from week 4 using MongoDB and Mongoose.</p> <h4 id="take-a-short-break"><a href="#take-a-short-break" class="header-anchor">#</a> Take a short break!</h4> <h2 id="ex6-2-car-owner"><a href="#ex6-2-car-owner" class="header-anchor">#</a> EX6-2 Car Owner</h2> <p>In real life, cars have owners. Let's extend the API to include a <code>/api/people</code> resource path, and link the Person and Car models to each other by using the reference method.</p> <h3 id="person-model"><a href="#person-model" class="header-anchor">#</a> Person Model</h3> <p>Create a new file called <code>Person.js</code> in the <code>/models</code> folder.</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> mongoose <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'mongoose'</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> schema <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">mongoose<span class="token punctuation">.</span>Schema</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  name<span class="token operator">:</span> <span class="token punctuation">{</span>
    first<span class="token operator">:</span> String<span class="token punctuation">,</span>
    last<span class="token operator">:</span> String
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  email<span class="token operator">:</span> String<span class="token punctuation">,</span>
  birthDate<span class="token operator">:</span> Date<span class="token punctuation">,</span>
  phone<span class="token operator">:</span> Number<span class="token punctuation">,</span>
  address<span class="token operator">:</span> <span class="token punctuation">{</span>
    streetNumber<span class="token operator">:</span> String<span class="token punctuation">,</span>
    streetName<span class="token operator">:</span> String<span class="token punctuation">,</span>
    city<span class="token operator">:</span> String<span class="token punctuation">,</span>
    region<span class="token operator">:</span> String<span class="token punctuation">,</span>
    country<span class="token operator">:</span> String<span class="token punctuation">,</span>
    postalCode<span class="token operator">:</span> String
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> Model <span class="token operator">=</span> mongoose<span class="token punctuation">.</span><span class="token function">model</span><span class="token punctuation">(</span><span class="token string">'Person'</span><span class="token punctuation">,</span> schema<span class="token punctuation">)</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> Model
</code></pre></div><h3 id="update-car-model-schema"><a href="#update-car-model-schema" class="header-anchor">#</a> Update Car Model.schema</h3> <p>Add the <code>owner</code> property with the <code>type</code> being a <a href="https://mongoosejs.com/docs/schematypes.html#objectids" target="_blank" rel="noopener noreferrer">mongoose.Schema.Types.ObjectId<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> reference to the <code>Person</code> model.</p> <div class="language-js extra-class"><div class="highlight-lines"><br><br><br><br><div class="highlighted"> </div><br><br></div><pre class="language-js"><code><span class="token keyword">const</span> schema <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">mongoose<span class="token punctuation">.</span>Schema</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  make<span class="token operator">:</span> String<span class="token punctuation">,</span>
  model<span class="token operator">:</span> String<span class="token punctuation">,</span>
  colour<span class="token operator">:</span> String<span class="token punctuation">,</span>
  owner<span class="token operator">:</span> <span class="token punctuation">{</span>type<span class="token operator">:</span> mongoose<span class="token punctuation">.</span>Schema<span class="token punctuation">.</span>Types<span class="token punctuation">.</span>ObjectId<span class="token punctuation">,</span> ref<span class="token operator">:</span> <span class="token string">'Person'</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>Also, right at the top we need to require the Person model so that Mongoose knows about it. This model would normally be loaded into our application in the people router module, but we haven't built that yet.</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> Person <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./Person'</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="populate-owner"><a href="#populate-owner" class="header-anchor">#</a> Populate owner</h3> <p>In the Car route handler, you may include the related owner document as an embedded object with the the Car object. This saves the client from needing to make a second request.</p> <p>To expand the referenced <code>_id</code> value for the <code>owner</code> property, we need to use the Mongoose <a href="https://mongoosejs.com/docs/populate.html" target="_blank" rel="noopener noreferrer">.populate()<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> method.</p> <blockquote><p>Populated paths are no longer set to their original <code>_id</code> , their value is <strong>replaced</strong> with the mongoose document returned from the database by performing a separate query before returning the results.</p></blockquote> <p>In the <code>/routes/cars.js</code> file, update the <strong>GET /:id</strong> route handler to chain the <code>.populate('owner')</code> method onto the <code>findById()</code> method call.</p> <div class="language-js extra-class"><div class="highlight-lines"><br><br><div class="highlighted"> </div><br><br><br><br><br><br><br></div><pre class="language-js"><code>router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/:id'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> car <span class="token operator">=</span> <span class="token keyword">await</span> Car<span class="token punctuation">.</span><span class="token function">findById</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>params<span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">populate</span><span class="token punctuation">(</span><span class="token string">'owner'</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>car<span class="token punctuation">)</span> <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'Resource not found'</span><span class="token punctuation">)</span>
    res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">{</span>data<span class="token operator">:</span> <span class="token function">formatResponseData</span><span class="token punctuation">(</span><span class="token string">'cars'</span><span class="token punctuation">,</span> car<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">sendResourceNotFound</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><div class="custom-block warning"><p class="custom-block-title">Formatting JSON:API with Relationships</p> <p>This is not really the right way to return <a href="https://jsonapi.org/format/#fetching-relationships" target="_blank" rel="noopener noreferrer">JSON:API data payloads with related models<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>. We will look at how to fix those next week.</p></div> <div class="custom-block tip"><p class="custom-block-title">Let's test it!</p> <p>Before we can test this out, there needs to be people in the database, and we need to either add a new car with an owner property or update one.</p></div> <h4 id="manually-add-people-collection"><a href="#manually-add-people-collection" class="header-anchor">#</a> Manually add people collection</h4> <p>Using MongoDB Compass you can manually create the <code>people</code> collection and add a document.</p> <ol><li>Select the <code>mad9124</code> database in the left sidebar.</li> <li>Click on the <code>Create Collection</code> button.</li> <li>Type the collection name as <code>people</code> -- all lowercase.</li> <li>Click the green <code>Create Collection</code> button.</li></ol> <p><img src="/W2022/assets/img/screenshot-compass-create-collection.7097a793.png" alt="screenshot of MongoDB compass"> <img src="/W2022/assets/img/screenshot-compass-collection-name.493ca9eb.png" alt="screenshot of MongoDB compass"> <img src="/W2022/assets/img/screenshot-compass-collection-list.545687be.png" alt="screenshot of MongoDB compass"></p> <h4 id="manually-add-a-person-document"><a href="#manually-add-a-person-document" class="header-anchor">#</a> Manually add a Person document</h4> <ol><li>Click on the newly created <code>people</code> collection in the collection list.</li> <li>Click on the green <code>Add Data</code> drop-down button, and select <code>Insert Document</code>.</li> <li>Add the properties and values for your Person document.<br>
Make sure it matched the schema in the Person model.</li> <li>Click the green <code>Insert</code> button.</li></ol> <p><img src="/W2022/assets/img/screenshot-compass-insert-document.88b525e0.png" alt="screenshot of MongoDB compass"></p> <h4 id="update-a-car-document"><a href="#update-a-car-document" class="header-anchor">#</a> Update a Car document</h4> <p>Now that you have a Person in the database you can link that document as an owner reference in one of the Car documents. Use Postman to do a PATCH update on one of your Car documents with the <code>_id</code> value from your new Person document as the value for the <code>owner</code> property of the car.</p> <p><img src="/W2022/assets/img/screenshot-compass-person-document.16e100d4.png" alt="screenshot of MongoDB compass"> <img src="/W2022/assets/img/screenshot-postman-patch-owner.d7dba67f.png" alt="screenshot of Postman PATCH request"></p> <h4 id="test-the-get-api-cars-id-route"><a href="#test-the-get-api-cars-id-route" class="header-anchor">#</a> Test the GET /api/cars/:id route</h4> <p>Now that there is a Car document with an <code>owner</code> property linked to a Person document, you can finally test the <code>.populate()</code> instruction that you added to the <strong>GET /api/cars/:id</strong> route handler.</p> <p>You should see the <code>owner</code> property has been expanded to include the entire related Person document – not just the <code>Person._id</code> string.</p> <p><img src="/W2022/assets/img/screenshot-postman-get-car.1ac00981.png" alt="screenshot of Postman GET request"></p> <h3 id="people-router"><a href="#people-router" class="header-anchor">#</a> People Router</h3> <p>Now that you have seen how to implement the cars router module. Use that as a template to implement the people router module on your own.</p> <p>Create a new <code>/routes/people.js</code> file to implement a router module for the <code>/api/people</code> resource path. Be sure to require the Person model in your router module. Then register the router in the main <code>app.js</code> file.</p> <p>Test all of the routes with Postman.</p> <p>Make a git commit after completing each route handler.</p> <div class="custom-block tip"><p class="custom-block-title">Bonus</p> <p>Add a <code>cars</code> property to the Person model that holds an array of related Car references. Update the <code>GET /api/people/:id</code> route to populate the person's cars.</p></div> <h3 id="submit-github-repo"><a href="#submit-github-repo" class="header-anchor">#</a> Submit GitHub Repo</h3> <p>Create a new private repo on GitHub named <strong>mad9124-w21-ex6-mongo-cars</strong>.</p> <p>Make sure that you have initialized your local project folder with <code>git init</code> and created a <code>.gitignore</code> file to exclude the <code>node_modules</code> folder and the <code>.DS_Store</code> files from your git archive.</p> <p>Create a final commit to include all of your work from today's exercises.</p> <p>Link the local repo to the GitHub repo and sync them up.</p> <p>Remember to add <code>rlmckenney</code> as a collaborator on your GitHub repo so that I can see your code, and submit the GitHub repo's URL on Brightspace.</p> <h2 id="for-next-class"><a href="#for-next-class" class="header-anchor">#</a> For next class</h2> <p>Before next class, please read these additional online resources.</p> <ul><li><a href="https://medium.freecodecamp.org/introduction-to-mongoose-for-mongodb-d2a7aa593c57" target="_blank" rel="noopener noreferrer">Introduction to Mongoose for MongoDB<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://mongoosejs.com/docs/queries.html" target="_blank" rel="noopener noreferrer">Mongoose Guide: Queries<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://docs.mongodb.com/manual/reference/operator/query/" target="_blank" rel="noopener noreferrer">MongoDB query operators<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://mongoosejs.com/docs/api.html#Query" target="_blank" rel="noopener noreferrer">Mongoose query helper functions<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://mongoosejs.com/docs/schematypes.html" target="_blank" rel="noopener noreferrer">Mongoose Schema Types<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://nodejs.org/api/process.html#process_process_exit_code" target="_blank" rel="noopener noreferrer">process.exit([code])<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul> <div class="custom-block warning"><p class="custom-block-title">Start Assignment 2 - Mongo CRUD</p> <p>You have enough information now to get started on <a href="/deliverables/assignment2">Assignment 2</a>. We will cover the remaining 15% of what you need to know next week.</p> <p>This assignment is due on the Wednesday of Week 9 after the break. Don't wait until to the last minute!</p></div> <div class="custom-block danger"><p class="custom-block-title">Family Day</p> <p>Our scheduled class for week 7 falls on Family Day, and the college is closed. I will post a pre-recorded lecture/demo explaining topics related to data security and using ES Modules with Express. You can watch that when it is convenient for you.</p> <p>I will also be holding a special open lab session on Tuesday, February 22, 2022 from 6:00 pm until 8:00 pm for anyone who would like assistance with the lab exercises.</p> <p>The week 7 quiz will be available to be completed any time before 11:59 pm on Tuesday, February 22, 2022</p></div></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">2/13/2022, 7:02:48 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/W2022/modules/week5/" class="prev">
        Week 5: Data persistence
      </a></span> <span class="next"><a href="/W2022/modules/week7/">
        Week 7: Data security
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/W2022/assets/js/app.cec51691.js" defer></script><script src="/W2022/assets/js/3.9c2ff4f7.js" defer></script><script src="/W2022/assets/js/8.0225588a.js" defer></script><script src="/W2022/assets/js/11.f11acbbb.js" defer></script><script src="/W2022/assets/js/16.1ec56656.js" defer></script>
  </body>
</html>
