<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Week 4: Middleware functions | MAD9124</title>
    <meta name="generator" content="VuePress 1.7.1">
    
    <meta name="description" content="Full Stack: API Development">
    
    <link rel="preload" href="/W2022/assets/css/0.styles.7a32498c.css" as="style"><link rel="preload" href="/W2022/assets/js/app.cec51691.js" as="script"><link rel="preload" href="/W2022/assets/js/3.9c2ff4f7.js" as="script"><link rel="preload" href="/W2022/assets/js/21.e5b3b049.js" as="script"><link rel="preload" href="/W2022/assets/js/11.f11acbbb.js" as="script"><link rel="preload" href="/W2022/assets/js/16.1ec56656.js" as="script"><link rel="prefetch" href="/W2022/assets/js/10.31dfe672.js"><link rel="prefetch" href="/W2022/assets/js/12.96649c49.js"><link rel="prefetch" href="/W2022/assets/js/13.535bc82d.js"><link rel="prefetch" href="/W2022/assets/js/14.028cb9d2.js"><link rel="prefetch" href="/W2022/assets/js/15.ced8bd8c.js"><link rel="prefetch" href="/W2022/assets/js/17.a48a571a.js"><link rel="prefetch" href="/W2022/assets/js/18.1528acad.js"><link rel="prefetch" href="/W2022/assets/js/19.61d8cc80.js"><link rel="prefetch" href="/W2022/assets/js/2.b4d63df3.js"><link rel="prefetch" href="/W2022/assets/js/20.4071399f.js"><link rel="prefetch" href="/W2022/assets/js/22.8b4aae43.js"><link rel="prefetch" href="/W2022/assets/js/23.61c52980.js"><link rel="prefetch" href="/W2022/assets/js/24.55bc8f66.js"><link rel="prefetch" href="/W2022/assets/js/25.4ac50e54.js"><link rel="prefetch" href="/W2022/assets/js/26.9ce0e977.js"><link rel="prefetch" href="/W2022/assets/js/27.3a9bd92a.js"><link rel="prefetch" href="/W2022/assets/js/28.06fd6a07.js"><link rel="prefetch" href="/W2022/assets/js/29.1bb95a0c.js"><link rel="prefetch" href="/W2022/assets/js/30.dae4692c.js"><link rel="prefetch" href="/W2022/assets/js/31.8fbfd6d3.js"><link rel="prefetch" href="/W2022/assets/js/32.68c3574f.js"><link rel="prefetch" href="/W2022/assets/js/33.617cdd3b.js"><link rel="prefetch" href="/W2022/assets/js/34.e9d21a2b.js"><link rel="prefetch" href="/W2022/assets/js/35.6e9bfe39.js"><link rel="prefetch" href="/W2022/assets/js/36.d4810b3d.js"><link rel="prefetch" href="/W2022/assets/js/37.8f7eb267.js"><link rel="prefetch" href="/W2022/assets/js/38.23784716.js"><link rel="prefetch" href="/W2022/assets/js/39.2e9e7983.js"><link rel="prefetch" href="/W2022/assets/js/4.a3d079e3.js"><link rel="prefetch" href="/W2022/assets/js/40.7f13d575.js"><link rel="prefetch" href="/W2022/assets/js/5.3200619b.js"><link rel="prefetch" href="/W2022/assets/js/6.4a9ec533.js"><link rel="prefetch" href="/W2022/assets/js/7.f496cd23.js"><link rel="prefetch" href="/W2022/assets/js/8.0225588a.js"><link rel="prefetch" href="/W2022/assets/js/9.665b29a5.js">
    <link rel="stylesheet" href="/W2022/assets/css/0.styles.7a32498c.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/W2022/" class="home-link router-link-active"><!----> <span class="site-name">MAD9124</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/W2022/overview/" class="nav-link">
  Overview
</a></div><div class="nav-item"><a href="/W2022/modules/" class="nav-link router-link-active">
  Modules
</a></div><div class="nav-item"><a href="/W2022/deliverables/" class="nav-link">
  Deliverables
</a></div><div class="nav-item"><a href="/W2022/resources/" class="nav-link">
  Resources
</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/W2022/overview/" class="nav-link">
  Overview
</a></div><div class="nav-item"><a href="/W2022/modules/" class="nav-link router-link-active">
  Modules
</a></div><div class="nav-item"><a href="/W2022/deliverables/" class="nav-link">
  Deliverables
</a></div><div class="nav-item"><a href="/W2022/resources/" class="nav-link">
  Resources
</a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Introduction</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Deliverables</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>Content Modules</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/W2022/modules/" aria-current="page" class="sidebar-link">Table of contents</a></li><li><a href="/W2022/modules/week1/" class="sidebar-link">Week 1: Introduction &amp; Review</a></li><li><a href="/W2022/modules/week2/" class="sidebar-link">Week 2: Node Modules &amp; Express</a></li><li><a href="/W2022/modules/week3/" class="sidebar-link">Week 3: RESTful APIs</a></li><li><a href="/W2022/modules/week4/" aria-current="page" class="active sidebar-link">Week 4: Middleware functions</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/W2022/modules/week4/#agenda" class="sidebar-link">Agenda</a></li><li class="sidebar-sub-header"><a href="/W2022/modules/week4/#review" class="sidebar-link">Review</a></li><li class="sidebar-sub-header"><a href="/W2022/modules/week4/#what-is-middleware" class="sidebar-link">What is middleware</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/W2022/modules/week4/#middleware-function-signature" class="sidebar-link">Middleware function signature</a></li><li class="sidebar-sub-header"><a href="/W2022/modules/week4/#types-of-middleware" class="sidebar-link">Types of middleware</a></li><li class="sidebar-sub-header"><a href="/W2022/modules/week4/#common-use-cases" class="sidebar-link">Common use cases</a></li><li class="sidebar-sub-header"><a href="/W2022/modules/week4/#timestamp-logger" class="sidebar-link">Timestamp Logger</a></li><li class="sidebar-sub-header"><a href="/W2022/modules/week4/#router-modules" class="sidebar-link">Router modules</a></li></ul></li><li class="sidebar-sub-header"><a href="/W2022/modules/week4/#ex4-1-router-module" class="sidebar-link">EX4-1 Router Module</a></li><li class="sidebar-sub-header"><a href="/W2022/modules/week4/#ex4-2-project-folder-structure" class="sidebar-link">EX4-2 Project Folder Structure</a></li><li class="sidebar-sub-header"><a href="/W2022/modules/week4/#ex4-3-carid-validator-middleware" class="sidebar-link">EX4-3 carId Validator Middleware</a></li><li class="sidebar-sub-header"><a href="/W2022/modules/week4/#for-next-week" class="sidebar-link">For next week</a></li></ul></li><li><a href="/W2022/modules/week5/" class="sidebar-link">Week 5: Data persistence</a></li><li><a href="/W2022/modules/week6/" class="sidebar-link">Week 6: Object Data Modelling</a></li><li><a href="/W2022/modules/week7/" class="sidebar-link">Week 7: Data security</a></li><li><a href="/W2022/modules/break-week/" class="sidebar-link">Break Week</a></li><li><a href="/W2022/modules/week9/" class="sidebar-link">Week 9: Access Control with JWT</a></li><li><a href="/W2022/modules/week10/" class="sidebar-link">Week 10: JWT Review</a></li><li><a href="/W2022/modules/week11/" class="sidebar-link">Week 11: Consistent Error Handling</a></li><li><a href="/W2022/modules/week12/" class="sidebar-link">Week 12: Production Preparation</a></li><li><a href="/W2022/modules/week13/" class="sidebar-link">Week 13: Testing</a></li><li><a href="/W2022/modules/week14/" class="sidebar-link">Week 14: Production Deployment</a></li><li><a href="/W2022/modules/week15/" class="sidebar-link">Week 15: Final Lab</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1><span class="week">Week 4</span><br> <span class="title">Middleware functions</span></h1> <div class="custom-block danger"><p class="custom-block-title">Quiz 3: RESTful APIs <span class="badge tip" style="vertical-align:top;" data-v-15b7b770>20 mins</span></p> <p>There will be a quiz today. It will be worth 2% of your final grade.</p></div> <div class="custom-block warning"><p class="custom-block-title">Assignment Reminder</p> <p><a href="/W2022/deliverables/assignment1.html">Assignment 1 - Basic CRUD</a> - is due next week.</p></div> <h2 id="agenda"><a href="#agenda" class="header-anchor">#</a> Agenda</h2> <ul><li>AMA (10 min)</li> <li>Quiz (20 min)</li> <li>What is middleware? (15 min)</li> <li>Common use cases (5 min)
<ul><li>Built-in middleware</li> <li>Community developed middleware</li></ul></li> <li>EX4-1 Router Module (30 mins)</li> <li>EX4-2 Project Folder Structure (5 mins)</li> <li>EX4-3 carId Validator Middleware (30 mins)</li> <li>Introduce Assignment 1: Basic CRUD (5 mins)</li></ul> <h2 id="review"><a href="#review" class="header-anchor">#</a> Review</h2> <p>The solution to last week's in-class exercise follows a similar pattern as the update methods. In fact the bulk of the code is a direct copy and paste. It is only the code in the else block that is different.</p> <div class="language-js extra-class"><div class="highlight-lines"><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><br><br><br></div><pre class="language-js"><code>app<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span><span class="token string">'/api/cars/:carId'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> carId <span class="token operator">=</span> <span class="token function">parseInt</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>params<span class="token punctuation">.</span>carId<span class="token punctuation">)</span>
  <span class="token keyword">const</span> index <span class="token operator">=</span> cars<span class="token punctuation">.</span><span class="token function">findIndex</span><span class="token punctuation">(</span><span class="token parameter">car</span> <span class="token operator">=&gt;</span> car<span class="token punctuation">.</span>id <span class="token operator">===</span> carId<span class="token punctuation">)</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>index <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">404</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      errors<span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span>
          status<span class="token operator">:</span> <span class="token string">'Not Found'</span><span class="token punctuation">,</span>
          code<span class="token operator">:</span> <span class="token string">'404'</span><span class="token punctuation">,</span>
          title<span class="token operator">:</span> <span class="token string">'Resource does not exist'</span><span class="token punctuation">,</span>
          description<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">We could not find a car with id: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>carId<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">]</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> deletedCar <span class="token operator">=</span> cars<span class="token punctuation">[</span>index<span class="token punctuation">]</span>
    cars<span class="token punctuation">.</span><span class="token function">splice</span><span class="token punctuation">(</span>index<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
    res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">{</span>data<span class="token operator">:</span> deletedCar<span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>We save a copy of the car object that we are about to remove from the collection, so that we can send as confirmation in the response data. Then use the <code>array.splice()</code> method to cut out the element at index position <code>index</code> that we looked up in the earlier <code>if</code> block.</p> <p><strong>To slice() or to splice() ... that is the question.</strong></p> <p>Don't worry if you get these two array methods confused, most people do. When you're not sure, check the docs ...</p> <blockquote><p>The <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Array/slice" target="_blank" rel="noopener noreferrer">slice()<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> method returns a shallow copy of a portion of an array into a new array object selected from begin to end (end not included). <strong>The original array will not be modified.</strong></p></blockquote> <blockquote><p>The <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Array/splice" target="_blank" rel="noopener noreferrer">splice()<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> method <strong>changes the contents of an array</strong> by removing or replacing existing elements and/or adding new elements.</p></blockquote> <h2 id="what-is-middleware"><a href="#what-is-middleware" class="header-anchor">#</a> What is middleware</h2> <p>Middleware functions are used to encapsulate functionality that you want to apply to multiple routes without repeating the code in every route handler. They run before the route handlers are evaluated and may be chained together. Each middleware function can either end the request or pass control to the next function in the pipeline, until the final route handler is reached.</p> <p><img src="/W2022/assets/img/middleware-pipeline.44b69194.jpeg" alt="middleware pipeline"></p> <p><a href="https://expressjs.com/en/guide/writing-middleware.html" target="_blank" rel="noopener noreferrer">From the docs ...<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <blockquote><p>Middleware functions are functions that have access to the request object (req), the response object (res), and the next function in the application’s request-response cycle. The next function is a function in the Express router which, when invoked, executes the middleware succeeding the current middleware.</p></blockquote> <p>Middleware functions can perform the following tasks:</p> <ul><li>Execute any code.</li> <li>Make changes to the request and the response objects.</li> <li>End the request-response cycle.</li> <li>Call the next middleware in the stack.</li></ul> <h3 id="middleware-function-signature"><a href="#middleware-function-signature" class="header-anchor">#</a> Middleware function signature</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token function-variable function">myMiddleware</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// validate something</span>
  <span class="token comment">// if fail, return error to client</span>
  <span class="token comment">// if OK, call next()</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="types-of-middleware"><a href="#types-of-middleware" class="header-anchor">#</a> Types of middleware</h3> <p>An Express application can use the following types of middleware:</p> <ul><li>Application-level middleware</li> <li>Router-level middleware</li> <li>Error-handling middleware
<ul><li>different function signature</li></ul></li> <li>Built-in middleware
<ul><li>express.json()</li> <li>express.urlencoded()</li> <li>express.static</li></ul></li> <li>Third-party middleware
<ul><li><a href="https://www.npmjs.com/search?q=express%20middleware" target="_blank" rel="noopener noreferrer">over 5000 packages on NPM<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></li></ul> <h3 id="common-use-cases"><a href="#common-use-cases" class="header-anchor">#</a> Common use cases</h3> <ul><li>router modules</li> <li>validation</li> <li>error handling</li> <li>image handling</li> <li>enforcing security best practices</li></ul> <h3 id="timestamp-logger"><a href="#timestamp-logger" class="header-anchor">#</a> Timestamp Logger</h3> <p>This is a simple example of a middleware function that logs the requested resource path and the time of the request. It is invoked on the main express app with no route qualifier, so it will apply to all incoming HTTP requests.</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'express'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> <span class="token function-variable function">timestampLogger</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>req<span class="token punctuation">.</span>path<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> requested at </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
  <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>timestampLogger<span class="token punctuation">)</span>
</code></pre></div><p>This was a trivial example of an access log middleware. A more production ready solution can be found in the popular third-party module called <a href="https://expressjs.com/en/resources/middleware/morgan.html" target="_blank" rel="noopener noreferrer">morgan<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>. It is easily added to your project like this ...</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token function">npm</span> <span class="token function">install</span> morgan
</code></pre></div><div class="language-js extra-class"><div class="highlight-lines"><br><div class="highlighted"> </div><br><br><br><div class="highlighted"> </div><br><br><br></div><pre class="language-js"><code><span class="token comment">// app.js</span>
<span class="token keyword">const</span> morgan <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'morgan'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'express'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">morgan</span><span class="token punctuation">(</span><span class="token string">'tiny'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment">// rest of your app config.</span>
</code></pre></div><h3 id="router-modules"><a href="#router-modules" class="header-anchor">#</a> Router modules</h3> <p>A special kind of middleware is the <a href="https://expressjs.com/en/4x/api.html#router" target="_blank" rel="noopener noreferrer">Router<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> Module.</p> <blockquote><p>A router object is an isolated instance of middleware and routes. You can think of it as a “mini-application,” capable only of performing middleware and routing functions. Every Express application has a built-in app router.</p></blockquote> <blockquote><p>A router behaves like middleware itself, so you can use it as an argument to app.use() or as the argument to another router’s use() method.</p></blockquote> <h2 id="ex4-1-router-module"><a href="#ex4-1-router-module" class="header-anchor">#</a> EX4-1 Router Module</h2> <div class="custom-block tip"><p class="custom-block-title">Objective</p> <p>Move all of the existing route handler methods (like <code>app.get</code> or <code>app.post</code>) from the main app.js file to a separate <code>carsRouter.js</code> Router module.</p></div> <p>Picking up from last week's <em>Express CRUD</em> exercise, create a new GitHub repo called <code>mad9124-w21-ex4-middleware</code> and import this <a href="https://github.com/MAD9124/mad9124-w21-ex4-middleware" target="_blank" rel="noopener noreferrer">starter repo<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>.</p> <img src="/W2022/assets/img/screenshot-github-import.e5c6a728.png" alt="" class="screenshot"> <p>Add your professor (<code>rlmckenney</code>) as a collaborator. Then clone your new repo to your laptop in the code folder for this course.</p> <div class="custom-block warning"><p class="custom-block-title">Install dependencies</p> <p>This starter repo has dependencies defined in the <code>package.json</code> file. Before we go any further, you need to run <code>npm install</code> in the terminal of the project folder to download and install them.</p></div> <p>We will refactor the Express CRUD RESTful API routes into a separate <a href="https://expressjs.com/en/4x/api.html#router" target="_blank" rel="noopener noreferrer">Router<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> module.</p> <p>Create a new file in the project folder called <code>carsRouter.js</code> and in that file, create a new <code>express.Router</code> object.</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'express'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> router <span class="token operator">=</span> express<span class="token punctuation">.</span><span class="token function">Router</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><p>This <code>router</code> will have all of the same HTTP verb methods that our main <code>app</code> object has. So, when we copy the methods over from <code>app.js</code>, substitute <code>router</code> for <code>app</code> like this ...</p> <div class="language-js extra-class"><div class="highlight-lines"><br><div class="highlighted"> </div><br><br><br><br><div class="highlighted"> </div><br><br><br></div><pre class="language-js"><code><span class="token comment">// old code</span>
app<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/api/cars'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span>data<span class="token operator">:</span> cars<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">car</span> <span class="token operator">=&gt;</span> <span class="token function">formatResponseData</span><span class="token punctuation">(</span><span class="token string">'cars'</span><span class="token punctuation">,</span> car<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">// becomes new code</span>
router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span>data<span class="token operator">:</span> cars<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">car</span> <span class="token operator">=&gt;</span> <span class="token function">formatResponseData</span><span class="token punctuation">(</span><span class="token string">'cars'</span><span class="token punctuation">,</span> car<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>Notice that the route path above is just <code>/</code>, whereas it was <code>/api/cars</code> before. That is because all of the resource paths in this router module are relative to the root path of <code>/api/cars</code> which will be set in the main <code>app.js</code> module.when we tell our express app to use this router. We will set this up shortly.</p> <p>Similarly, route paths with named route parameters will look like this ...</p> <div class="language-js extra-class"><div class="highlight-lines"><div class="highlighted"> </div><br><br><br><br><br><br><br><br></div><pre class="language-js"><code>router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/:carId'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> id <span class="token operator">=</span> <span class="token function">parseInt</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>params<span class="token punctuation">.</span>carId<span class="token punctuation">)</span>
  <span class="token keyword">const</span> car <span class="token operator">=</span> cars<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token parameter">car</span> <span class="token operator">=&gt;</span> car<span class="token punctuation">.</span>id <span class="token operator">===</span> id<span class="token punctuation">)</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>car<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">/* shortened for brevity */</span>
  <span class="token punctuation">}</span>
  res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span>data<span class="token operator">:</span> <span class="token function">formatResponseData</span><span class="token punctuation">(</span><span class="token string">'cars'</span><span class="token punctuation">,</span> car<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><div class="custom-block tip"><p class="custom-block-title">Your task</p> <p>Update the rest of the route handler methods accordingly.</p></div> <p>Don't forget, we need to export the <code>router</code> object from this module. Add the <code>module.exports</code> line at the bottom of the <code>carsRouter.js</code> file.</p> <div class="language-js extra-class"><pre class="language-js"><code>module<span class="token punctuation">.</span>exports <span class="token operator">=</span> router
</code></pre></div><p>Now, back in <code>app.js</code>, we need to import the new <code>carsRouter</code> object and tell the express <code>app</code> object to <code>use</code> it for all resource routes starting with <code>/api/cars</code></p> <p>App.js should now look like this ...</p> <div class="language-js extra-class"><div class="highlight-lines"><br><br><br><br><br><div class="highlighted"> </div><br><br><br><br><br><br><br><div class="highlighted"> </div><br><br><br><br></div><pre class="language-js"><code><span class="token string">'use strict'</span>

<span class="token comment">// load dependencies</span>
<span class="token keyword">const</span> morgan <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'morgan'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'express'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> carsRouter <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./carsRouter.js'</span><span class="token punctuation">)</span>

<span class="token comment">// create the express app</span>
<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment">// configure express middleware</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">morgan</span><span class="token punctuation">(</span><span class="token string">'tiny'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>express<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token string">'/api/cars'</span><span class="token punctuation">,</span> carsRouter<span class="token punctuation">)</span>

<span class="token keyword">const</span> port <span class="token operator">=</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span>port <span class="token operator">||</span> <span class="token number">3030</span>
app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span>port<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Server listening on port </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>port<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> ...</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><p>Notice that we are no longer importing the <code>cars</code> collection data in <code>app.js</code>. This should be private data in our <code>carsRouter</code> module. Let's load it at the top of the <code>carsRouter.js</code> file.</p> <div class="language-js extra-class"><div class="highlight-lines"><div class="highlighted"> </div><br><br><br></div><pre class="language-js"><code><span class="token keyword">const</span> <span class="token punctuation">{</span>cars<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./cars.js'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'express'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> router <span class="token operator">=</span> express<span class="token punctuation">.</span><span class="token function">Router</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><h4 id="that-should-do-it-let-s-test-it-with-postman"><a href="#that-should-do-it-let-s-test-it-with-postman" class="header-anchor">#</a> That should do it! Let's test it with Postman.</h4> <p>Run a full set of tests on all of the six <code>/api/cars</code> resource routes.</p> <h4 id="commit-your-work"><a href="#commit-your-work" class="header-anchor">#</a> Commit your work</h4> <p>If everything is working, create a new <code>git commit</code> with the message, &quot;Refactor /api/cars routes into a dedicated router module.&quot;</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token function">git</span> <span class="token function">add</span> -A
<span class="token function">git</span> commit -m <span class="token string">&quot;Refactor /api/cars routes into a dedicated router module.&quot;</span>
</code></pre></div><h2 id="ex4-2-project-folder-structure"><a href="#ex4-2-project-folder-structure" class="header-anchor">#</a> EX4-2 Project Folder Structure</h2> <div class="custom-block tip"><p class="custom-block-title">Let's get organized</p> <p>Its time to start organizing our project folder structure.</p></div> <p>As our application grows in features and complexity, it is a good practice to organize the various modules of our application into sub-folders. This makes it much easier to navigate and find the correct module when we need to make changes.</p> <p>To get started, create a new <code>routes</code> folder and move the <code>carsRouter.js</code> file into that new folder. The common practice is to name the files in the routes folder by the name of the resource path. So, rename <code>carsRouter.js</code> to <code>cars.js</code>.</p> <p>Now create a new folder called <code>data</code> and move the <code>cars.js</code> file into that new folder and rename it <code>index.js</code>.</p> <p>Don't forget to update the relative paths for your <code>require()</code> functions to point to the correct sub-folders. e.g.</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// in the /routes/cars.js file</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span>cars<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../data'</span><span class="token punctuation">)</span>

<span class="token comment">// in the /app.js file</span>
<span class="token keyword">const</span> carsRouter <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./routes/cars.js'</span><span class="token punctuation">)</span>
</code></pre></div><p>Create one more folder called <code>middleware</code>. We will add our custom middleware modules here starting with the <code>validateId.js</code> that we will create in the next section.</p> <p>Our reorganized project file structure should now look like this ...</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token builtin class-name">.</span>
├── app.js
├── package.json
├── data
│   └── index.js
├── middleware
│   └── validateId.js
└── routes
    └── cars.js
</code></pre></div><h4 id="test-and-commit"><a href="#test-and-commit" class="header-anchor">#</a> Test and Commit</h4> <p>Test all of the routes with Postman, and if everything is still working, create a new <code>git commit</code>.</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token function">git</span> <span class="token function">add</span> <span class="token builtin class-name">.</span>
<span class="token function">git</span> commit -m <span class="token string">&quot;Refactor folder structure.&quot;</span>
</code></pre></div><h2 id="ex4-3-carid-validator-middleware"><a href="#ex4-3-carid-validator-middleware" class="header-anchor">#</a> EX4-3 carId Validator Middleware</h2> <div class="custom-block tip"><p class="custom-block-title">Objective</p> <p>Instead of repeating the block of code to check for a valid <code>carId</code> on every route, we can move that to a middleware function and greatly simplify the implementation logic.</p></div> <p>Create a new file called <code>validateCarId.js</code> in the <code>middleware</code> folder. Then scaffold out the basic signature for a middleware module. Remember, it is almost the same as the route handler callback functions, but has a third argument - the <code>next()</code> function.</p> <p>We will also need access to the cars collection, so require the cars data at the top of our middleware module.</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token punctuation">{</span>cars<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../data'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> <span class="token function-variable function">validateCarId</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> validateCarId
</code></pre></div><p>OK, now we can copy the carId validation logic from one of our route handlers and paste it into the validateCarId function. Most of it can be copied unchanged. Only the <code>else</code> block needs to be updated. If the <code>carId</code> was valid, we want to make the index position available to our route handlers as a property on the request object - so that it does not have to be looked up again.</p> <p>Simply declare a new property on the <code>req</code> object and assign the <code>index</code> value to it.</p> <div class="language-js extra-class"><pre class="language-js"><code>req<span class="token punctuation">.</span>carIndex <span class="token operator">=</span> index
</code></pre></div><p>The last thing to do is call the <code>next()</code> method, to tell express that it can move on to the next middleware function or route handler.</p> <p>The complete <em>validateCarId.js</em> middleware module should now look like this.</p> <div class="language-js extra-class"><div class="highlight-lines"><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><div class="highlighted"> </div><div class="highlighted"> </div><br><br><br><br><br></div><pre class="language-js"><code><span class="token keyword">const</span> <span class="token punctuation">{</span>cars<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../data'</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> <span class="token function-variable function">validateCarId</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> id <span class="token operator">=</span> <span class="token function">parseInt</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>params<span class="token punctuation">.</span>carId<span class="token punctuation">)</span>
  <span class="token keyword">const</span> index <span class="token operator">=</span> cars<span class="token punctuation">.</span><span class="token function">findIndex</span><span class="token punctuation">(</span><span class="token parameter">car</span> <span class="token operator">=&gt;</span> car<span class="token punctuation">.</span>id <span class="token operator">===</span> id<span class="token punctuation">)</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>index <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">404</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      errors<span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span>
          status<span class="token operator">:</span> <span class="token string">'404'</span><span class="token punctuation">,</span>
          title<span class="token operator">:</span> <span class="token string">'Resource does not exist'</span><span class="token punctuation">,</span>
          description<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">We could not find a car with id: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>id<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">]</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    req<span class="token punctuation">.</span>carIndex <span class="token operator">=</span> index
    <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> validateCarId
</code></pre></div><p>To use this new custom middleware function, we need to require it in the cars router module and then tell the <code>router</code> object to <code>use</code> the middleware on all routes with a <code>:carId</code> route parameter.</p> <p>The top of <em>/router/cars.js</em> should look like this ...</p> <div class="language-js extra-class"><div class="highlight-lines"><br><div class="highlighted"> </div><br><br><br><div class="highlighted"> </div><br></div><pre class="language-js"><code><span class="token keyword">const</span> <span class="token punctuation">{</span>cars<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../data'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> validateCarId <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../middleware/validateCarId'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'express'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> router <span class="token operator">=</span> express<span class="token punctuation">.</span><span class="token function">Router</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

router<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token string">'/:carId'</span><span class="token punctuation">,</span> validateCarId<span class="token punctuation">)</span>
</code></pre></div><p>We can remove the now redundant carId validation checks in the <code>get</code>, <code>put</code>, <code>patch</code> and <code>delete</code> functions. Since we no longer have a local <code>index</code> variable in these functions, we need to make some minor updates to utilize the <code>req.carIndex</code> property that the middleware function created.</p> <div class="language-js extra-class"><pre class="language-js"><code>router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/:carId'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">{</span>data<span class="token operator">:</span> <span class="token function">formatResponseData</span><span class="token punctuation">(</span>cars<span class="token punctuation">[</span>req<span class="token punctuation">.</span>carIndex<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

router<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">'/:carId'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> updatedCar <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token operator">...</span>req<span class="token punctuation">.</span>body<span class="token operator">?.</span>data<span class="token operator">?.</span>attributes<span class="token punctuation">,</span>
    id<span class="token operator">:</span> <span class="token function">parseInt</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>params<span class="token punctuation">.</span>carId<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  cars<span class="token punctuation">[</span>req<span class="token punctuation">.</span>carIndex<span class="token punctuation">]</span> <span class="token operator">=</span> updatedCar
  res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span>data<span class="token operator">:</span> <span class="token function">formatResponseData</span><span class="token punctuation">(</span><span class="token string">'cars'</span><span class="token punctuation">,</span> updatedCar<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

router<span class="token punctuation">.</span><span class="token function">patch</span><span class="token punctuation">(</span><span class="token string">'/:carId'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> updatedCar <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">assign</span><span class="token punctuation">(</span>
    <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    cars<span class="token punctuation">[</span>req<span class="token punctuation">.</span>carIndex<span class="token punctuation">]</span><span class="token punctuation">,</span>
    req<span class="token punctuation">.</span>body<span class="token operator">?.</span>data<span class="token operator">?.</span>attributes<span class="token punctuation">,</span>
    <span class="token punctuation">{</span>id<span class="token operator">:</span> <span class="token function">parseInt</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>params<span class="token punctuation">.</span>carId<span class="token punctuation">)</span><span class="token punctuation">}</span>
  <span class="token punctuation">)</span>
  cars<span class="token punctuation">[</span>req<span class="token punctuation">.</span>carIndex<span class="token punctuation">]</span> <span class="token operator">=</span> updatedCar
  res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span>data<span class="token operator">:</span> <span class="token function">formatResponseData</span><span class="token punctuation">(</span><span class="token string">'cars'</span><span class="token punctuation">,</span> updatedCar<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

router<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span><span class="token string">'/:carId'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> deletedCar <span class="token operator">=</span> cars<span class="token punctuation">.</span><span class="token function">splice</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>carIndex<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
  res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    data<span class="token operator">:</span> <span class="token function">formatResponseData</span><span class="token punctuation">(</span><span class="token string">'cars'</span><span class="token punctuation">,</span> deletedCar<span class="token punctuation">)</span><span class="token punctuation">,</span>
    meta<span class="token operator">:</span> <span class="token punctuation">{</span>message<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Car with id: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>req<span class="token punctuation">.</span>params<span class="token punctuation">.</span>carId<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> successfully deleted.</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h4 id="test-and-commit-2"><a href="#test-and-commit-2" class="header-anchor">#</a> Test and Commit</h4> <p>Test all of the routes with Postman, and if everything is still working, create a new <code>git commit</code>.</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token function">git</span> <span class="token function">add</span> <span class="token builtin class-name">.</span>
<span class="token function">git</span> commit -m <span class="token string">&quot;Refactor cars router to use carId validator middleware.&quot;</span>
</code></pre></div><p>Push your commits up to the remote GitHub repo, and submit the GitHub repo's URL on BrightSpace.</p> <h2 id="for-next-week"><a href="#for-next-week" class="header-anchor">#</a> For next week</h2> <div class="custom-block warning"><p class="custom-block-title">Assignment Reminder</p> <p><a href="/W2022/deliverables/assignment1.html">Assignment 1 - Basic CRUD</a> - is due <strong>before</strong> the start of next class.</p></div> <p>Before next week's class, please read these additional online resources.</p> <ul><li><p><a href="https://expressjs.com/en/guide/using-middleware.html" target="_blank" rel="noopener noreferrer">Express Guide: Using Middleware<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></li> <li><p><a href="https://expressjs.com/en/guide/writing-middleware.html" target="_blank" rel="noopener noreferrer">Express Guide: Writing Middleware<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></li> <li><p><a href="https://hackernoon.com/middleware-the-core-of-node-js-apps-ab01fee39200" target="_blank" rel="noopener noreferrer">Middleware: THE core of node.js backend apps<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></li></ul> <div class="custom-block warning"><p class="custom-block-title">Quiz</p> <p>There will be a short quiz next class. The questions could come from any of the material referenced above.</p></div></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">2/6/2022, 8:45:53 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/W2022/modules/week3/" class="prev">
        Week 3: RESTful APIs
      </a></span> <span class="next"><a href="/W2022/modules/week5/">
        Week 5: Data persistence
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/W2022/assets/js/app.cec51691.js" defer></script><script src="/W2022/assets/js/3.9c2ff4f7.js" defer></script><script src="/W2022/assets/js/21.e5b3b049.js" defer></script><script src="/W2022/assets/js/11.f11acbbb.js" defer></script><script src="/W2022/assets/js/16.1ec56656.js" defer></script>
  </body>
</html>
