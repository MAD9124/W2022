<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Week 11: Consistent Error Handling | MAD9124</title>
    <meta name="generator" content="VuePress 1.7.1">
    
    <meta name="description" content="Full Stack: API Development">
    
    <link rel="preload" href="/W2022/assets/css/0.styles.7a32498c.css" as="style"><link rel="preload" href="/W2022/assets/js/app.cec51691.js" as="script"><link rel="preload" href="/W2022/assets/js/3.9c2ff4f7.js" as="script"><link rel="preload" href="/W2022/assets/js/19.61d8cc80.js" as="script"><link rel="preload" href="/W2022/assets/js/11.f11acbbb.js" as="script"><link rel="preload" href="/W2022/assets/js/16.1ec56656.js" as="script"><link rel="prefetch" href="/W2022/assets/js/10.31dfe672.js"><link rel="prefetch" href="/W2022/assets/js/12.96649c49.js"><link rel="prefetch" href="/W2022/assets/js/13.535bc82d.js"><link rel="prefetch" href="/W2022/assets/js/14.028cb9d2.js"><link rel="prefetch" href="/W2022/assets/js/15.ced8bd8c.js"><link rel="prefetch" href="/W2022/assets/js/17.a48a571a.js"><link rel="prefetch" href="/W2022/assets/js/18.1528acad.js"><link rel="prefetch" href="/W2022/assets/js/2.b4d63df3.js"><link rel="prefetch" href="/W2022/assets/js/20.4071399f.js"><link rel="prefetch" href="/W2022/assets/js/21.e5b3b049.js"><link rel="prefetch" href="/W2022/assets/js/22.8b4aae43.js"><link rel="prefetch" href="/W2022/assets/js/23.61c52980.js"><link rel="prefetch" href="/W2022/assets/js/24.55bc8f66.js"><link rel="prefetch" href="/W2022/assets/js/25.4ac50e54.js"><link rel="prefetch" href="/W2022/assets/js/26.9ce0e977.js"><link rel="prefetch" href="/W2022/assets/js/27.3a9bd92a.js"><link rel="prefetch" href="/W2022/assets/js/28.06fd6a07.js"><link rel="prefetch" href="/W2022/assets/js/29.1bb95a0c.js"><link rel="prefetch" href="/W2022/assets/js/30.dae4692c.js"><link rel="prefetch" href="/W2022/assets/js/31.8fbfd6d3.js"><link rel="prefetch" href="/W2022/assets/js/32.68c3574f.js"><link rel="prefetch" href="/W2022/assets/js/33.617cdd3b.js"><link rel="prefetch" href="/W2022/assets/js/34.e9d21a2b.js"><link rel="prefetch" href="/W2022/assets/js/35.6e9bfe39.js"><link rel="prefetch" href="/W2022/assets/js/36.d4810b3d.js"><link rel="prefetch" href="/W2022/assets/js/37.8f7eb267.js"><link rel="prefetch" href="/W2022/assets/js/38.23784716.js"><link rel="prefetch" href="/W2022/assets/js/39.2e9e7983.js"><link rel="prefetch" href="/W2022/assets/js/4.a3d079e3.js"><link rel="prefetch" href="/W2022/assets/js/40.7f13d575.js"><link rel="prefetch" href="/W2022/assets/js/5.3200619b.js"><link rel="prefetch" href="/W2022/assets/js/6.4a9ec533.js"><link rel="prefetch" href="/W2022/assets/js/7.f496cd23.js"><link rel="prefetch" href="/W2022/assets/js/8.0225588a.js"><link rel="prefetch" href="/W2022/assets/js/9.665b29a5.js">
    <link rel="stylesheet" href="/W2022/assets/css/0.styles.7a32498c.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/W2022/" class="home-link router-link-active"><!----> <span class="site-name">MAD9124</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/W2022/overview/" class="nav-link">
  Overview
</a></div><div class="nav-item"><a href="/W2022/modules/" class="nav-link router-link-active">
  Modules
</a></div><div class="nav-item"><a href="/W2022/deliverables/" class="nav-link">
  Deliverables
</a></div><div class="nav-item"><a href="/W2022/resources/" class="nav-link">
  Resources
</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/W2022/overview/" class="nav-link">
  Overview
</a></div><div class="nav-item"><a href="/W2022/modules/" class="nav-link router-link-active">
  Modules
</a></div><div class="nav-item"><a href="/W2022/deliverables/" class="nav-link">
  Deliverables
</a></div><div class="nav-item"><a href="/W2022/resources/" class="nav-link">
  Resources
</a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Introduction</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Deliverables</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>Content Modules</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/W2022/modules/" aria-current="page" class="sidebar-link">Table of contents</a></li><li><a href="/W2022/modules/week1/" class="sidebar-link">Week 1: Introduction &amp; Review</a></li><li><a href="/W2022/modules/week2/" class="sidebar-link">Week 2: Node Modules &amp; Express</a></li><li><a href="/W2022/modules/week3/" class="sidebar-link">Week 3: RESTful APIs</a></li><li><a href="/W2022/modules/week4/" class="sidebar-link">Week 4: Middleware functions</a></li><li><a href="/W2022/modules/week5/" class="sidebar-link">Week 5: Data persistence</a></li><li><a href="/W2022/modules/week6/" class="sidebar-link">Week 6: Object Data Modelling</a></li><li><a href="/W2022/modules/week7/" class="sidebar-link">Week 7: Data security</a></li><li><a href="/W2022/modules/break-week/" class="sidebar-link">Break Week</a></li><li><a href="/W2022/modules/week9/" class="sidebar-link">Week 9: Access Control with JWT</a></li><li><a href="/W2022/modules/week10/" class="sidebar-link">Week 10: JWT Review</a></li><li><a href="/W2022/modules/week11/" aria-current="page" class="active sidebar-link">Week 11: Consistent Error Handling</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/W2022/modules/week11/#agenda" class="sidebar-link">Agenda</a></li><li class="sidebar-sub-header"><a href="/W2022/modules/week11/#enhanced-validation" class="sidebar-link">Enhanced Validation</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/W2022/modules/week11/#unique-properties" class="sidebar-link">Unique properties</a></li><li class="sidebar-sub-header"><a href="/W2022/modules/week11/#email-address-format" class="sidebar-link">Email address format</a></li><li class="sidebar-sub-header"><a href="/W2022/modules/week11/#timestamps" class="sidebar-link">Timestamps</a></li><li class="sidebar-sub-header"><a href="/W2022/modules/week11/#setter-functions" class="sidebar-link">Setter Functions</a></li></ul></li><li class="sidebar-sub-header"><a href="/W2022/modules/week11/#express-error-handler-middleware" class="sidebar-link">Express Error Handler Middleware</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/W2022/modules/week11/#validation-error" class="sidebar-link">Validation error</a></li><li class="sidebar-sub-header"><a href="/W2022/modules/week11/#refactor-router-modules" class="sidebar-link">Refactor Router Modules</a></li><li class="sidebar-sub-header"><a href="/W2022/modules/week11/#error-logging" class="sidebar-link">Error Logging</a></li><li class="sidebar-sub-header"><a href="/W2022/modules/week11/#register-the-error-handlers" class="sidebar-link">Register the error handlers</a></li></ul></li><li class="sidebar-sub-header"><a href="/W2022/modules/week11/#custom-exception-classes" class="sidebar-link">Custom Exception Classes</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/W2022/modules/week11/#resource-not-found" class="sidebar-link">Resource not found</a></li></ul></li><li class="sidebar-sub-header"><a href="/W2022/modules/week11/#final-project-requirements" class="sidebar-link">Final project requirements</a></li><li class="sidebar-sub-header"><a href="/W2022/modules/week11/#for-next-week" class="sidebar-link">For next week</a></li></ul></li><li><a href="/W2022/modules/week12/" class="sidebar-link">Week 12: Production Preparation</a></li><li><a href="/W2022/modules/week13/" class="sidebar-link">Week 13: Testing</a></li><li><a href="/W2022/modules/week14/" class="sidebar-link">Week 14: Production Deployment</a></li><li><a href="/W2022/modules/week15/" class="sidebar-link">Week 15: Final Lab</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1><span class="week">Week 11</span><br> <span class="title">Consistent Error Handling</span></h1> <div class="custom-block danger"><p class="custom-block-title">Quiz 7: JWT Authentication <span class="badge tip" style="vertical-align:top;" data-v-15b7b770>15 mins</span></p> <p>There will be a quiz today. It will be worth 2% of your final grade.</p></div> <div class="custom-block danger"><p class="custom-block-title">Assignment Due</p> <p>Assignment 3 - Authentication - is due <strong>before</strong> 06:00 pm on Monday, March 28th.<br>
It is worth 10% of your final grade.</p></div> <h2 id="agenda"><a href="#agenda" class="header-anchor">#</a> Agenda</h2> <ul><li>AMA (5 mins)</li> <li>Quiz 7 - Authentication (20 mins)</li> <li>Break (5 mins)</li> <li>Enhanced Validation (40 mins)</li> <li>Break (10 mins)</li> <li>Error Handling Middleware (50 mins)</li> <li>Break (10 mins)</li> <li>Review Final Project (15 mins)</li> <li>Lab Time</li></ul> <h2 id="enhanced-validation"><a href="#enhanced-validation" class="header-anchor">#</a> Enhanced Validation</h2> <h3 id="unique-properties"><a href="#unique-properties" class="header-anchor">#</a> Unique properties</h3> <p>Last time we looked at how to manually check if a property value, like email, has already been stored in the target collection. We used the Mongoose <code>.countDocuments()</code> method in the route handler. While it is important to understand how and why that works, there is a better way to handle this.</p> <p>In a larger application, we may well have several properties with a <code>unique: true</code> constraint set in the schema, so a common middleware function would be a good idea. We also talked about the <em>OOP Expert Principle</em> and this kind of validation check really belongs in the Model class.</p> <p>As it happens there is a Mongoose schema plugin made just for this use case. It is called <a href="https://www.npmjs.com/package/mongoose-unique-validator" target="_blank" rel="noopener noreferrer">mongoose-unique-validator<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>. Let's install it in our project.</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">npm</span> <span class="token function">install</span> mongoose-unique-validator
</code></pre></div><p>Then we can implement it in the <code>/models/User</code> module. Import it at the top and then register the plugin right near the bottom, after all of the other <code>schema</code> definition code, but before creating and exporting the <code>Model</code>.</p> <div class="language-js extra-class"><div class="highlight-lines"><div class="highlighted"> </div><br><br><br><div class="highlighted"> </div><br><br><br><br><br></div><pre class="language-js"><code><span class="token keyword">import</span> uniqueValidator <span class="token keyword">from</span> <span class="token string">'mongoose-unique-validator'</span>

<span class="token comment">// ... the rest of the code we already had</span>

schema<span class="token punctuation">.</span><span class="token function">plugin</span><span class="token punctuation">(</span>uniqueValidator<span class="token punctuation">)</span>

<span class="token comment">// register the plugin before these last two lines</span>
<span class="token keyword">const</span> Model <span class="token operator">=</span> mongoose<span class="token punctuation">.</span><span class="token function">model</span><span class="token punctuation">(</span><span class="token string">'User'</span><span class="token punctuation">,</span> schema<span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> Model
</code></pre></div><p>The <code>schema.plugin()</code> method takes two arguments: the plugin module and an optional configuration object. Among other things, the configuration object let's us set a custom error message.</p> <p>The <code>message</code> property can be set to either a string or a function that returns a string. Create a function that returns a specific message for <code>email</code> properties and a generic message for any other property with a <code>unique: true</code> schema setting.</p> <div class="language-js extra-class"><pre class="language-js"><code>schema<span class="token punctuation">.</span><span class="token function">plugin</span><span class="token punctuation">(</span>uniqueValidator<span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token function-variable function">message</span><span class="token operator">:</span> <span class="token parameter">props</span> <span class="token operator">=&gt;</span>
    props<span class="token punctuation">.</span>path <span class="token operator">===</span> <span class="token string">'email'</span>
      <span class="token operator">?</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">The email address '</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>props<span class="token punctuation">.</span>value<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">' is already registered.</span><span class="token template-punctuation string">`</span></span>
      <span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">The </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>props<span class="token punctuation">.</span>path<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> must be unique. '</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>props<span class="token punctuation">.</span>value<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">' is already in use.</span><span class="token template-punctuation string">`</span></span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><div class="custom-block warning"><p class="custom-block-title">Alternate Syntax</p> <p>The code block above is combining arrow function syntax and the ternary operator. It could also be written out in more verbose syntax like this ...</p> <div class="language-js extra-class"><pre class="language-js"><code>schema<span class="token punctuation">.</span><span class="token function">plugin</span><span class="token punctuation">(</span>uniqueValidator<span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token function-variable function">message</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">props</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>props<span class="token punctuation">.</span>path <span class="token operator">===</span> <span class="token string">'email'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">The email address '</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>props<span class="token punctuation">.</span>value<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">' is already registered.</span><span class="token template-punctuation string">`</span></span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">The </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>props<span class="token punctuation">.</span>path<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> must be unique. '</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>props<span class="token punctuation">.</span>value<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">' is already in use.</span><span class="token template-punctuation string">`</span></span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div></div> <h3 id="email-address-format"><a href="#email-address-format" class="header-anchor">#</a> Email address format</h3> <p>While we are looking at the <code>email</code> property, it would be nice if there was a simple way to validate that the given email address is in fact a correctly formatted email. We could go read the RFC spec and figure out a complicated RegEx comparison, but ... you guessed it. Somebody has already done the hard work.</p> <p>There is a widely used NPM library called <a href="https://www.npmjs.com/package/validator" target="_blank" rel="noopener noreferrer">validator<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> that among many other options, has a reliable method for checking email addresses. Go ahead and add it as a dependency for your project.</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">npm</span> <span class="token function">install</span> validator
</code></pre></div><p><strong>Don't forget to import <code>validator</code> at the top of your User model module.</strong></p> <p>Now you can use it in a custom validation method on your schema. <a href="https://mongoosejs.com/docs/validation.html#custom-validators" target="_blank" rel="noopener noreferrer">According to the documentation<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>, Mongoose allows us to set a function as the value for the <code>validate</code> property, or if we want to set a custom error message, we can set an object with both a <code>validator</code> function that returns a boolean and a <code>message</code> function that returns a string. This is the approach that we will take.</p> <div class="language-js extra-class"><div class="highlight-lines"><br><br><br><br><br><br><br><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><br><br><br></div><pre class="language-js"><code><span class="token keyword">const</span> schema <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">mongoose<span class="token punctuation">.</span>Schema</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token comment">// ...other props</span>
  email<span class="token operator">:</span> <span class="token punctuation">{</span>
    type<span class="token operator">:</span> String<span class="token punctuation">,</span>
    trim<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    required<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    unique<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    validate<span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token function-variable function">validator</span><span class="token operator">:</span> <span class="token parameter">value</span> <span class="token operator">=&gt;</span> validator<span class="token punctuation">.</span><span class="token function">isEmail</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function-variable function">message</span><span class="token operator">:</span> <span class="token parameter">props</span> <span class="token operator">=&gt;</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>props<span class="token punctuation">.</span>value<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> is not a valid email address.</span><span class="token template-punctuation string">`</span></span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="timestamps"><a href="#timestamps" class="header-anchor">#</a> Timestamps</h3> <p>Another common schema requirement is to have the application automatically set two timestamp properties on the document object: <code>createdAt</code> and <code>updatedAt</code>.</p> <p>This is easily accomplished with Mongoose by setting <code>timestamps: true</code> in the optional second argument to the Schema constructor function. This <a href="https://mongoosejs.com/docs/guide.html#options" target="_blank" rel="noopener noreferrer">options object<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> has nearly 2 dozen settings to modify the default behaviour of our document schema.</p> <p>Turn on the <a href="https://mongoosejs.com/docs/guide.html#timestamps" target="_blank" rel="noopener noreferrer">timestamps option<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> for the User model.</p> <div class="language-js extra-class"><div class="highlight-lines"><br><br><br><br><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><br><br></div><pre class="language-js"><code><span class="token keyword">const</span> schema <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">mongoose<span class="token punctuation">.</span>Schema</span><span class="token punctuation">(</span>
  <span class="token punctuation">{</span>
    <span class="token comment">// all of the property definitions and validators</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    timestamps<span class="token operator">:</span> <span class="token boolean">true</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">)</span>
</code></pre></div><h3 id="setter-functions"><a href="#setter-functions" class="header-anchor">#</a> Setter Functions</h3> <p>It is a very common software design pattern to intercept values as they are assigned to an object's property, and do some extra processing on it before actually storing the final value. You can read more about using <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Functions/set" target="_blank" rel="noopener noreferrer">Setter Functions<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> in plain JavaScript objects at MDN Docs.</p> <p>The Mongoose schema definition makes it simple to define <a href="https://mongoosejs.com/docs/api.html#schematype_SchemaType-set" target="_blank" rel="noopener noreferrer">setter methods<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> that can transform the input data before it is stored in MongoDB, or before using it in a query. This is better illustrated with a couple of examples.</p> <h4 id="normalize-email"><a href="#normalize-email" class="header-anchor">#</a> Normalize Email</h4> <p>When storing a user's email address, particularly if using it as their username for authentication, it is a good practice to always convert it lower case. e.g. &quot;MICKEY.Mouse@Disney.com&quot; should be stored <em>and compared</em> as &quot;mickey.mouse@disney.com&quot;.</p> <p>We can add a setter function to do this.</p> <div class="language-js extra-class"><div class="highlight-lines"><br><br><br><br><br><br><br><div class="highlighted"> </div><br><br><br><br><br><br><br></div><pre class="language-js"><code><span class="token keyword">const</span> schema <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">mongoose<span class="token punctuation">.</span>Schema</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  email<span class="token operator">:</span> <span class="token punctuation">{</span>
    type<span class="token operator">:</span> String<span class="token punctuation">,</span>
    trim<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    maxlength<span class="token operator">:</span> <span class="token number">512</span><span class="token punctuation">,</span>
    required<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    unique<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token function-variable function">set</span><span class="token operator">:</span> <span class="token parameter">value</span> <span class="token operator">=&gt;</span> value<span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    validate<span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token function-variable function">validator</span><span class="token operator">:</span> <span class="token parameter">value</span> <span class="token operator">=&gt;</span> validator<span class="token punctuation">.</span><span class="token function">isEmail</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function-variable function">message</span><span class="token operator">:</span> <span class="token parameter">props</span> <span class="token operator">=&gt;</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>props<span class="token punctuation">.</span>value<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> is not a valid email address.</span><span class="token template-punctuation string">`</span></span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h4 id="force-integer"><a href="#force-integer" class="header-anchor">#</a> Force Integer</h4> <p>The <code>Number</code> type in Mongoose, like JavaScript, can hold integers or floating point values. There are times when we need to be sure that the value stored is in fact an integer -- for example, when storing monetary values for a credit card payment system like Stripe.</p> <p>We can add a setter function to always round up to the next integer so that &quot;100.01&quot; cents would be stored as &quot;101&quot; cents.</p> <div class="language-js extra-class"><div class="highlight-lines"><br><br><br><br><br><div class="highlighted"> </div><br><br><br></div><pre class="language-js"><code><span class="token keyword">const</span> schema <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">mongoose<span class="token punctuation">.</span>Schema</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  price<span class="token operator">:</span> <span class="token punctuation">{</span>
    type<span class="token operator">:</span> Number<span class="token punctuation">,</span>
    min<span class="token operator">:</span> <span class="token number">100</span><span class="token punctuation">,</span>
    required<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token function-variable function">set</span><span class="token operator">:</span> <span class="token parameter">value</span> <span class="token operator">=&gt;</span> Math<span class="token punctuation">.</span><span class="token function">ceil</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><div class="custom-block tip"><p class="custom-block-title">Break</p> <p>Take a walk. Refill your coffee. We'll continue in 10 minutes.</p></div> <h2 id="express-error-handler-middleware"><a href="#express-error-handler-middleware" class="header-anchor">#</a> Express Error Handler Middleware</h2> <p>OK. So now you have better input validation in your Mongoose Models, but most of the code examples that we have seen so far are not giving the client helpful error messages. We have been masking them in generic &quot;500 Server Error&quot; messages.</p> <p>It is time to fix that!</p> <p>Express let's you define special <em>error handler middleware</em> to help clean up the route handlers and ensure consistent response formatting. When some other middleware function calls <code>next(error)</code> passing an error object as a argument, Express will short-circuit the request pipeline and jump to the first registered error handler middleware function.</p> <div class="custom-block tip"><p class="custom-block-title">Function Signature</p> <p>Express error handler middleware functions look just like ordinary middleware, but with one extra argument – the <code>err</code> argument.</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">handleError</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token operator">...</span> <span class="token punctuation">}</span>
</code></pre></div></div> <p>Great, but how does that help with our route handler functions? Well, remember when I told you that almost everything in Express is a middleware function? That includes route handlers. We just have to add the <code>next</code> argument to the function signature.</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// this</span>
router<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/auth/users'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> <span class="token operator">...</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment">// becomes</span>
router<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/auth/users'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> <span class="token operator">...</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>OK. OK. OK. Let's build the thing!</p> <p>Create a new file called <code>errorHandler.js</code> in the <code>/middleware</code> folder and add this starter code that will implement a default &quot;500 Server Error&quot;.</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token function-variable function">formatServerError</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      status<span class="token operator">:</span> <span class="token string">'500'</span><span class="token punctuation">,</span>
      title<span class="token operator">:</span> <span class="token string">'Server error'</span><span class="token punctuation">,</span>
      description<span class="token operator">:</span> err<span class="token operator">?.</span>message <span class="token operator">||</span> <span class="token string">'Please check the logs'</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">handleError</span><span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> code <span class="token operator">=</span> <span class="token number">500</span>
  <span class="token keyword">const</span> payload <span class="token operator">=</span> <span class="token function">formatServerError</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>

  res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span>code<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span>errors<span class="token operator">:</span> payload<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="validation-error"><a href="#validation-error" class="header-anchor">#</a> Validation error</h3> <p>Now let's add in some logic to check for <a href="https://mongoosejs.com/docs/validation.html#validation-errors" target="_blank" rel="noopener noreferrer">Mongoose validation errors<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> and format them according to the <a href="https://jsonapi.org/format/#errors" target="_blank" rel="noopener noreferrer">JSON:API specification<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>.</p> <blockquote><p>Mongoose errors returned after failed validation contain an <code>errors</code> object whose values are <code>ValidatorError</code> objects. Each ValidatorError has <code>kind</code>, <code>path</code>, <code>value</code>, and <code>message</code> properties.</p></blockquote> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// An example Mongoose errors object might look like this</span>

error <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token comment">// ... some other properties</span>
  errors<span class="token operator">:</span> <span class="token punctuation">{</span>
    password<span class="token operator">:</span> <span class="token punctuation">{</span>
      message<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">'password' is required</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
      kind<span class="token operator">:</span> <span class="token string">'Invalid password'</span><span class="token punctuation">,</span>
      path<span class="token operator">:</span> <span class="token string">'password'</span><span class="token punctuation">,</span>
      value<span class="token operator">:</span> <span class="token string">''</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    email<span class="token operator">:</span> <span class="token punctuation">{</span>
      message<span class="token operator">:</span> <span class="token string">&quot;The email address 'm.mouse@disney.com' is already registered.&quot;</span><span class="token punctuation">,</span>
      kind<span class="token operator">:</span> <span class="token string">'Invalid email'</span><span class="token punctuation">,</span>
      path<span class="token operator">:</span> <span class="token string">'email'</span><span class="token punctuation">,</span>
      value<span class="token operator">:</span> <span class="token string">'m.mouse@disney.com'</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>We need to iterate over those ValidatorError objects and transform them into the JSON:API format that would look like this.</p> <div class="language-js extra-class"><pre class="language-js"><code>errors <span class="token operator">=</span> <span class="token punctuation">[</span>
  <span class="token punctuation">{</span>
    status<span class="token operator">:</span> <span class="token string">'400'</span><span class="token punctuation">,</span>
    title<span class="token operator">:</span> <span class="token string">'Validation Error'</span><span class="token punctuation">,</span>
    detail<span class="token operator">:</span> <span class="token string">&quot;'password' is required&quot;</span><span class="token punctuation">,</span>
    source<span class="token operator">:</span> <span class="token punctuation">{</span>pointer<span class="token operator">:</span> <span class="token string">'/data/attributes/password'</span><span class="token punctuation">,</span> value<span class="token operator">:</span> <span class="token string">''</span><span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    status<span class="token operator">:</span> <span class="token string">'400'</span><span class="token punctuation">,</span>
    title<span class="token operator">:</span> <span class="token string">'Validation Error'</span><span class="token punctuation">,</span>
    detail<span class="token operator">:</span> <span class="token string">&quot;The email address 'm.mouse@disney.com' is already registered.&quot;</span><span class="token punctuation">,</span>
    source<span class="token operator">:</span> <span class="token punctuation">{</span>pointer<span class="token operator">:</span> <span class="token string">'/data/attributes/email'</span><span class="token punctuation">,</span> value<span class="token operator">:</span> <span class="token string">'m.mouse@disney.com'</span><span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">]</span>
</code></pre></div><p>We can use JavaScript's <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_objects/Object/values" target="_blank" rel="noopener noreferrer">Object.values()<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> method to extract the various ValidatorError objects into an array and then use the <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Array/map" target="_blank" rel="noopener noreferrer">Array.map()<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> method to loop over them and return a new array of properly formatted error objects.</p> <p>At the top of the module, create a helper function to do the formatting.</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token function-variable function">formatValidationError</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">errors</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> Object<span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span>errors<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">e</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span><span class="token punctuation">{</span>
    status<span class="token operator">:</span> <span class="token string">'400'</span><span class="token punctuation">,</span>
    title<span class="token operator">:</span> <span class="token string">'Validation Error'</span><span class="token punctuation">,</span>
    detail<span class="token operator">:</span> e<span class="token punctuation">.</span>message<span class="token punctuation">,</span>
    source<span class="token operator">:</span> <span class="token punctuation">{</span>pointer<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">/data/attributes/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>e<span class="token punctuation">.</span>path<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> value<span class="token operator">:</span> e<span class="token punctuation">.</span>value<span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Now in your main error handler function you need to check if the error that was passed-in is a Mongoose validation error and if so, call the formatter function that you just created to set the <code>payload</code> variable. Otherwise, treat it as a generic <code>500 - Server Error</code>.</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">handleError</span><span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> isValidationError <span class="token operator">=</span> err<span class="token operator">?.</span>name <span class="token operator">===</span> <span class="token string">'ValidationError'</span>
  <span class="token keyword">const</span> code <span class="token operator">=</span> isValidationError <span class="token operator">?</span> <span class="token number">400</span> <span class="token operator">:</span> <span class="token number">500</span>

  <span class="token keyword">let</span> payload
  <span class="token keyword">if</span> <span class="token punctuation">(</span>code <span class="token operator">===</span> <span class="token number">400</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    payload <span class="token operator">=</span> <span class="token function">formatValidationError</span><span class="token punctuation">(</span>err<span class="token punctuation">.</span>errors<span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    payload <span class="token operator">=</span> <span class="token function">formatServerError</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span>code<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span>errors<span class="token operator">:</span> payload<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="custom-block tip"><p class="custom-block-title">Optional Chaining Syntax</p> <p>The code above uses the <code>?.</code> <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Operators/Optional_chaining" target="_blank" rel="noopener noreferrer">optional chaining operator<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> that was added to JavaScript with ES2020. This significantly simplifies checking values of nested object properties, where the intermediate properties may not be set.</p> <p>Without optional chaining you have have to explicitly check if the err object had a name property before checking its value. e.g.</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> isValidationError <span class="token operator">=</span>
  err<span class="token punctuation">.</span><span class="token function">hasOwnProperty</span><span class="token punctuation">(</span><span class="token string">'name'</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> err<span class="token punctuation">.</span>name <span class="token operator">===</span> <span class="token string">'ValidationError'</span>
</code></pre></div></div> <p>Almost done. What about other kinds of errors — e.g. a resource not found error?</p> <p>Let's add an option to the <code>code</code> assignment that checks if the <code>err</code> object has a <code>code</code> property. If it does use that instead of the default '500', and assume that it is a plain JavaScript error object which should be wrapped in an array.</p> <p><img src="/W2022/assets/img/ternary-expression-with-default-value.9f56af5a.png" alt="const code = isValidationError ? 400 : err.code || 500"></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">handleError</span><span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> isValidationError <span class="token operator">=</span> err<span class="token operator">?.</span>name <span class="token operator">===</span> <span class="token string">'ValidationError'</span>
  <span class="token keyword">const</span> code <span class="token operator">=</span> isValidationError <span class="token operator">?</span> <span class="token number">400</span> <span class="token operator">:</span> err<span class="token punctuation">.</span>code <span class="token operator">||</span> <span class="token number">500</span>

  <span class="token keyword">let</span> payload <span class="token operator">=</span> <span class="token punctuation">[</span>err<span class="token punctuation">]</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>code <span class="token operator">===</span> <span class="token number">400</span><span class="token punctuation">)</span> payload <span class="token operator">=</span> <span class="token function">formatValidationErrors</span><span class="token punctuation">(</span>err<span class="token punctuation">.</span>errors<span class="token punctuation">)</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>code <span class="token operator">===</span> <span class="token number">500</span><span class="token punctuation">)</span> payload <span class="token operator">=</span> <span class="token function">formatServerError</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>

  res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span>code<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">{</span>errors<span class="token operator">:</span> payload<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="refactor-router-modules"><a href="#refactor-router-modules" class="header-anchor">#</a> Refactor Router Modules</h3> <p>That is looking good, but we still need to update the route handlers to take advantage of this new capability. Refactor the &quot;register user&quot; route handler from last week.</p> <h4 id="before"><a href="#before" class="header-anchor">#</a> Before</h4> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// Register a new user</span>
router<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/users'</span><span class="token punctuation">,</span> sanitizeBody<span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> newUser <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>sanitizedBody<span class="token punctuation">)</span>
    <span class="token keyword">const</span> itExists <span class="token operator">=</span> <span class="token function">Boolean</span><span class="token punctuation">(</span><span class="token keyword">await</span> User<span class="token punctuation">.</span><span class="token function">countDocuments</span><span class="token punctuation">(</span><span class="token punctuation">{</span>email<span class="token operator">:</span> newUser<span class="token punctuation">.</span>email<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>itExists<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">400</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        errors<span class="token operator">:</span> <span class="token punctuation">[</span>
          <span class="token punctuation">{</span>
            status<span class="token operator">:</span> <span class="token string">'400'</span><span class="token punctuation">,</span>
            title<span class="token operator">:</span> <span class="token string">'Validation Error'</span><span class="token punctuation">,</span>
            detail<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Email address '</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>newUser<span class="token punctuation">.</span>email<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">' is already registered.</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
            source<span class="token operator">:</span> <span class="token punctuation">{</span>pointer<span class="token operator">:</span> <span class="token string">'/data/attributes/email'</span><span class="token punctuation">}</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">]</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">await</span> newUser<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">201</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token function">formatResponseData</span><span class="token punctuation">(</span>newUser<span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">'Error saving new user: '</span><span class="token punctuation">,</span> err<span class="token punctuation">.</span>message<span class="token punctuation">)</span>
    res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      errors<span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span>
          status<span class="token operator">:</span> <span class="token string">'500'</span><span class="token punctuation">,</span>
          title<span class="token operator">:</span> <span class="token string">'Problem saving document to the database.'</span>
          description<span class="token operator">:</span> err<span class="token punctuation">.</span>message
        <span class="token punctuation">}</span>
      <span class="token punctuation">]</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h4 id="changes-to-this-code"><a href="#changes-to-this-code" class="header-anchor">#</a> Changes to this code</h4> <ol><li><p>Update the function arguments to accept the <code>next</code> function being passed in.</p></li> <li><p>Now that you are using the <strong>mongoose-unique-validator</strong> plugin, drop the unique validation check in the route handler.</p></li> <li><p>Simplify the <code>catch</code> block by calling <code>next(err)</code> instead of defining and sending the error response here.</p></li></ol> <h4 id="after"><a href="#after" class="header-anchor">#</a> After</h4> <details class="custom-block details"><summary>Try it on your own before looking at the solution</summary> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// Register a new user</span>
router<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/users'</span><span class="token punctuation">,</span> sanitizeBody<span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> newUser <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>sanitizedBody<span class="token punctuation">)</span>
    <span class="token keyword">await</span> newUser<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">201</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token function">formatResponseData</span><span class="token punctuation">(</span>newUser<span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">'Error saving new user: '</span><span class="token punctuation">,</span> err<span class="token punctuation">.</span>message<span class="token punctuation">)</span>
    <span class="token function">next</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div></details> <p>Much simpler, but we're not quite done. There are two more steps.</p> <h3 id="error-logging"><a href="#error-logging" class="header-anchor">#</a> Error Logging</h3> <p>There is another repetitive part of error handling that we can eliminate. Notice that <code>debug</code> statement in the catch block. Instead of writing that out every time we are going to call <code>next(err)</code>, we can create another error handler function to do this automatically.</p> <p>This makes it much easier to change how you log these errors in the future. You may want to use a logger middleware like <a href="https://www.npmjs.com/package/winston" target="_blank" rel="noopener noreferrer">Winston<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>. Or you may want to use a third party service like <a href="https://www.bugsnag.com/" target="_blank" rel="noopener noreferrer">bugsnag<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>, <a href="https://www2.logrocket.com/" target="_blank" rel="noopener noreferrer">LogRocket<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> or <a href="https://rollbar.com/" target="_blank" rel="noopener noreferrer">Rollbar<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>. It is much easier to change if the logging is being managed from a middleware function.</p> <p>A simple implementation would be to use <code>debug</code> to write the error to the console and then call <code>next(err)</code> to pass control to the next error handler function. Create a new module called <code>logErrors.js</code> in the <code>/middleware</code> folder.</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> createDebug <span class="token keyword">from</span> <span class="token string">'debug'</span>
<span class="token keyword">const</span> debug <span class="token operator">=</span> <span class="token function">createDebug</span><span class="token punctuation">(</span><span class="token string">'errorLog'</span><span class="token punctuation">)</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">logError</span><span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">debug</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
  <span class="token function">next</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Now you can simplify your route handler even more ...</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// Register a new user</span>
router<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/users'</span><span class="token punctuation">,</span> sanitizeBody<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>sanitizedBody<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">newUser</span> <span class="token operator">=&gt;</span> res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">201</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token function">formatResponseData</span><span class="token punctuation">(</span>newUser<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span>next<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p><strong>We are down to six lines of code from the 31 that we started with!</strong></p> <p>That is more than an 80% reduction and a real win for readability and maintainability.</p> <p><img src="/W2022/assets/img/middleware-for-the-win.e37dc0cb.jpg" alt="middleware for the win!"></p> <h3 id="register-the-error-handlers"><a href="#register-the-error-handlers" class="header-anchor">#</a> Register the error handlers</h3> <p>Before you try to test this out, you need to put the two new middleware functions into action.</p> <p>In the main application module, <strong>app.js</strong>, add the two new error handler middleware functions to the end of the request handling pipeline. You want to apply them globally, so there is no route path argument.</p> <div class="custom-block warning"><p class="custom-block-title">Important</p> <p>Make sure that the error handlers middleware functions are <strong>registered last</strong> after all of the other middleware and route handlers.</p></div> <div class="language-js extra-class"><div class="highlight-lines"><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><div class="highlighted"> </div><div class="highlighted"> </div><br><br><br></div><pre class="language-js"><code><span class="token keyword">import</span> morgan <span class="token keyword">from</span> <span class="token string">'morgan'</span>
<span class="token keyword">import</span> express <span class="token keyword">from</span> <span class="token string">'express'</span>
<span class="token keyword">import</span> sanitizeMongo <span class="token keyword">from</span> <span class="token string">'express-mongo-sanitize'</span>
<span class="token keyword">import</span> logError <span class="token keyword">from</span> <span class="token string">'./middleware/logError.js'</span>
<span class="token keyword">import</span> handleError <span class="token keyword">from</span> <span class="token string">'./middleware/handleError.js'</span>
<span class="token keyword">import</span> authRouter <span class="token keyword">from</span> <span class="token string">'./routes/auth/index.js'</span>
<span class="token keyword">import</span> carsRouter <span class="token keyword">from</span> <span class="token string">'./routes/cars.js'</span>
<span class="token keyword">import</span> peopleRouter <span class="token keyword">from</span> <span class="token string">'./routes/people.js'</span>

<span class="token keyword">import</span> connectDatabase <span class="token keyword">from</span> <span class="token string">'./startup/connectDatabase.js'</span>
<span class="token function">connectDatabase</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment">// Middleware</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">morgan</span><span class="token punctuation">(</span><span class="token string">'tiny'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>express<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">sanitizeMongo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment">// Route handlers</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token string">'/auth'</span><span class="token punctuation">,</span> authRouter<span class="token punctuation">)</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token string">'/api/cars'</span><span class="token punctuation">,</span> carsRouter<span class="token punctuation">)</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token string">'/api/people'</span><span class="token punctuation">,</span> peopleRouter<span class="token punctuation">)</span>

<span class="token comment">// Error handlers</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>logError<span class="token punctuation">)</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>handleError<span class="token punctuation">)</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> app
</code></pre></div><div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>The multiple imports in this module could be streamlined by setting-up re-exporters in the <code>routes</code> and <code>middleware</code> folders.</p></div> <h2 id="custom-exception-classes"><a href="#custom-exception-classes" class="header-anchor">#</a> Custom Exception Classes</h2> <p>For common errors that you might want to throw from several places in the application, you can extend the standard <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Error" target="_blank" rel="noopener noreferrer">JavaScript Error class<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>.</p> <h3 id="resource-not-found"><a href="#resource-not-found" class="header-anchor">#</a> Resource not found</h3> <p>For example, you could standardize the error that is passed to your new error handler middleware for <em>resource not found</em> exceptions.</p> <p>Create a new top level folder in your project called <code>exceptions</code>. Create a new module file in that folder called <code>ResourceNotFound.js</code>.</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">class</span> <span class="token class-name">ResourceNotFoundException</span> <span class="token keyword">extends</span> <span class="token class-name">Error</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>args</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">)</span>
    Error<span class="token punctuation">.</span><span class="token function">captureStackTrace</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> ResourceNotFoundException<span class="token punctuation">)</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>code <span class="token operator">=</span> <span class="token number">404</span> <span class="token comment">// this will trigger correct handling by our middleware</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token string">'404'</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>title <span class="token operator">=</span> <span class="token string">'Resource does not exist'</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>description <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>message
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> ResourceNotFoundException
</code></pre></div><div class="custom-block warning"><p class="custom-block-title">Stack trace API</p> <p>This is available only in the V8 runtime engine used in Node.js and the Chrome browser. You can read more detail about the <a href="https://v8.dev/docs/stack-trace-api" target="_blank" rel="noopener noreferrer">Stack trace API<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> in the V8 Dev Docs.</p></div> <p>With that new custom exception defined, you can refactor the implementation of your route handler code from this ...</p> <div class="language-js extra-class"><pre class="language-js"><code>router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/:id'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> car <span class="token operator">=</span> <span class="token keyword">await</span> Car<span class="token punctuation">.</span><span class="token function">findById</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>params<span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">populate</span><span class="token punctuation">(</span><span class="token string">'owner'</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>car<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'Resource not found'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">{</span>data<span class="token operator">:</span> car<span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">sendResourceNotFound</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>to this ...</p> <div class="language-js extra-class"><div class="highlight-lines"><div class="highlighted"> </div><br><br><br><br><br><div class="highlighted"> </div><br><br><br><div class="highlighted"> </div><br><br><br><br><br></div><pre class="language-js"><code><span class="token keyword">import</span> ResourceNotFoundError <span class="token keyword">from</span> <span class="token string">'../exceptions/ResourceNotFound'</span>

router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/:id'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> car <span class="token operator">=</span> <span class="token keyword">await</span> Car<span class="token punctuation">.</span><span class="token function">findById</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>params<span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">populate</span><span class="token punctuation">(</span><span class="token string">'owner'</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>car<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ResourceNotFoundError</span><span class="token punctuation">(</span>
        <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">We could not find a car with id: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>req<span class="token punctuation">.</span>params<span class="token punctuation">.</span>id<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span>
      <span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token function">formatResponseData</span><span class="token punctuation">(</span>car<span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">next</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>You no longer need the <code>sendResourceNotFoundError()</code> helper function at the bottom of your route handler modules and you will no longer accidentally mask other errors by allowing the error handler middleware to correctly format and return the errors.</p> <div class="custom-block tip"><p class="custom-block-title">Break</p> <p>Take a walk. Refill your coffee. We'll continue in 10 minutes.</p></div> <h2 id="final-project-requirements"><a href="#final-project-requirements" class="header-anchor">#</a> Final project requirements</h2> <p>The <a href="/W2022/deliverables/final.html">final project</a> will be a two part joint assignment between MAD9124 and MAD9022. You will build a complete full-stack solution. The web service API portion will be graded for MAD9124, and the front-end application functionality, design, and usability will be graded for MAD9022.</p> <h2 id="for-next-week"><a href="#for-next-week" class="header-anchor">#</a> For next week</h2> <p>Before next week's class, please read these additional online resources.</p> <ul><li><p><a href="https://mongoosejs.com/docs/validation.html#validation-errors" target="_blank" rel="noopener noreferrer">Mongoose Validation Errors<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></li> <li><p><a href="https://mongoosejs.com/docs/validation.html#validation-errors" target="_blank" rel="noopener noreferrer">NPM Validator Docs<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></li> <li><p><a href="http://javascript.info/keys-values-entries" target="_blank" rel="noopener noreferrer">JavaScript Object.values<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></li> <li><p><a href="https://javascript.info/array-methods" target="_blank" rel="noopener noreferrer">JavaScript Array.map<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></li> <li><p><a href="https://www.youtube.com/watch?v=VmicKaGcs5g" target="_blank" rel="noopener noreferrer">Object keys, values, and entries methods<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> (video)</p></li> <li><p><a href="https://www.youtube.com/watch?v=hfYa4ugeyuc" target="_blank" rel="noopener noreferrer">Array.map<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> (video)</p></li></ul> <div class="custom-block warning"><p class="custom-block-title">Quiz</p> <p>There will be a short quiz next class. The questions could come from any of the material referenced above.</p></div></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">3/21/2022, 4:45:28 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/W2022/modules/week10/" class="prev">
        Week 10: JWT Review
      </a></span> <span class="next"><a href="/W2022/modules/week12/">
        Week 12: Production Preparation
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/W2022/assets/js/app.cec51691.js" defer></script><script src="/W2022/assets/js/3.9c2ff4f7.js" defer></script><script src="/W2022/assets/js/19.61d8cc80.js" defer></script><script src="/W2022/assets/js/11.f11acbbb.js" defer></script><script src="/W2022/assets/js/16.1ec56656.js" defer></script>
  </body>
</html>
