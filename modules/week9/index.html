<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Week 9: Access Control with JWT | MAD9124</title>
    <meta name="generator" content="VuePress 1.7.1">
    
    <meta name="description" content="Full Stack: API Development">
    
    <link rel="preload" href="/W2022/assets/css/0.styles.7a32498c.css" as="style"><link rel="preload" href="/W2022/assets/js/app.cec51691.js" as="script"><link rel="preload" href="/W2022/assets/js/3.9c2ff4f7.js" as="script"><link rel="preload" href="/W2022/assets/js/10.31dfe672.js" as="script"><link rel="preload" href="/W2022/assets/js/11.f11acbbb.js" as="script"><link rel="preload" href="/W2022/assets/js/16.1ec56656.js" as="script"><link rel="prefetch" href="/W2022/assets/js/12.96649c49.js"><link rel="prefetch" href="/W2022/assets/js/13.535bc82d.js"><link rel="prefetch" href="/W2022/assets/js/14.028cb9d2.js"><link rel="prefetch" href="/W2022/assets/js/15.ced8bd8c.js"><link rel="prefetch" href="/W2022/assets/js/17.a48a571a.js"><link rel="prefetch" href="/W2022/assets/js/18.1528acad.js"><link rel="prefetch" href="/W2022/assets/js/19.61d8cc80.js"><link rel="prefetch" href="/W2022/assets/js/2.b4d63df3.js"><link rel="prefetch" href="/W2022/assets/js/20.4071399f.js"><link rel="prefetch" href="/W2022/assets/js/21.e5b3b049.js"><link rel="prefetch" href="/W2022/assets/js/22.8b4aae43.js"><link rel="prefetch" href="/W2022/assets/js/23.61c52980.js"><link rel="prefetch" href="/W2022/assets/js/24.55bc8f66.js"><link rel="prefetch" href="/W2022/assets/js/25.4ac50e54.js"><link rel="prefetch" href="/W2022/assets/js/26.9ce0e977.js"><link rel="prefetch" href="/W2022/assets/js/27.3a9bd92a.js"><link rel="prefetch" href="/W2022/assets/js/28.06fd6a07.js"><link rel="prefetch" href="/W2022/assets/js/29.1bb95a0c.js"><link rel="prefetch" href="/W2022/assets/js/30.dae4692c.js"><link rel="prefetch" href="/W2022/assets/js/31.8fbfd6d3.js"><link rel="prefetch" href="/W2022/assets/js/32.68c3574f.js"><link rel="prefetch" href="/W2022/assets/js/33.617cdd3b.js"><link rel="prefetch" href="/W2022/assets/js/34.e9d21a2b.js"><link rel="prefetch" href="/W2022/assets/js/35.6e9bfe39.js"><link rel="prefetch" href="/W2022/assets/js/36.d4810b3d.js"><link rel="prefetch" href="/W2022/assets/js/37.8f7eb267.js"><link rel="prefetch" href="/W2022/assets/js/38.23784716.js"><link rel="prefetch" href="/W2022/assets/js/39.2e9e7983.js"><link rel="prefetch" href="/W2022/assets/js/4.a3d079e3.js"><link rel="prefetch" href="/W2022/assets/js/40.7f13d575.js"><link rel="prefetch" href="/W2022/assets/js/5.3200619b.js"><link rel="prefetch" href="/W2022/assets/js/6.4a9ec533.js"><link rel="prefetch" href="/W2022/assets/js/7.f496cd23.js"><link rel="prefetch" href="/W2022/assets/js/8.0225588a.js"><link rel="prefetch" href="/W2022/assets/js/9.665b29a5.js">
    <link rel="stylesheet" href="/W2022/assets/css/0.styles.7a32498c.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/W2022/" class="home-link router-link-active"><!----> <span class="site-name">MAD9124</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/W2022/overview/" class="nav-link">
  Overview
</a></div><div class="nav-item"><a href="/W2022/modules/" class="nav-link router-link-active">
  Modules
</a></div><div class="nav-item"><a href="/W2022/deliverables/" class="nav-link">
  Deliverables
</a></div><div class="nav-item"><a href="/W2022/resources/" class="nav-link">
  Resources
</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/W2022/overview/" class="nav-link">
  Overview
</a></div><div class="nav-item"><a href="/W2022/modules/" class="nav-link router-link-active">
  Modules
</a></div><div class="nav-item"><a href="/W2022/deliverables/" class="nav-link">
  Deliverables
</a></div><div class="nav-item"><a href="/W2022/resources/" class="nav-link">
  Resources
</a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Introduction</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Deliverables</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>Content Modules</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/W2022/modules/" aria-current="page" class="sidebar-link">Table of contents</a></li><li><a href="/W2022/modules/week1/" class="sidebar-link">Week 1: Introduction &amp; Review</a></li><li><a href="/W2022/modules/week2/" class="sidebar-link">Week 2: Node Modules &amp; Express</a></li><li><a href="/W2022/modules/week3/" class="sidebar-link">Week 3: RESTful APIs</a></li><li><a href="/W2022/modules/week4/" class="sidebar-link">Week 4: Middleware functions</a></li><li><a href="/W2022/modules/week5/" class="sidebar-link">Week 5: Data persistence</a></li><li><a href="/W2022/modules/week6/" class="sidebar-link">Week 6: Object Data Modelling</a></li><li><a href="/W2022/modules/week7/" class="sidebar-link">Week 7: Data security</a></li><li><a href="/W2022/modules/break-week/" class="sidebar-link">Break Week</a></li><li><a href="/W2022/modules/week9/" aria-current="page" class="active sidebar-link">Week 9: Access Control with JWT</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/W2022/modules/week9/#agenda" class="sidebar-link">Agenda</a></li><li class="sidebar-sub-header"><a href="/W2022/modules/week9/#ex8-authentication-authorization" class="sidebar-link">EX8 Authentication &amp; Authorization</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/W2022/modules/week9/#auth-router" class="sidebar-link">Auth Router</a></li><li class="sidebar-sub-header"><a href="/W2022/modules/week9/#register-a-new-user" class="sidebar-link">Register a new user</a></li><li class="sidebar-sub-header"><a href="/W2022/modules/week9/#encrypt-password" class="sidebar-link">Encrypt password</a></li><li class="sidebar-sub-header"><a href="/W2022/modules/week9/#unique-email" class="sidebar-link">Unique email</a></li><li class="sidebar-sub-header"><a href="/W2022/modules/week9/#login-a-user" class="sidebar-link">Login a user</a></li><li class="sidebar-sub-header"><a href="/W2022/modules/week9/#create-a-jwt" class="sidebar-link">Create a JWT</a></li><li class="sidebar-sub-header"><a href="/W2022/modules/week9/#custom-instance-methods" class="sidebar-link">Custom instance methods</a></li><li class="sidebar-sub-header"><a href="/W2022/modules/week9/#custom-class-methods" class="sidebar-link">Custom class methods</a></li><li class="sidebar-sub-header"><a href="/W2022/modules/week9/#schema-lifecycle-hooks" class="sidebar-link">Schema lifecycle hooks</a></li><li class="sidebar-sub-header"><a href="/W2022/modules/week9/#protected-routes" class="sidebar-link">Protected routes</a></li><li class="sidebar-sub-header"><a href="/W2022/modules/week9/#redact-sensitive-data" class="sidebar-link">Redact Sensitive Data</a></li><li class="sidebar-sub-header"><a href="/W2022/modules/week9/#submit-your-work" class="sidebar-link">Submit your work</a></li></ul></li><li class="sidebar-sub-header"><a href="/W2022/modules/week9/#for-next-week" class="sidebar-link">For next week</a></li></ul></li><li><a href="/W2022/modules/week10/" class="sidebar-link">Week 10: JWT Review</a></li><li><a href="/W2022/modules/week11/" class="sidebar-link">Week 11: Consistent Error Handling</a></li><li><a href="/W2022/modules/week12/" class="sidebar-link">Week 12: Production Preparation</a></li><li><a href="/W2022/modules/week13/" class="sidebar-link">Week 13: Testing</a></li><li><a href="/W2022/modules/week14/" class="sidebar-link">Week 14: Production Deployment</a></li><li><a href="/W2022/modules/week15/" class="sidebar-link">Week 15: Final Lab</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1><span class="week">Week 9</span><br> <span class="title">Access Control with JWT</span></h1> <div class="custom-block danger"><p class="custom-block-title">Assignment Due</p> <p>Assignment 2 - Mongo CRUD - is due <strong>before</strong> 06:00 pm on Wednesday, March 9th.<br>
It is worth 10% of your final grade.</p></div> <div class="custom-block danger"><p class="custom-block-title">Quiz 6: Data Sanitization <span class="badge tip" style="vertical-align:top;" data-v-15b7b770>20 mins</span></p> <p>There will be a quiz today. It will be worth 2% of your final grade.</p></div> <h2 id="agenda"><a href="#agenda" class="header-anchor">#</a> Agenda</h2> <ul><li>AMA (5 mins)</li> <li>Quiz (20 mins)</li> <li><em>Break (5 mins)</em></li> <li>Register new users (30 mins)</li> <li><em>Break (5 mins)</em></li> <li>Login a user (30 mins)</li> <li><em>Break (5 mins)</em></li> <li>OOP Information Expert Principle (30 mins)</li> <li><em>Break (5 mins)</em></li> <li>Authentication guard middleware (30 mins)</li></ul> <h2 id="ex8-authentication-authorization"><a href="#ex8-authentication-authorization" class="header-anchor">#</a> EX8 Authentication &amp; Authorization</h2> <div class="custom-block tip"><p class="custom-block-title">Objective</p> <p>Create the modules necessary to support user registration and authentication.</p></div> <p>We will pick-up where we left off before the break week. Create a new GitHub repo and import this <a href="https://github.com/MAD9124/mad9124-w21-ex8-auth" target="_blank" rel="noopener noreferrer">starter repo<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> for a working version of the code from that exercise.</p> <h3 id="auth-router"><a href="#auth-router" class="header-anchor">#</a> Auth Router</h3> <p>It is a common practice to separate the authentication related routes from the main API routes. This has several advantages. Chief among them is making it easier to extract user management into a separate micro service or delegate it to a third party web service like <a href="https://aws.amazon.com/cognito/" target="_blank" rel="noopener noreferrer">AWS Cognito<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> or <a href="https://auth0.com/" target="_blank" rel="noopener noreferrer">Auth0<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>.</p> <p>Start by creating a new folder in the <code>/routes</code> folder called <code>auth</code>. In that new folder, create a new module called <code>index.js</code> with this placeholder content. We will use this initial code to prove that everything is wired-up correctly and then come back to add the real application logic.</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> express <span class="token keyword">from</span> <span class="token string">'express'</span>
<span class="token keyword">const</span> router <span class="token operator">=</span> express<span class="token punctuation">.</span><span class="token function">Router</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment">// Register a new user</span>
router<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/users'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">201</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span>data<span class="token operator">:</span> <span class="token string">'new user created.'</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> router
</code></pre></div><p>Tell Express to use that router in <code>app.js</code>.</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> authRouter <span class="token keyword">from</span> <span class="token string">'./routes/auth/index.js'</span>
<span class="token comment">// ...</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token string">'/auth'</span><span class="token punctuation">,</span> authRouter<span class="token punctuation">)</span>
</code></pre></div><h4 id="test-it-with-postman"><a href="#test-it-with-postman" class="header-anchor">#</a> Test it with Postman</h4> <h3 id="register-a-new-user"><a href="#register-a-new-user" class="header-anchor">#</a> Register a new user</h3> <h4 id="mongoose-model"><a href="#mongoose-model" class="header-anchor">#</a> Mongoose Model</h4> <p>You will need a Mongoose Model so that your app can actually talk to the database. Let's keep it simple for now with just four properties: firstName, lastName, email, and password.</p> <p>Create a module called <code>User.js</code> in the <code>/models</code> folder.</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> mongoose <span class="token keyword">from</span> <span class="token string">'mongoose'</span>

<span class="token keyword">const</span> schema <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">mongoose<span class="token punctuation">.</span>Schema</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  firstName<span class="token operator">:</span> <span class="token punctuation">{</span>type<span class="token operator">:</span> String<span class="token punctuation">,</span> trim<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> maxlength<span class="token operator">:</span> <span class="token number">64</span><span class="token punctuation">,</span> required<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
  lastName<span class="token operator">:</span> <span class="token punctuation">{</span>type<span class="token operator">:</span> String<span class="token punctuation">,</span> trim<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> maxlength<span class="token operator">:</span> <span class="token number">64</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
  email<span class="token operator">:</span> <span class="token punctuation">{</span>type<span class="token operator">:</span> String<span class="token punctuation">,</span> trim<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> maxlength<span class="token operator">:</span> <span class="token number">512</span><span class="token punctuation">,</span> required<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
  password<span class="token operator">:</span> <span class="token punctuation">{</span>type<span class="token operator">:</span> String<span class="token punctuation">,</span> trim<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> maxlength<span class="token operator">:</span> <span class="token number">70</span><span class="token punctuation">,</span> required<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> Model <span class="token operator">=</span> mongoose<span class="token punctuation">.</span><span class="token function">model</span><span class="token punctuation">(</span><span class="token string">'User'</span><span class="token punctuation">,</span> schema<span class="token punctuation">)</span> <span class="token comment">// factory function returns a class</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> Model
</code></pre></div><h4 id="post-auth-users"><a href="#post-auth-users" class="header-anchor">#</a> POST /auth/users</h4> <p>In the <code>/routers/auth/index.js</code> module, we can now update the route handler for creating new users. To save time, let's borrow the POST method from the cars router as a starting point and then modify it for our <strong>User</strong> model.</p> <div class="language-js extra-class"><pre class="language-js"><code>router<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/users'</span><span class="token punctuation">,</span> sanitizeBody<span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> newUser <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>sanitizedBody<span class="token punctuation">)</span>
    <span class="token keyword">await</span> newUser<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">201</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token function">formatResponseData</span><span class="token punctuation">(</span>newUser<span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">debug</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
    res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      errors<span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span>
          status<span class="token operator">:</span> <span class="token string">'500'</span><span class="token punctuation">,</span>
          title<span class="token operator">:</span> <span class="token string">'Server error'</span><span class="token punctuation">,</span>
          description<span class="token operator">:</span> <span class="token string">'Problem saving document to the database.'</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">]</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>Also, copy in this updated <code>formatResponseData()</code> function.</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">formatResponseData</span><span class="token punctuation">(</span>payload<span class="token punctuation">,</span> type <span class="token operator">=</span> <span class="token string">'users'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>payload <span class="token keyword">instanceof</span> <span class="token class-name">Array</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span>data<span class="token operator">:</span> payload<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">resource</span> <span class="token operator">=&gt;</span> <span class="token function">format</span><span class="token punctuation">(</span>resource<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">}</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span>data<span class="token operator">:</span> <span class="token function">format</span><span class="token punctuation">(</span>payload<span class="token punctuation">)</span><span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">function</span> <span class="token function">format</span><span class="token punctuation">(</span><span class="token parameter">resource</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span>_id<span class="token punctuation">,</span> <span class="token operator">...</span>attributes<span class="token punctuation">}</span> <span class="token operator">=</span> resource<span class="token punctuation">.</span>toJSON <span class="token operator">?</span> resource<span class="token punctuation">.</span><span class="token function">toJSON</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> resource
    <span class="token keyword">return</span> <span class="token punctuation">{</span>type<span class="token punctuation">,</span> id<span class="token operator">:</span> _id<span class="token punctuation">,</span> attributes<span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p><strong>Don't forget to require the dependency modules (User.js, sanitizeBody.js, and debug) at at the top of the router module.</strong></p> <p>OK. Test it with Postman.</p> <p>POST body JSON example:</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;data&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;users&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;attributes&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;firstName&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Daisy&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;lastName&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Duck&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;email&quot;</span><span class="token operator">:</span> <span class="token string">&quot;daisy.duck@disney.com&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;password&quot;</span><span class="token operator">:</span> <span class="token string">&quot;1234&quot;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p><img src="/W2022/assets/img/screenshot-postman-create-user.72d82c64.png" alt="screenshot of Postman"></p> <p>That works, but ...</p> <p><img src="/W2022/assets/img/yuuuuge-problem.6d3c8309.jpg" alt="trump meme - yuuuuge problem" class="screenshot" style="margin:0 auto;width:100%;"></p> <p>The password is saved in plain text. <strong>That is an enormous security risk!</strong></p> <h3 id="encrypt-password"><a href="#encrypt-password" class="header-anchor">#</a> Encrypt password</h3> <p>Obviously passwords should <strong><em>never</em></strong> be stored in plain text. The current best practice for storing passwords is to use a strong cryptographic algorithm to generate a one-way hash. That means that <strong>once the password is encrypted, there is no practical way to decrypt it.</strong></p> <p>Wait a minute ... how do we process a login request?</p> <p>To validate a user supplied password, we encrypt it and then compare that against the encrypted password stored in the database. Given the same inputs, the encrypted hash values should also be the same.</p> <h4 id="bcrypt"><a href="#bcrypt" class="header-anchor">#</a> bcrypt</h4> <p><a href="https://www.npmjs.com/package/bcrypt" target="_blank" rel="noopener noreferrer">bcrypt<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> is the most widely used encryption library. It has been ported to most popular programming languages including, JavaScript, PHP, Python, C#, and Java.</p> <p>Let's add bcrypt as a project dependency.</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token function">npm</span> <span class="token function">install</span> bcrypt
</code></pre></div><p>At the top of the <code>routes/auth/index.js</code> module, import the bcrypt library. Then create a new variable called <code>saltRounds</code> and set it to 14.</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> bcrypt <span class="token keyword">from</span> <span class="token string">'bcrypt'</span>
<span class="token keyword">const</span> saltRounds <span class="token operator">=</span> <span class="token number">14</span>
</code></pre></div><div class="custom-block tip"><p class="custom-block-title">What is a salt?</p> <p>A salt is random data that is used in cryptography as additional input along with the user supplied data. This ensures that even if two users have the same plain text password, the hashed values stored in the database will look different.</p> <p>A new salt is randomly generated for each password. Salts defend against <a href="https://en.wikipedia.org/wiki/Dictionary_attack" target="_blank" rel="noopener noreferrer">dictionary attacks<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> or against their hashed equivalent, a pre-computed <a href="https://en.wikipedia.org/wiki/Rainbow_table" target="_blank" rel="noopener noreferrer">rainbow table attack<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>.</p></div> <h4 id="cryptographic-cost"><a href="#cryptographic-cost" class="header-anchor">#</a> Cryptographic Cost</h4> <p>When hashing the input data, bcrypt will go through a series of iterations or rounds to finally generate a secure hash. The <em>saltRounds</em> value is applied not as an integer, but as an exponent. Each hash generated will go through <code>2^saltRounds</code> iterations.</p> <p>Given a typical 2Ghz core processor, you could expect hashing throughput similar to this ...</p> <div class="language- extra-class"><pre class="language-text"><code>rounds=8 : ~40 hashes/sec
rounds=9 : ~20 hashes/sec
rounds=10: ~10 hashes/sec
rounds=11: ~5  hashes/sec
rounds=12: 2-3 hashes/sec
rounds=13: ~1 sec/hash
rounds=14: ~1.5 sec/hash
rounds=15: ~3 sec/hash
rounds=25: ~1 hour/hash
rounds=31: 2-3 days/hash
</code></pre></div><p>We want to make the hashing process as slow as is tolerable by legitimate users. The slower it is, the greater deterrent against brute-force hacking attempts. The default value is 10. It is recommended to use a higher value of between 13 and 15.</p> <p>Regardless of the number salt rounds, <strong>the resulting hashed value will always be 60 characters long</strong>.</p> <h4 id="hash"><a href="#hash" class="header-anchor">#</a> hash()</h4> <p>Now, in the 'create user' route handler, use the <code>hash</code> method to encrypt the password. Replace the user supplied password with an encrypted version before saving to the database.</p> <div class="language-js extra-class"><div class="highlight-lines"><br><br><div class="highlighted"> </div><br><br><br></div><pre class="language-js"><code><span class="token comment">// ...</span>
<span class="token keyword">const</span> newUser <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>sanitizedBody<span class="token punctuation">)</span>
newUser<span class="token punctuation">.</span>password <span class="token operator">=</span> <span class="token keyword">await</span> bcrypt<span class="token punctuation">.</span><span class="token function">hash</span><span class="token punctuation">(</span>newUser<span class="token punctuation">.</span>password<span class="token punctuation">,</span> saltRounds<span class="token punctuation">)</span>
<span class="token keyword">await</span> newUser<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment">// ...</span>
</code></pre></div><p>OK. Test it with Postman.</p> <p><img src="/W2022/assets/img/screenshot-postman-create-user-bcrypt.ab3bd09e.png" alt="screenshot of Postman"></p> <h3 id="unique-email"><a href="#unique-email" class="header-anchor">#</a> Unique email</h3> <p>We will use the user's email property as the login name. So, the email address needs to be unique in the <code>users</code> collection of our database, and we need an index on that property to speed up the queries.</p> <p>In the User model, modify the schema to add <code>unique: true</code> to the email property. This will tell MongoDB to create a <strong>'unique index'</strong> on the email property.</p> <div class="custom-block warning"><p class="custom-block-title">WARNING</p> <p><a href="https://mongoosejs.com/docs/validation.html#the-unique-option-is-not-a-validator" target="_blank" rel="noopener noreferrer">The <code>unique</code> Option is Not a Validator<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>. It is a helper method for creating an index with a unique value constraint.</p></div> <p>If you attempt to save a new User with the same email address as another User, MongoDB will throw an error ...</p> <div class="language-sh extra-class"><pre class="language-sh"><code>week8:auth Error saving new user:
E11000 duplicate key error collection:
mad9124.users index: email_1 dup key: <span class="token punctuation">{</span> <span class="token builtin class-name">:</span> <span class="token string">&quot;mckennr@algonquincollege.com&quot;</span> <span class="token punctuation">}</span>
</code></pre></div><div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>You may need to stop your Express server and drop the <code>mad9124</code> database, for the new schema (with the unique index) to be correctly compiled.</p></div> <p>It is necessary to query the database in order to validate that the new email address is not already registered <em>before</em> saving the new User. To make this query as fast as possible, we don't need to read the actual collection data, we can just see if it is already in the index.</p> <p>The <code>countDocuments()</code> method on the User model takes a MongoDB query expression and returns the number of matching occurrences in the collection. The JavaScript <code>Boolean()</code> function converts the result into a Boolean value (true or false) – if the email is not in the index, the return value will be 0 which is a falsy value.</p> <p>Strictly speaking, this is not required. The <code>if</code> condition would correctly process the numeric return values, but it more clearly communicates the intent to the reader.</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">//...</span>
<span class="token keyword">const</span> newUser <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>sanitizedBody<span class="token punctuation">)</span>
<span class="token keyword">const</span> itExists <span class="token operator">=</span> <span class="token function">Boolean</span><span class="token punctuation">(</span><span class="token keyword">await</span> User<span class="token punctuation">.</span><span class="token function">countDocuments</span><span class="token punctuation">(</span><span class="token punctuation">{</span>email<span class="token operator">:</span> newUser<span class="token punctuation">.</span>email<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>itExists<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// return error</span>
<span class="token punctuation">}</span>
newUser<span class="token punctuation">.</span>password <span class="token operator">=</span> <span class="token keyword">await</span> bcrypt<span class="token punctuation">.</span><span class="token function">hash</span><span class="token punctuation">(</span>newUser<span class="token punctuation">.</span>password<span class="token punctuation">,</span> saltRounds<span class="token punctuation">)</span>
<span class="token comment">//...</span>
</code></pre></div><p>That is the core logic for the unique check. Now, let's expand the handling of the validation error.</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">if</span> <span class="token punctuation">(</span>itExists<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">400</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    errors<span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token punctuation">{</span>
        status<span class="token operator">:</span> <span class="token string">'400'</span><span class="token punctuation">,</span>
        title<span class="token operator">:</span> <span class="token string">'Validation Error'</span><span class="token punctuation">,</span>
        detail<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Email address '</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>newUser<span class="token punctuation">.</span>email<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">' is already registered.</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
        source<span class="token operator">:</span> <span class="token punctuation">{</span>pointer<span class="token operator">:</span> <span class="token string">'/data/attributes/email'</span><span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">]</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="custom-block warning"><p class="custom-block-title">WARNING</p> <p>Calling the <code>res.json()</code> or <code>res.send()</code> method does not halt execution. So we need the <code>return</code> keyword to exit the route handler function.</p></div> <h3 id="login-a-user"><a href="#login-a-user" class="header-anchor">#</a> Login a user</h3> <p>OK. You can now successfully register new users. It is time to think about how to handle authenticating them. What should the RESTful URI be? You might think to try <code>POST /auth/user/:id/login</code>, but that breaks some of the &quot;rules&quot; by overloading the primary resource path and adding an action verb.</p> <p>It might help if I told you that we would send the client back a &quot;id token&quot; upon successful authentication. The client will then send that back as a header variable with each subsequent API call. So, in RESTful terms, what we really want to do is create a new authentication token. This makes more sematic sense.</p> <h4 id="post-auth-tokens"><a href="#post-auth-tokens" class="header-anchor">#</a> POST /auth/tokens</h4> <p>This resource path will support only the POST action and will expect the payload to contain the username/loginName and password. Near the bottom of the Auth Router module, let's pseudo code this new route handler.</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// Login a user and return an authentication token.</span>
router<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/tokens'</span><span class="token punctuation">,</span> sanitizeBody<span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// check if the payload.username is valid</span>
  <span class="token comment">// retrieve the stored password hash</span>
  <span class="token comment">// compare the payload.password with the hashed password</span>
  <span class="token comment">// if all is good, return a token</span>
  <span class="token comment">// if any condition failed, return an error message</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>OK. How do we do that? Let's take them one at a time. Use the mongoose <code>findOne()</code> method on the User model to search for a matching <code>email</code>. If we find it, then we also have the hashed password. If not, send an error response with a 401 status code.</p> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>The Mongoose <code>findOne()</code> method returns <code>null</code> if there is no matching record in the database.</p></div> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// Login a user and return an authentication token.</span>
router<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/tokens'</span><span class="token punctuation">,</span> sanitizeBody<span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span>email<span class="token punctuation">,</span> password<span class="token punctuation">}</span> <span class="token operator">=</span> req<span class="token punctuation">.</span>sanitizedBody
  <span class="token keyword">const</span> user <span class="token operator">=</span> <span class="token keyword">await</span> User<span class="token punctuation">.</span><span class="token function">findOne</span><span class="token punctuation">(</span><span class="token punctuation">{</span>email<span class="token operator">:</span> email<span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>user<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">401</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span>errors<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'we will build this later'</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// compare the payload.password with the hashed password</span>
  <span class="token comment">// if all is good, return a token</span>
  <span class="token comment">// if any condition failed, return an error message</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>Next, use the <code>bcrypt.compare()</code> method to validate the client supplied password.</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// Login a user and return an authentication token.</span>
router<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/tokens'</span><span class="token punctuation">,</span> sanitizeBody<span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span>email<span class="token punctuation">,</span> password<span class="token punctuation">}</span> <span class="token operator">=</span> req<span class="token punctuation">.</span>sanitizedBody
  <span class="token keyword">const</span> user <span class="token operator">=</span> <span class="token keyword">await</span> User<span class="token punctuation">.</span><span class="token function">findOne</span><span class="token punctuation">(</span><span class="token punctuation">{</span>email<span class="token operator">:</span> email<span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>user<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">401</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span>errors<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'we will build this later'</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">const</span> hashedPassword <span class="token operator">=</span> user<span class="token punctuation">.</span>password
  <span class="token keyword">const</span> passwordDidMatch <span class="token operator">=</span> <span class="token keyword">await</span> bcrypt<span class="token punctuation">.</span><span class="token function">compare</span><span class="token punctuation">(</span>password<span class="token punctuation">,</span> hashedPassword<span class="token punctuation">)</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>passwordDidMatch<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">401</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span>errors<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'we will build this later'</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// if all is good, return a token</span>
  <span class="token comment">// if any condition failed, return an error message</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>If we got this far, everything is good and we can return a token. Add these two lines as a placeholder for the moment. We will look at how to generate an industry standard token in just a minute.</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> accessToken <span class="token operator">=</span> <span class="token string">'iamatoken'</span>
res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">201</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token function">formatResponseData</span><span class="token punctuation">(</span><span class="token punctuation">{</span>accessToken<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">'tokens'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><p>This should be enough to test our logic. Let's go to our old friend Postman.</p> <p>The JSON body for the POST /auth/tokens route should be something like this.</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;data&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;tokens&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;attributes&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;email&quot;</span><span class="token operator">:</span> <span class="token string">&quot;mini.mouse@disney.com&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;password&quot;</span><span class="token operator">:</span> <span class="token string">&quot;1234&quot;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p><img src="/W2022/assets/img/screenshot-postman-login-fake-token.79ea7ee5.png" alt="screenshot of successful login with Postman"></p> <p>It works! But, there is a marked difference in the response time when we give it an invalid email. Hackers can use this timing difference to their advantage. Let's refactor this to mask that difference.</p> <p>To make sure the timing is consistent, we need the <code>bcrypt.compare()</code> function to run every time. So, change it to compare to a new variable called <code>hashedPassword</code> rather than <code>user.password</code>. Then conditionally set <code>hashedPassword</code>.</p> <p>If there was no User with a matching email (username) then we can set a fake value for the <code>hashedPassword</code> that will never get a valid match.</p> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>The first three characters signify the bcrypt version. The next three signify the number of salt rounds. The next 22 characters are the salt and the remainder is the encrypted password.</p></div> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> user <span class="token operator">=</span> <span class="token keyword">await</span> User<span class="token punctuation">.</span><span class="token function">findOne</span><span class="token punctuation">(</span><span class="token punctuation">{</span>email<span class="token operator">:</span> email<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> badHash <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">$2b$</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>saltRounds<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">$invalidusernameaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa</span><span class="token template-punctuation string">`</span></span>
<span class="token keyword">const</span> hashedPassword <span class="token operator">=</span> user <span class="token operator">?</span> user<span class="token punctuation">.</span>password <span class="token operator">:</span> badHash
<span class="token keyword">const</span> passwordDidMatch <span class="token operator">=</span> <span class="token keyword">await</span> bcrypt<span class="token punctuation">.</span><span class="token function">compare</span><span class="token punctuation">(</span>password<span class="token punctuation">,</span> hashedPassword<span class="token punctuation">)</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>user <span class="token operator">||</span> <span class="token operator">!</span>passwordDidMatch<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">401</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span>errors<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'we will build this later'</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> accessToken <span class="token operator">=</span> <span class="token string">'iamatoken'</span>
res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">201</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token function">formatResponseData</span><span class="token punctuation">(</span><span class="token punctuation">{</span>accessToken<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">'tokens'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><p>Test it again. Great!</p> <h3 id="create-a-jwt"><a href="#create-a-jwt" class="header-anchor">#</a> Create a JWT</h3> <p>It is time to generate a real token. We will use the <em>de facto</em> industry standard <a href="https://jwt.io/introduction/" target="_blank" rel="noopener noreferrer">JSON Web Tokens (JWT)<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>. There are libraries for just about every popular programming language. Let's install the Node.js module.</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token function">npm</span> <span class="token function">install</span> jsonwebtoken
</code></pre></div><p>You should read the full documentation on JWTs but here are two critical things to understand.</p> <ol><li><p>The payload is hashed, <strong>not encrypted</strong>. Anyone with some JavaScript can read it. So, never put sensitive data in the token payload.</p></li> <li><p>The token is cryptographically signed using a secret key on your sever. So you can validate that no one has altered the contents of the payload. Which means you can trust it.</p></li></ol> <p><a href="https://www.npmjs.com/package/jsonwebtoken" target="_blank" rel="noopener noreferrer">Check the usage instructions<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> ...</p> <p>We need to require the library at the top of the Auth Router module.</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> jwt <span class="token keyword">from</span> <span class="token string">'jsonwebtoken'</span>
</code></pre></div><p>Then in the route handler update the token assignment line. For the payload, you will provide a user object with just the authenticated User's unique <code>_id</code> property.</p> <p>To simplify the in-class exercise, we will hard code the secret key for now <strong>– never do this in production!</strong></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> payload <span class="token operator">=</span> <span class="token punctuation">{</span>user<span class="token operator">:</span> <span class="token punctuation">{</span>_id<span class="token operator">:</span> user<span class="token punctuation">.</span>_id<span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token keyword">const</span> accessToken <span class="token operator">=</span> jwt<span class="token punctuation">.</span><span class="token function">sign</span><span class="token punctuation">(</span>payload<span class="token punctuation">,</span> <span class="token string">'superSecureSecret'</span><span class="token punctuation">)</span>
</code></pre></div><p>Test it in Postman ...</p> <p><img src="/W2022/assets/img/screenshot-postman-login-jwt.547b06cf.png" alt="screenshot of Postman with a real JWT response"></p> <p>If you copy the token returned in Postman and paste it into the JWT Debugger at <a href="https://jwt.io" target="_blank" rel="noopener noreferrer">jwt.io<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> you can verify the contents of the payload.</p> <p><img src="/W2022/assets/img/screenshot-jwt-debugger.73a82be8.png" alt="screenshot of the jwt.io website"></p> <p>Yay! This works.</p> <p>However, we are starting to get more and more logic about the User model leaking into the router module. In a small application, this is not really a big deal. But as an application grows in complexity this can lead to unwanted tight coupling between modules - making it harder to know where to look for implementation code, and harder to swap out the implementation to a third party web service or your own independent micro service.</p> <p>The solution is to follow the <a href="https://en.wikipedia.org/wiki/GRASP_(object-oriented_design)" target="_blank" rel="noopener noreferrer">OOP Information expert principle<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> and move some of this logic to <em>custom methods</em> defined in the User model class.</p> <h3 id="custom-instance-methods"><a href="#custom-instance-methods" class="header-anchor">#</a> Custom instance methods</h3> <p>The <code>mongoose.Schema</code> class defines a <code>methods</code> object to which you can attach your own custom instance methods. These methods will be available to all Mongoose document objects created from this schema.</p> <p>In this case, go to the <code>/models/User.js</code> file and before calling the <code>mongoose.model()</code> function, add a new property to the <code>schema.methods</code> called <code>generateAuthToken</code> and set it to hold a regular function. Then paste in the <code>jwt.sign()</code> method from the router module.</p> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>Since we are creating an &quot;instance method&quot;, we need to update the payload. There is no <code>user</code> variable. Instead you can use the special <code>this</code> keyword to refer to the instantiated object (Mongoose Document).</p></div> <div class="language-js extra-class"><div class="highlight-lines"><div class="highlighted"> </div><br><br><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><br><br><br><br><br></div><pre class="language-js"><code><span class="token keyword">import</span> jwt <span class="token keyword">from</span> <span class="token string">'jsonwebtoken'</span>
<span class="token keyword">const</span> mongoose <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'mongoose'</span><span class="token punctuation">)</span>
<span class="token comment">// ...</span>
schema<span class="token punctuation">.</span>methods<span class="token punctuation">.</span><span class="token function-variable function">generateAuthToken</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> payload <span class="token operator">=</span> <span class="token punctuation">{</span>user<span class="token operator">:</span> <span class="token punctuation">{</span>_id<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_id<span class="token punctuation">}</span><span class="token punctuation">}</span>
  <span class="token keyword">return</span> jwt<span class="token punctuation">.</span><span class="token function">sign</span><span class="token punctuation">(</span>payload<span class="token punctuation">,</span> <span class="token string">'superSecureSecret'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> Model <span class="token operator">=</span> mongoose<span class="token punctuation">.</span><span class="token function">model</span><span class="token punctuation">(</span><span class="token string">'User'</span><span class="token punctuation">,</span> schema<span class="token punctuation">)</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> Model
</code></pre></div><div class="custom-block danger"><p class="custom-block-title">WARNING</p> <p>Do not use an arrow function here. We need <code>this</code> inside the function to reference the instantiated model object.</p></div> <p>Now update the route handler to call this new method ...</p> <div class="language-js extra-class"><div class="highlight-lines"><br><br><br><br><br><br><br><br><br><br><br><br><br><br><div class="highlighted"> </div><br><br></div><pre class="language-js"><code>router<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/tokens'</span><span class="token punctuation">,</span> sanitizeBody<span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span>email<span class="token punctuation">,</span> password<span class="token punctuation">}</span> <span class="token operator">=</span> req<span class="token punctuation">.</span>sanitizedBody

  <span class="token keyword">const</span> user <span class="token operator">=</span> <span class="token keyword">await</span> User<span class="token punctuation">.</span><span class="token function">findOne</span><span class="token punctuation">(</span><span class="token punctuation">{</span>email<span class="token operator">:</span> email<span class="token punctuation">}</span><span class="token punctuation">)</span>

  <span class="token keyword">const</span> badHash <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">$2b$</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>saltRounds<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">$invalidusernameaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa</span><span class="token template-punctuation string">`</span></span>
  <span class="token keyword">const</span> hashedPassword <span class="token operator">=</span> user <span class="token operator">?</span> user<span class="token punctuation">.</span>password <span class="token operator">:</span> badHash
  <span class="token keyword">const</span> passwordDidMatch <span class="token operator">=</span> <span class="token keyword">await</span> bcrypt<span class="token punctuation">.</span><span class="token function">compare</span><span class="token punctuation">(</span>password<span class="token punctuation">,</span> hashedPassword<span class="token punctuation">)</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>user <span class="token operator">||</span> <span class="token operator">!</span>passwordDidMatch<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">401</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span>errors<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'we will build this later'</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  res
    <span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">201</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token function">formatResponseData</span><span class="token punctuation">(</span><span class="token punctuation">{</span>accessToken<span class="token operator">:</span> user<span class="token punctuation">.</span><span class="token function">generateAuthToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">'tokens'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="custom-class-methods"><a href="#custom-class-methods" class="header-anchor">#</a> Custom class methods</h3> <p>Similarly, the route handler should not need to know about the password encryption implementation. We can relocate the authentication logic to a static class method and call it like <code>User.authenticate(email, password)</code> and expect either a User instance or null in return.</p> <p>This time add a new <code>authenticate</code> property to the <code>schema.statics</code> object in the <code>/models/User.js</code> module. Copy over the logic from the router module and remember to change <code>User</code> to <code>this</code>.</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> bcrypt <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'bcrypt'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> saltRounds <span class="token operator">=</span> <span class="token number">14</span>
<span class="token comment">// ...</span>
schema<span class="token punctuation">.</span>statics<span class="token punctuation">.</span><span class="token function-variable function">authenticate</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">email<span class="token punctuation">,</span> password</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> user <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">findOne</span><span class="token punctuation">(</span><span class="token punctuation">{</span>email<span class="token operator">:</span> email<span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> badHash <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">$2b$</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>saltRounds<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">$invalidusernameaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa</span><span class="token template-punctuation string">`</span></span>
  <span class="token keyword">const</span> hashedPassword <span class="token operator">=</span> user <span class="token operator">?</span> user<span class="token punctuation">.</span>password <span class="token operator">:</span> badHash
  <span class="token keyword">const</span> passwordDidMatch <span class="token operator">=</span> <span class="token keyword">await</span> bcrypt<span class="token punctuation">.</span><span class="token function">compare</span><span class="token punctuation">(</span>password<span class="token punctuation">,</span> hashedPassword<span class="token punctuation">)</span>

  <span class="token keyword">return</span> passwordDidMatch <span class="token operator">?</span> user <span class="token operator">:</span> <span class="token keyword">null</span>
  <span class="token comment">// remember if the email did not match, user === null</span>
<span class="token punctuation">}</span>
</code></pre></div><p>And update the auth router module ...</p> <div class="language-js extra-class"><pre class="language-js"><code>router<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/tokens'</span><span class="token punctuation">,</span> sanitizeBody<span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> email<span class="token punctuation">,</span> password <span class="token punctuation">}</span> <span class="token operator">=</span> req<span class="token punctuation">.</span>sanitizedBody
  <span class="token keyword">const</span> user <span class="token operator">=</span> <span class="token keyword">await</span> User<span class="token punctuation">.</span><span class="token function">authenticate</span><span class="token punctuation">(</span>email<span class="token punctuation">,</span> password<span class="token punctuation">)</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>user<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">401</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span> errors<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'we will build this later'</span><span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  res
    <span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">201</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token function">formatResponseData</span><span class="token punctuation">(</span><span class="token punctuation">{</span>accessToken<span class="token operator">:</span> user<span class="token punctuation">.</span><span class="token function">generateAuthToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">'tokens'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Test it with Postman to make sure that everything still works ... yay!</p> <p>One last change to the <strong>POST /auth/tokens</strong> route handler ... let's put in a proper error message.</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>user<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">401</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    errors<span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token punctuation">{</span>
        status<span class="token operator">:</span> <span class="token string">'401'</span><span class="token punctuation">,</span>
        title<span class="token operator">:</span> <span class="token string">'Incorrect username or password.'</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">]</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="schema-lifecycle-hooks"><a href="#schema-lifecycle-hooks" class="header-anchor">#</a> Schema lifecycle hooks</h3> <p>There is one more implementation detail that is in the router module that should be moved to the User model. Currently the registration route is taking care of encrypting the password before saving the new User. It shouldn't need to know about this.</p> <p><strong>Mongoose Schema to the rescue again!</strong></p> <p>Mongoose provides some <a href="https://mongoosejs.com/docs/middleware.html" target="_blank" rel="noopener noreferrer">special middleware functions<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> that are triggered by lifecycle events. We will use one that is triggered just before a model is saved to do the password encryption.</p> <p>Add this code block to the <code>/models/User.js</code> module just below the custom methods that you added earlier.</p> <div class="language-js extra-class"><pre class="language-js"><code>schema<span class="token punctuation">.</span><span class="token function">pre</span><span class="token punctuation">(</span><span class="token string">'save'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">next</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// Only encrypt if the password property is being changed.</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">isModified</span><span class="token punctuation">(</span><span class="token string">'password'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

  <span class="token keyword">this</span><span class="token punctuation">.</span>password <span class="token operator">=</span> <span class="token keyword">await</span> bcrypt<span class="token punctuation">.</span><span class="token function">hash</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>password<span class="token punctuation">,</span> saltRounds<span class="token punctuation">)</span>
  <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>We can now delete these lines from the router module ...</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> bcrypt <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'bcrypt'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> saltRounds <span class="token operator">=</span> <span class="token number">14</span>
<span class="token comment">//...</span>
newUser<span class="token punctuation">.</span>password <span class="token operator">=</span> <span class="token keyword">await</span> bcrypt<span class="token punctuation">.</span><span class="token function">hash</span><span class="token punctuation">(</span>newUser<span class="token punctuation">.</span>password<span class="token punctuation">,</span> saltRounds<span class="token punctuation">)</span>
</code></pre></div><p>OK. This is a <em>much</em> cleaner implementation. The router does routing and the implementation details of how to manage password encryption and authenticate a user are in the User model.</p> <h4 id="how-does-our-code-look-now"><a href="#how-does-our-code-look-now" class="header-anchor">#</a> How does our code look now?</h4> <p>Auth Router</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> User <span class="token keyword">from</span> <span class="token string">'../../models/User.js'</span>
<span class="token keyword">import</span> sanitizeBody <span class="token keyword">from</span> <span class="token string">'../../middleware/sanitizeBody.js'</span>
<span class="token keyword">import</span> createDebug <span class="token keyword">from</span> <span class="token string">'debug'</span>
<span class="token keyword">import</span> express <span class="token keyword">from</span> <span class="token string">'express'</span>

<span class="token keyword">const</span> debug <span class="token operator">=</span> <span class="token function">createDebug</span><span class="token punctuation">(</span><span class="token string">'week9:routes:auth'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> router <span class="token operator">=</span> express<span class="token punctuation">.</span><span class="token function">Router</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment">// Register a new user</span>
router<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/users'</span><span class="token punctuation">,</span> sanitizeBody<span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> newUser <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>sanitizedBody<span class="token punctuation">)</span>

    <span class="token keyword">const</span> itExists <span class="token operator">=</span> <span class="token function">Boolean</span><span class="token punctuation">(</span><span class="token keyword">await</span> User<span class="token punctuation">.</span><span class="token function">countDocuments</span><span class="token punctuation">(</span><span class="token punctuation">{</span>email<span class="token operator">:</span> newUser<span class="token punctuation">.</span>email<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>itExists<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">400</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        errors<span class="token operator">:</span> <span class="token punctuation">[</span>
          <span class="token punctuation">{</span>
            status<span class="token operator">:</span> <span class="token string">'400'</span><span class="token punctuation">,</span>
            title<span class="token operator">:</span> <span class="token string">'Validation Error'</span><span class="token punctuation">,</span>
            detail<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Email address '</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>newUser<span class="token punctuation">.</span>email<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">' is already registered.</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
            source<span class="token operator">:</span> <span class="token punctuation">{</span>pointer<span class="token operator">:</span> <span class="token string">'/data/attributes/email'</span><span class="token punctuation">}</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">]</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">await</span> newUser<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">201</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token function">formatResponseData</span><span class="token punctuation">(</span>newUser<span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">'Error saving new user: '</span><span class="token punctuation">,</span> err<span class="token punctuation">.</span>message<span class="token punctuation">)</span>
    res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      errors<span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span>
          status<span class="token operator">:</span> <span class="token string">'500'</span><span class="token punctuation">,</span>
          title<span class="token operator">:</span> <span class="token string">'Server error'</span><span class="token punctuation">,</span>
          description<span class="token operator">:</span> <span class="token string">'Problem saving document to the database.'</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">]</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">// Login a user and return an authentication token.</span>
router<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/tokens'</span><span class="token punctuation">,</span> sanitizeBody<span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span>email<span class="token punctuation">,</span> password<span class="token punctuation">}</span> <span class="token operator">=</span> req<span class="token punctuation">.</span>sanitizedBody
  <span class="token keyword">const</span> user <span class="token operator">=</span> <span class="token keyword">await</span> User<span class="token punctuation">.</span><span class="token function">authenticate</span><span class="token punctuation">(</span>email<span class="token punctuation">,</span> password<span class="token punctuation">)</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>user<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">401</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      errors<span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span>
          status<span class="token operator">:</span> <span class="token string">'401'</span><span class="token punctuation">,</span>
          title<span class="token operator">:</span> <span class="token string">'Incorrect username or password.'</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">]</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  res
    <span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">201</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token function">formatResponseData</span><span class="token punctuation">(</span><span class="token punctuation">{</span>accessToken<span class="token operator">:</span> user<span class="token punctuation">.</span><span class="token function">generateAuthToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">'tokens'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">/**
 * Format the response data object according to JSON:API v1.0
 * @param {string} type The resource collection name, e.g. 'cars'
 * @param {Object | Object[]} payload An array or instance object from that collection
 * @returns
 */</span>
<span class="token keyword">function</span> <span class="token function">formatResponseData</span><span class="token punctuation">(</span>payload<span class="token punctuation">,</span> type <span class="token operator">=</span> <span class="token string">'users'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>payload <span class="token keyword">instanceof</span> <span class="token class-name">Array</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span>data<span class="token operator">:</span> payload<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">resource</span> <span class="token operator">=&gt;</span> <span class="token function">format</span><span class="token punctuation">(</span>resource<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">}</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span>data<span class="token operator">:</span> <span class="token function">format</span><span class="token punctuation">(</span>payload<span class="token punctuation">)</span><span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">function</span> <span class="token function">format</span><span class="token punctuation">(</span><span class="token parameter">resource</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span>_id<span class="token punctuation">,</span> <span class="token operator">...</span>attributes<span class="token punctuation">}</span> <span class="token operator">=</span> resource<span class="token punctuation">.</span>toJSON <span class="token operator">?</span> resource<span class="token punctuation">.</span><span class="token function">toJSON</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> resource
    <span class="token keyword">return</span> <span class="token punctuation">{</span>type<span class="token punctuation">,</span> id<span class="token operator">:</span> _id<span class="token punctuation">,</span> attributes<span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> router
</code></pre></div><p>User Model</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> jwt <span class="token keyword">from</span> <span class="token string">'jsonwebtoken'</span>
<span class="token keyword">import</span> bcrypt <span class="token keyword">from</span> <span class="token string">'bcrypt'</span>
<span class="token keyword">import</span> mongoose <span class="token keyword">from</span> <span class="token string">'mongoose'</span>

<span class="token keyword">const</span> saltRounds <span class="token operator">=</span> <span class="token number">14</span>
<span class="token keyword">const</span> jwtSecretKey <span class="token operator">=</span> <span class="token string">'superSecureSecret'</span>

<span class="token keyword">const</span> schema <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">mongoose<span class="token punctuation">.</span>Schema</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  firstName<span class="token operator">:</span> <span class="token punctuation">{</span>type<span class="token operator">:</span> String<span class="token punctuation">,</span> trim<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> maxlength<span class="token operator">:</span> <span class="token number">64</span><span class="token punctuation">,</span> required<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
  lastName<span class="token operator">:</span> <span class="token punctuation">{</span>type<span class="token operator">:</span> String<span class="token punctuation">,</span> trim<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> maxlength<span class="token operator">:</span> <span class="token number">64</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
  email<span class="token operator">:</span> <span class="token punctuation">{</span>
    type<span class="token operator">:</span> String<span class="token punctuation">,</span>
    trim<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    maxlength<span class="token operator">:</span> <span class="token number">512</span><span class="token punctuation">,</span>
    required<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    unique<span class="token operator">:</span> <span class="token boolean">true</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  password<span class="token operator">:</span> <span class="token punctuation">{</span>type<span class="token operator">:</span> String<span class="token punctuation">,</span> trim<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> maxlength<span class="token operator">:</span> <span class="token number">70</span><span class="token punctuation">,</span> required<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

schema<span class="token punctuation">.</span>methods<span class="token punctuation">.</span><span class="token function-variable function">generateAuthToken</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> payload <span class="token operator">=</span> <span class="token punctuation">{</span>uid<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_id<span class="token punctuation">}</span>
  <span class="token keyword">return</span> jwt<span class="token punctuation">.</span><span class="token function">sign</span><span class="token punctuation">(</span>payload<span class="token punctuation">,</span> jwtSecretKey<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

schema<span class="token punctuation">.</span>statics<span class="token punctuation">.</span><span class="token function-variable function">authenticate</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">email<span class="token punctuation">,</span> password</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> user <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">findOne</span><span class="token punctuation">(</span><span class="token punctuation">{</span>email<span class="token operator">:</span> email<span class="token punctuation">}</span><span class="token punctuation">)</span>

  <span class="token keyword">const</span> badHash <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">$2b$</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>saltRounds<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">$invalidusernameaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa</span><span class="token template-punctuation string">`</span></span>
  <span class="token comment">// remember if the email did not match, user === null</span>
  <span class="token keyword">const</span> hashedPassword <span class="token operator">=</span> user <span class="token operator">?</span> user<span class="token punctuation">.</span>password <span class="token operator">:</span> badHash
  <span class="token keyword">const</span> passwordDidMatch <span class="token operator">=</span> <span class="token keyword">await</span> bcrypt<span class="token punctuation">.</span><span class="token function">compare</span><span class="token punctuation">(</span>password<span class="token punctuation">,</span> hashedPassword<span class="token punctuation">)</span>

  <span class="token keyword">return</span> passwordDidMatch <span class="token operator">?</span> user <span class="token operator">:</span> <span class="token keyword">null</span>
<span class="token punctuation">}</span>

schema<span class="token punctuation">.</span><span class="token function">pre</span><span class="token punctuation">(</span><span class="token string">'save'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">next</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// Only encrypt if the password property is being changed.</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">isModified</span><span class="token punctuation">(</span><span class="token string">'password'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

  <span class="token keyword">this</span><span class="token punctuation">.</span>password <span class="token operator">=</span> <span class="token keyword">await</span> bcrypt<span class="token punctuation">.</span><span class="token function">hash</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>password<span class="token punctuation">,</span> saltRounds<span class="token punctuation">)</span>
  <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> Model <span class="token operator">=</span> mongoose<span class="token punctuation">.</span><span class="token function">model</span><span class="token punctuation">(</span><span class="token string">'User'</span><span class="token punctuation">,</span> schema<span class="token punctuation">)</span> <span class="token comment">// factory function returns a class</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> Model
</code></pre></div><h3 id="protected-routes"><a href="#protected-routes" class="header-anchor">#</a> Protected routes</h3> <p>The whole point of authenticating users, is to restrict access to certain resources. This can be as simple as &quot;are you logged in?&quot; or a more complex <a href="https://searchsecurity.techtarget.com/definition/role-based-access-control-RBAC" target="_blank" rel="noopener noreferrer">Role Based Access Control (RBAC)<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> system that applies a more fine-grained user authorization check.</p> <p>Let's start with the simple case. Create a new resource route to retrieve the currently logged-in user model. We could create a route formatted as <code>GET /auth/users/:id</code>, but it is a very common practice to have a dedicated route for the active user. It is usually formatted similar to this, <code>GET /auth/users/me</code>. Sketch out the logic ... add this to the Auth router module.</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// Get the currently logged-in user</span>
router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/users/me'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// Get the JWT from the request header</span>
  <span class="token comment">// Validate the JWT</span>
  <span class="token comment">// Load the User document from the database using the `_id` in the JWT</span>
  <span class="token comment">// Remember to redact sensitive data like the user's password</span>
  <span class="token comment">// Send the data back to the client.</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>Access to the currently logged-in user is something that we will want to do in many route handlers, so let's build that logic in a reusable middleware function. It will tackle the first two steps above and make the token's payload available on the request object as <code>req.user</code>.</p> <p>Create a new module called <code>auth.js</code> in the <code>middleware</code> folder of your project. Require the <code>jsonwebtoken</code> module and set the <code>jwtPrivateKey</code> to the same value that we used in the User model module (we are still hard coding this for now, but we'll look at a better way to handle this in a latter class). Then add the basic middleware function signature.</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> jwt <span class="token keyword">from</span> <span class="token string">'jsonwebtoken'</span>

<span class="token keyword">const</span> jwtPrivateKey <span class="token operator">=</span> <span class="token string">'superSecureSecret'</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// Get the JWT from the request header</span>
  <span class="token comment">// Validate the JWT</span>
<span class="token punctuation">}</span>
</code></pre></div><div><p>The client application will pass the token in a request header called <code>Authorization</code>. The corresponding value will be in the form of <code>Bearer {{token}}</code>, where <code>{{token}}</code> is a placeholder for the actual JWT. Note the word Bearer is capitalized and followed by a space.</p></div><p>We can use the <code>req.header('Authorization')</code> function to get the token
from the request headers and if the token is missing, send an authentication error.</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> token <span class="token operator">=</span> req<span class="token punctuation">.</span><span class="token function">header</span><span class="token punctuation">(</span><span class="token string">'Authorization'</span><span class="token punctuation">)</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>token<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">401</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    errors<span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token punctuation">{</span>
        status<span class="token operator">:</span> <span class="token string">'401'</span><span class="token punctuation">,</span>
        title<span class="token operator">:</span> <span class="token string">'Authentication failed'</span><span class="token punctuation">,</span>
        description<span class="token operator">:</span> <span class="token string">'Missing bearer token'</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">]</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>However, the value of the token is a string with two parts. The first part is the token type <code>Bearer</code> and the second part – after the space – is the access token. We can use JavaScript's <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String/split" target="_blank" rel="noopener noreferrer">String.prototype.split()<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> to isolate these two values as elements of an array. Then we can apply <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Operators/Destructuring_assignment" target="_blank" rel="noopener noreferrer">destructuring assignment<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> to to extract the first two elements of the array into local variables, <code>type</code> and <code>token</code>.</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token punctuation">[</span>type<span class="token punctuation">,</span> token<span class="token punctuation">]</span> <span class="token operator">=</span> headerValue<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">' '</span><span class="token punctuation">)</span>
</code></pre></div><p>To keep things clean and organized, let's move the logic to parse the Authorization header into a separate helper function.</p> <div class="language-js extra-class"><div class="highlight-lines"><br><br><br><br><br><br><br><br><br><br><br><div class="highlighted"> </div><br><br><br></div><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">parseToken</span> <span class="token punctuation">(</span><span class="token parameter">headerValue</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>headerValue<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">[</span>type<span class="token punctuation">,</span> token<span class="token punctuation">]</span> <span class="token operator">=</span> headerValue<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">' '</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>type <span class="token operator">===</span> <span class="token string">'Bearer'</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">typeof</span> token <span class="token operator">!==</span> <span class="token string">'undefined'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> token
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token keyword">undefined</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> token <span class="token operator">=</span> <span class="token function">parseToken</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span><span class="token function">header</span><span class="token punctuation">(</span><span class="token string">'Authorization'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>token<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// ... rest of the module</span>
</code></pre></div><p>If we have a token, we can proceed to validate it with the <code>jwt.verify()</code> method. It takes two arguments: the token, and the secret key. If the token is verified as not having been tampered with, then the payload is decoded and returned. We can then set the decoded payload as the <code>user</code> key on the request object and call <code>next()</code>.</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> payload <span class="token operator">=</span> jwt<span class="token punctuation">.</span><span class="token function">verify</span><span class="token punctuation">(</span>token<span class="token punctuation">,</span> jwtPrivateKey<span class="token punctuation">)</span>
req<span class="token punctuation">.</span>user <span class="token operator">=</span> payload<span class="token punctuation">.</span>user
<span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><p>But we need to send a validation error if the token is not good. So, let's wrap that in a try catch block.</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">try</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> payload <span class="token operator">=</span> jwt<span class="token punctuation">.</span><span class="token function">verify</span><span class="token punctuation">(</span>token<span class="token punctuation">,</span> jwtPrivateKey<span class="token punctuation">)</span>
  req<span class="token punctuation">.</span>user <span class="token operator">=</span> payload<span class="token punctuation">.</span>user
  <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">400</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    errors<span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token punctuation">{</span>
        status<span class="token operator">:</span> <span class="token string">'400'</span><span class="token punctuation">,</span>
        title<span class="token operator">:</span> <span class="token string">'Validation Error'</span><span class="token punctuation">,</span>
        description<span class="token operator">:</span> <span class="token string">'Invalid bearer token'</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">]</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>The final auth middleware module should look like this.</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> jwt <span class="token keyword">from</span> <span class="token string">'jsonwebtoken'</span>

<span class="token keyword">const</span> jwtPrivateKey <span class="token operator">=</span> <span class="token string">'superSecureSecret'</span>

<span class="token keyword">const</span> <span class="token function-variable function">parseToken</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">headerValue</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>headerValue<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">[</span>type<span class="token punctuation">,</span> token<span class="token punctuation">]</span> <span class="token operator">=</span> headerValue<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">' '</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>type <span class="token operator">===</span> <span class="token string">'Bearer'</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">typeof</span> token <span class="token operator">!==</span> <span class="token string">'undefined'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> token
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token keyword">undefined</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> token <span class="token operator">=</span> <span class="token function">parseToken</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span><span class="token function">header</span><span class="token punctuation">(</span><span class="token string">'Authorization'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>token<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">401</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      errors<span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span>
          status<span class="token operator">:</span> <span class="token string">'401'</span><span class="token punctuation">,</span>
          title<span class="token operator">:</span> <span class="token string">'Authentication failed'</span><span class="token punctuation">,</span>
          description<span class="token operator">:</span> <span class="token string">'Missing bearer token'</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">]</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> payload <span class="token operator">=</span> jwt<span class="token punctuation">.</span><span class="token function">verify</span><span class="token punctuation">(</span>token<span class="token punctuation">,</span> jwtPrivateKey<span class="token punctuation">)</span>
    req<span class="token punctuation">.</span>user <span class="token operator">=</span> payload<span class="token punctuation">.</span>user
    <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">400</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      errors<span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span>
          status<span class="token operator">:</span> <span class="token string">'400'</span><span class="token punctuation">,</span>
          title<span class="token operator">:</span> <span class="token string">'Validation Error'</span><span class="token punctuation">,</span>
          description<span class="token operator">:</span> <span class="token string">'Invalid bearer token'</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">]</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Now we can go back to the Auth Router module and use this new middleware. Require it at the top.</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> authenticate <span class="token keyword">from</span> <span class="token string">'../../middleware/auth.js'</span>
</code></pre></div><p>In the <code>GET /auth/users/me</code> route handler, leverage the <code>authenticate</code> middleware. If the application flow made it this far, we know that the token was valid and the currently logged-in user's <code>_id</code> is available on the request object.</p> <div class="custom-block tip"><p class="custom-block-title">Remember</p> <p>When we encoded the token, we included only the user's unique id property.</p></div> <p>You can now load the user document from the database and return it to the client.</p> <div class="language-js extra-class"><pre class="language-js"><code>router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/users/me'</span><span class="token punctuation">,</span> authenticate<span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> user <span class="token operator">=</span> <span class="token keyword">await</span> User<span class="token punctuation">.</span><span class="token function">findById</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>user<span class="token punctuation">.</span>_id<span class="token punctuation">)</span>
  res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token function">formatResponseData</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h3 id="redact-sensitive-data"><a href="#redact-sensitive-data" class="header-anchor">#</a> Redact Sensitive Data</h3> <p>One more thing... we have to guard against revealing sensitive data like <code>user.password</code>. One solution is to chain the Mongoose <a href="https://mongoosejs.com/docs/api.html#query_Query-select" target="_blank" rel="noopener noreferrer">select()<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> method onto the <code>findById()</code> request and limit the fields that are returned.</p> <p>Prefixing field names with <code>-</code> (minus sign) explicitly tells Mongo to exclude these properties. The <code>select()</code> method accepts a space separated list of properties.</p> <div class="language-js extra-class"><div class="highlight-lines"><br><div class="highlighted"> </div><br><br><br></div><pre class="language-js"><code>router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/users/me'</span><span class="token punctuation">,</span> authorize<span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> user <span class="token operator">=</span> <span class="token keyword">await</span> User<span class="token punctuation">.</span><span class="token function">findById</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>user<span class="token punctuation">.</span>_id<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span><span class="token string">'-password -__v'</span><span class="token punctuation">)</span>
  res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token function">formatResponseData</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>But a better solution is to make this the <em>default behaviour</em> in the User model schema. By overriding the <code>toJSON()</code> method in the model schema, we can be assured that we never forget to remove unwanted fields in a route handler.</p> <p>Add this code snippet to the <code>/models/User.js</code> module.</p> <div class="language-js extra-class"><pre class="language-js"><code>schema<span class="token punctuation">.</span>methods<span class="token punctuation">.</span><span class="token function-variable function">toJSON</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> obj <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">toObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword">delete</span> obj<span class="token punctuation">.</span>password
  <span class="token keyword">delete</span> obj<span class="token punctuation">.</span>__v
  <span class="token keyword">return</span> obj
<span class="token punctuation">}</span>
</code></pre></div><p>And then we don't need the <code>select()</code> method in the route handler.</p> <h4 id="ok-let-s-test-it-with-postman"><a href="#ok-let-s-test-it-with-postman" class="header-anchor">#</a> OK. Let's test it with Postman.</h4> <p>Set the <code>Authorization</code> header property to be the encoded token string that was returned from your earlier login test – prefixed by <code>Bearer</code>.</p> <p><img src="/W2022/assets/img/screenshot-postman-get-user.ae20a071.png" alt="screenshot of Postman setting bearer token"></p> <h3 id="submit-your-work"><a href="#submit-your-work" class="header-anchor">#</a> Submit your work</h3> <p>Use git to commit your changes and then push your commits up to the remote GitHub repo. Submit the GitHub repo's URL on Brightspace.</p> <h2 id="for-next-week"><a href="#for-next-week" class="header-anchor">#</a> For next week</h2> <p>Before next week's class, please read these additional online resources.</p> <ul><li><a href="https://auth0.com/blog/hashing-in-action-understanding-bcrypt/" target="_blank" rel="noopener noreferrer">Hashing in Action: Understanding bcrypt<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://jwt.io/introduction/" target="_blank" rel="noopener noreferrer">Introduction to JSON Web Tokens<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul> <div class="custom-block warning"><p class="custom-block-title">Quiz</p> <p>There will be a short quiz next class. The questions could come from any of the material referenced above.</p></div></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">3/13/2022, 6:12:57 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/W2022/modules/break-week/" class="prev">
        Break Week
      </a></span> <span class="next"><a href="/W2022/modules/week10/">
        Week 10: JWT Review
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/W2022/assets/js/app.cec51691.js" defer></script><script src="/W2022/assets/js/3.9c2ff4f7.js" defer></script><script src="/W2022/assets/js/10.31dfe672.js" defer></script><script src="/W2022/assets/js/11.f11acbbb.js" defer></script><script src="/W2022/assets/js/16.1ec56656.js" defer></script>
  </body>
</html>
